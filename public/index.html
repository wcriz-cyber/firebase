<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>C5X</title>
    <meta name="theme-color" content="#0b0e11">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@500;700&family=Inter:wght@500;700;800&family=JetBrains+Mono:wght@500;700;800&family=Orbitron:wght@400;500;600;700;800;900&family=Rajdhani:wght@500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://s3.tradingview.com/tv.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <!-- Firebase SDK (compat v9 — funciona sin bundler) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        /* ══════════════════════════════════════════
           SECCIÓN CHAT DE SOPORTE
        ══════════════════════════════════════════ */
        #section-chat { padding: 0; overflow: hidden; display: none; flex-direction: column; height: calc(100vh - var(--safe-top) - 50px); }
        #section-chat.active { display: flex; opacity: 1; animation: slide-in 0.3s ease-out; }

        /* Header */
        .chat-header { display: flex; align-items: center; gap: 10px; padding: 10px 14px; background: var(--surface); border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .chat-header-avatar { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--brand), rgba(59,130,246,0.5)); display: flex; align-items: center; justify-content: center; color: #fff; flex-shrink: 0; }
        .chat-header-info { flex: 1; display: flex; flex-direction: column; gap: 1px; }
        .chat-header-name { font-family: var(--font-head); font-size: 13px; font-weight: 900; color: var(--text-primary); letter-spacing: 1px; }
        .chat-header-status { font-family: var(--font-head); font-size: 9px; color: var(--text-tertiary); letter-spacing: 0.5px; transition: color 0.3s; }
        .chat-header-status.online { color: var(--long); }

        /* Área de mensajes */
        .chat-messages { flex: 1; overflow-y: auto; padding: 12px 14px; display: flex; flex-direction: column; gap: 10px; scroll-behavior: smooth; overscroll-behavior: contain; -webkit-overflow-scrolling: touch; }
        .chat-messages::-webkit-scrollbar { width: 4px; }
        .chat-messages::-webkit-scrollbar-thumb { background: var(--border-strong); border-radius: 2px; }

        /* Estado vacío */
        .chat-empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; gap: 12px; color: var(--text-tertiary); text-align: center; padding: 40px 20px; }
        .chat-empty-state p { font-family: var(--font-head); font-size: 11px; font-weight: 600; line-height: 1.8; letter-spacing: 0.3px; }

        /* Burbujas */
        .chat-bubble-wrap { display: flex; flex-direction: column; max-width: 78%; gap: 2px; }
        .chat-bubble-wrap.mine { align-self: flex-end; align-items: flex-end; }
        .chat-bubble-wrap.theirs { align-self: flex-start; align-items: flex-start; }
        .chat-bubble { padding: 9px 13px; border-radius: 18px; font-family: var(--font-head); font-size: 12px; font-weight: 600; line-height: 1.55; letter-spacing: 0.2px; word-break: break-word; position: relative; }
        .chat-bubble-wrap.mine .chat-bubble { background: var(--brand); color: #fff; border-bottom-right-radius: 5px; }
        .chat-bubble-wrap.theirs .chat-bubble { background: var(--surface); border: 1px solid var(--border); color: var(--text-primary); border-bottom-left-radius: 5px; }
        .chat-bubble-wrap.theirs.superadmin .chat-bubble { background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(139,92,246,0.1)); border-color: rgba(59,130,246,0.4); }
        .chat-bubble-meta { font-family: var(--font-num); font-size: 9px; color: var(--text-tertiary); padding: 0 4px; display: flex; align-items: center; gap: 4px; }
        .chat-bubble-wrap.mine .chat-bubble-meta { color: rgba(255,255,255,0.5); }
        .chat-check { color: var(--long); font-size: 10px; }
        .chat-sender-name { font-family: var(--font-head); font-size: 9px; font-weight: 800; letter-spacing: 0.5px; padding: 0 4px 2px; color: var(--brand); }

        /* Badge de fecha separador */
        .chat-date-sep { align-self: center; background: var(--surface); border: 1px solid var(--border); border-radius: 20px; padding: 2px 12px; font-family: var(--font-head); font-size: 9px; color: var(--text-tertiary); letter-spacing: 0.5px; margin: 4px 0; }

        /* Input bar */
        .chat-input-bar { display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: var(--surface); border-top: 1px solid var(--border); flex-shrink: 0; padding-bottom: calc(10px + var(--safe-bottom)); }
        .chat-input { flex: 1; background: var(--bg); border: 1px solid var(--border); border-radius: 22px; padding: 9px 14px; color: var(--text-primary); font-family: var(--font-head); font-size: 12px; font-weight: 600; outline: none; transition: border-color 0.2s; letter-spacing: 0.2px; }
        .chat-input:focus { border-color: var(--brand); }
        .chat-input::placeholder { color: var(--text-tertiary); }
        .chat-send-btn { width: 40px; height: 40px; border-radius: 50%; background: var(--brand); border: none; color: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; transition: all 0.2s; box-shadow: 0 2px 8px rgba(59,130,246,0.4); }
        .chat-send-btn:active { transform: scale(0.9); }
        .chat-send-btn:disabled { background: var(--border); box-shadow: none; cursor: not-allowed; }

        /* Typing indicator */
        .chat-typing { display: flex; align-items: center; gap: 4px; padding: 8px 12px; background: var(--surface); border: 1px solid var(--border); border-radius: 18px; border-bottom-left-radius: 5px; align-self: flex-start; }
        .chat-typing span { width: 6px; height: 6px; border-radius: 50%; background: var(--text-tertiary); animation: chat-bounce 1.2s infinite; }
        .chat-typing span:nth-child(2) { animation-delay: 0.2s; }
        .chat-typing span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes chat-bounce { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-5px); } }

        /* Firebase not configured notice */
        .chat-fb-notice { margin: 12px; padding: 12px 14px; background: rgba(245,158,11,0.08); border: 1px solid rgba(245,158,11,0.3); border-radius: 12px; font-family: var(--font-head); font-size: 10px; color: var(--warning); line-height: 1.7; letter-spacing: 0.3px; flex-shrink: 0; }

        /* ════════════════════════════════════════
           GATE.IO COMMAND DASHBOARD — PANEL 3
        ════════════════════════════════════════ */
        .gd-header {
            display: flex; align-items: center; justify-content: space-between;
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 14px; padding: 10px 14px; margin-bottom: 8px;
        }
        .gd-conn-dot {
            width: 10px; height: 10px; border-radius: 50%;
            background: var(--text-tertiary); flex-shrink: 0;
            transition: background 0.5s, box-shadow 0.5s;
        }
        .gd-conn-dot.connected {
            background: var(--long);
            box-shadow: 0 0 8px var(--long);
            animation: pulse-ring 2s infinite;
        }
        .gd-brand {
            font-family: var(--font-head); font-size: 15px; font-weight: 900;
            letter-spacing: 2px; color: var(--brand);
        }
        .gd-conn-label {
            font-family: var(--font-head); font-size: 9px; font-weight: 700;
            color: var(--text-tertiary); letter-spacing: 1px;
            transition: color 0.4s;
        }
        .gd-conn-label.connected { color: var(--long); }
        .gd-update-time {
            font-family: var(--font-num); font-size: 10px; color: var(--text-tertiary);
        }
        .gd-refresh-btn {
            background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.3);
            border-radius: 8px; width: 28px; height: 28px; display: flex;
            align-items: center; justify-content: center; color: var(--brand);
        }

        /* MÉTRICAS GRID 3 COL */
        .gd-metrics-grid {
            display: grid; grid-template-columns: 1fr 1fr 1fr;
            gap: 6px; margin-bottom: 6px;
        }
        .gd-metric-card {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 14px; padding: 10px 8px; text-align: center;
            display: flex; flex-direction: column; gap: 2px;
        }
        .gd-metric-label {
            font-family: var(--font-head); font-size: 8px; font-weight: 700;
            color: var(--text-tertiary); letter-spacing: 0.8px; text-transform: uppercase;
        }
        .gd-metric-value {
            font-family: var(--font-num); font-size: 15px; font-weight: 800;
            color: var(--text-primary); line-height: 1.1;
        }
        .gd-metric-sub {
            font-family: var(--font-num); font-size: 9px; color: var(--text-tertiary);
        }

        /* Mercado Live integrado en gd-metric-card: barra de progreso */
        .gd-metric-card { position: relative; overflow: hidden; }
        .gd-mc-progress {
            position: absolute; bottom: 0; left: 0; height: 2px;
            background: var(--brand); transition: width 0.3s linear; border-radius: 0;
        }
        .gd-mc-change {
            font-family: var(--font-num); font-size: 11px; font-weight: 800;
            padding: 1px 7px; border-radius: 6px; display: inline-block;
        }
        .gd-mc-change.up  { background: rgba(16,185,129,0.15); color: var(--long); }
        .gd-mc-change.down{ background: rgba(239,68,68,0.15);  color: var(--short); }

        /* PORTAFOLIO C5X — barra única horizontal rotatoria */
        .gd-portfolio-bar {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 14px; padding: 8px 10px; margin-top: 6px;
            display: flex; flex-direction: column; align-items: center;
            gap: 4px; min-height: 74px; /* ~20% menos que los 90px previos */
        }
        .gd-dual-label {
            font-family: var(--font-head); font-size: 8px; font-weight: 800;
            color: var(--text-tertiary); letter-spacing: 1.2px; text-transform: uppercase;
        }
        .gd-dual-scroll-wrap {
            width: 100%; overflow: hidden; position: relative; min-height: 36px;
        }
        .gd-dual-track {
            display: flex; transition: transform 0.45s cubic-bezier(0.4,0,0.2,1);
            width: 100%;
        }
        .gd-dual-slide {
            min-width: 100%; display: flex; align-items: center;
            justify-content: space-between; gap: 8px; padding: 0 4px;
            flex-shrink: 0;
        }
        /* Slide portfolio — fila horizontal compacta */
        .gd-slide-left  { display: flex; flex-direction: column; gap: 1px; }
        .gd-slide-right { display: flex; flex-direction: column; align-items: flex-end; gap: 1px; }
        .gd-slide-coin {
            font-family: var(--font-head); font-size: 18px; font-weight: 900; line-height: 1;
        }
        .gd-slide-detail {
            font-family: var(--font-num); font-size: 9px; color: var(--text-tertiary);
        }
        .gd-slide-inv {
            font-family: var(--font-num); font-size: 15px; font-weight: 800;
            color: var(--text-primary); line-height: 1;
        }
        .gd-slide-levels {
            font-family: var(--font-head); font-size: 9px; color: var(--text-tertiary);
        }
        /* Dots */
        .gd-dual-dots { display: flex; gap: 4px; align-items: center; }
        .gd-ddot {
            width: 5px; height: 5px; border-radius: 50%;
            background: var(--border); transition: all 0.3s; flex-shrink: 0;
        }
        .gd-ddot.active { background: var(--brand); width: 12px; border-radius: 3px; }

        
        :root { 
            --bg: #0a0e13; 
            --surface: #141922; 
            --surface-glass: #0a0e13; 
            --card-bg: rgba(255, 255, 255, 0.03); 
            --border: #2b3139; 
            --border-strong: #3d4451; 
            --text-primary: #e5e7eb; 
            --text-secondary: #9ca3af; 
            --text-tertiary: #6b7280; 
            --brand: #3b82f6; 
            --long: #10b981; 
            --short: #ef4444; 
            --warning: #f59e0b; 
            --danger: #dc2626; 
            --zone-gold: #f59e0b; 
            --zone-hot: #fb923c; 
            --zone-warm: #94a3b8; 
            --radius-m: 16px; 
            --chart-bg: #000000; 
            --safe-top: env(safe-area-inset-top, 20px); 
            --safe-bottom: env(safe-area-inset-bottom, 20px); 
            --skeleton: rgba(255,255,255,0.05); 
            
            /* FUENTE PRINCIPAL Y TITULOS: ORBITRON */
            --font-main: 'Orbitron', sans-serif; 
            --font-head: 'Orbitron', sans-serif; 
            
            /* FUENTE NUMERICA: JETBRAINS MONO (Para mantener estructura) */
            --font-num: 'JetBrains Mono', monospace; 
            
            --fs-set-title: 14px; 
            --fs-set-label: 11px; 
            --fs-set-input: 16px; 
        }
        
        body.light-mode { --bg: #F2F0E9; --surface: #E8E6DF; --surface-glass: #F2F0E9; --card-bg: rgba(160, 150, 140, 0.08); --border: #D6D2C8; --border-strong: #BFBBB0; --text-primary: #4A453E; --text-secondary: #7A756D; --text-tertiary: #9E9890; --chart-bg: #F2F0E9; --skeleton: rgba(0,0,0,0.06); --short: #C87965; --danger: #C87965; --long: #6F9C76; --brand: #5C7C8A; --warning: #D99E4B; --zone-gold: #D99E4B; --zone-hot: #C87965; --zone-warm: #8C99A6; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        /* APLICAMOS ORBITRON AL BODY */
        body { font-family: var(--font-main); font-weight: 500; background: var(--bg); color: var(--text-primary); padding-top: var(--safe-top); padding-bottom: calc(20px + var(--safe-bottom)); overflow-x: hidden; user-select: none; font-size: 16px; overscroll-behavior-y: none; transition: background 0.3s ease, color 0.3s ease; letter-spacing: 0.5px; }
        
        /* ... ESTILOS EXISTENTES ... */
        .bot-section { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-m); padding: 10px; margin-bottom: 8px; }
        .bot-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .bot-title { font-size: 18px; font-weight: 700; color: var(--text-primary); display: flex; align-items: center; gap: 4px; }
        .bot-toggle { position: relative; width: 54px; height: 28px; }
        .bot-toggle input { opacity: 0; width: 0; height: 0; }
        .bot-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #374151; transition: 0.3s; border-radius: 28px; }
        .bot-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: 0.3s; border-radius: 50%; }
        .bot-toggle input:checked + .bot-slider { background: linear-gradient(135deg, var(--long), #059669); }
        .bot-toggle input:checked + .bot-slider:before { transform: translateX(26px); }
        .bot-status { display: flex; align-items: center; gap: 4px; padding: 8px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 10px; font-size: 13px; margin-bottom: 8px; }
        .bot-status.inactive { background: rgba(107, 114, 128, 0.1); border-color: rgba(107, 114, 128, 0.3); color: var(--text-secondary); }
        .bot-status.active { background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.3); color: var(--long); }
        .bot-param-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 6px; }
        .bot-param { background: rgba(255, 255, 255, 0.02); border: 1px solid var(--border); border-radius: 10px; padding: 8px; }
        .bot-param-label { font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; display: block; }
        .bot-param-input { width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 6px 8px; color: var(--text-primary); font-family: var(--font-num); font-size: 14px; text-align: center; }
        .bot-param-input:focus { outline: none; border-color: var(--brand); }
        .bot-info { font-size: 12px; color: var(--text-tertiary); line-height: 1.6; padding: 6px; background: rgba(245, 158, 11, 0.05); border-left: 3px solid var(--warning); border-radius: 6px; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border-strong); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--brand); }
        
        /* APLICAR FUENTES ESPECÍFICAS */
        .brand-text, .nav-title, .setting-section-title, .theme-name-label { font-family: var(--font-head); }
        .ticker-price, .input-field, .stat-value, .u-val-primary { font-family: var(--font-num); }
        
        svg { fill: none; stroke: currentColor; stroke-linecap: round; stroke-linejoin: round; stroke-width: 2; pointer-events: none; transition: all 0.3s ease; }
        @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
        @keyframes slide-in { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes grow-up { from { height: 0; opacity: 0; } to { opacity: 1; } }
        @keyframes breathe-real { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.3); } 50% { box-shadow: 0 0 15px 0 rgba(16, 185, 129, 0.3); border-color: var(--long); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.3); } }
        @keyframes breathe-gold { 0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.1); border-color: rgba(245, 158, 11, 0.3); transform: scale(1); background: rgba(245, 158, 11, 0.1); } 50% { box-shadow: 0 0 20px 0 rgba(245, 158, 11, 0.4); border-color: #f59e0b; transform: scale(1.02); background: rgba(245, 158, 11, 0.2); } 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.1); border-color: rgba(245, 158, 11, 0.3); transform: scale(1); background: rgba(245, 158, 11, 0.1); } }
        @keyframes breathe-radar { 0% { box-shadow: 0 4px 12px rgba(0,0,0,0.2); transform: scale(1); } 50% { box-shadow: 0 6px 20px rgba(59, 130, 246, 0.15); transform: scale(1.005); } 100% { box-shadow: 0 4px 12px rgba(0,0,0,0.2); transform: scale(1); } }
        @keyframes gold-flash-anim { 0% { background-color: rgba(245, 158, 11, 0.1); border-color: rgba(245, 158, 11, 0.3); box-shadow: 0 0 0 rgba(245, 158, 11, 0); } 50% { background-color: rgba(245, 158, 11, 0.25); border-color: rgba(245, 158, 11, 0.8); box-shadow: 0 0 15px rgba(245, 158, 11, 0.4); } 100% { background-color: rgba(245, 158, 11, 0.1); border-color: rgba(245, 158, 11, 0.3); box-shadow: 0 0 0 rgba(245, 158, 11, 0); } }
        @keyframes gold-pulse-slot { 0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); border-color: var(--warning); background: rgba(245, 158, 11, 0.2); } 50% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); border-color: #fff; background: rgba(245, 158, 11, 0.5); } 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); border-color: var(--warning); background: rgba(245, 158, 11, 0.2); } }
        
        .anim-click { transition: transform 0.15s cubic-bezier(0.34, 1.56, 0.64, 1), background-color 0.2s, border-color 0.2s; }
        .anim-click:active { transform: scale(0.92); opacity: 0.8; }
        .anim-pulse { animation: pulse-ring 2s infinite; }
        .section-enter { animation: slide-in 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .skeleton-box { background: var(--skeleton); background: linear-gradient(90deg, var(--skeleton) 25%, var(--card-bg) 50%, var(--skeleton) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 4px; color: transparent !important; }
        .skeleton-text { display: inline-block; min-width: 40px; min-height: 1em; border-radius: 4px; }
        #toast { visibility: hidden; width: auto; max-width: 250px; background-color: var(--surface); border: 1px solid var(--border); color: var(--text-primary); text-align: center; border-radius: 16px; padding: 8px 16px; position: fixed; z-index: 9999; left: 50%; top: -100px; transform: translateX(-50%); font-weight: 700; font-size: 11px; font-family: var(--font-head); box-shadow: 0 4px 16px rgba(0,0,0,0.5); transition: top 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease; opacity: 0; backdrop-filter: blur(8px); }
        #toast.show { top: calc(15px + var(--safe-top)); visibility: visible; opacity: 1; }
        #toast.alert-mode { background-color: rgba(220, 38, 38, 0.9); color: #fff; border-color: var(--danger); }
        #toast.success-mode { background-color: rgba(16, 185, 129, 0.9); color: #fff; border-color: var(--long); }
        .fixed-header { position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; background: var(--bg); padding-top: var(--safe-top); transition: background 0.3s; border-bottom: none; }
        .app-header { display: flex; justify-content: space-between; align-items: center; height: 50px; padding: 0 16px; max-width: 1400px; margin: 0 auto; position: relative; }
        .brand-btn { display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 5px; position: relative; z-index: 50; transition: opacity 0.4s ease, transform 0.4s ease; opacity: 1; transform: translateX(0); }
        .theme-btn { width: 36px; height: 36px; border-radius: 50%; background: transparent; border: 1px solid var(--border); color: var(--text-primary); display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; position: relative; z-index: 50; transition: opacity 0.4s ease, transform 0.4s ease; opacity: 1; transform: translateX(0); }
        .brand-btn.hidden { opacity: 0; transform: translateX(-15px); pointer-events: none; }
        .theme-btn.hidden { opacity: 0; transform: translateX(15px); pointer-events: none; }
        
        /* USER MENU DROPDOWN */
        .user-menu-wrapper { position: relative; z-index: 200; }
        .user-btn { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--brand), rgba(59,130,246,0.6)); border: 1.5px solid var(--brand); color: #fff; display: flex; align-items: center; justify-content: center; font-size: 17px; flex-shrink: 0; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 0 10px rgba(59,130,246,0.3); }
        .user-btn:active { transform: scale(0.92); }
        .user-btn.google-connected { background: linear-gradient(135deg, #4285F4, #34A853); border-color: #4285F4; box-shadow: 0 0 10px rgba(66,133,244,0.4); }
        .user-dropdown { position: absolute; top: calc(100% + 10px); right: 0; background: var(--surface); border: 1px solid var(--border); border-radius: 18px; min-width: 210px; box-shadow: 0 8px 32px rgba(0,0,0,0.45); overflow: hidden; display: none; animation: slide-in 0.25s cubic-bezier(0.16,1,0.3,1); z-index: 300; }
        .user-dropdown.open { display: block; }
        
        /* Fila 1: C5X + tema */
        .user-drop-row1 { padding: 14px 16px 12px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .user-drop-c5x { font-family: var(--font-head); font-size: 20px; font-weight: 900; color: var(--brand); letter-spacing: 2px; }
        .user-drop-theme-toggle { display: flex; align-items: center; gap: 5px; background: var(--bg); border: 1px solid var(--border); border-radius: 20px; padding: 5px 10px; cursor: pointer; transition: all 0.2s; }
        .user-drop-theme-toggle:active { transform: scale(0.94); background: rgba(59,130,246,0.1); border-color: var(--brand); }
        .user-drop-theme-label { font-family: var(--font-head); font-size: 9px; font-weight: 700; color: var(--text-tertiary); letter-spacing: 0.5px; }
        
        /* Fila 2: Cuenta Google */
        .user-drop-account { align-items: center; gap: 10px; padding: 12px 16px !important; background: rgba(66,133,244,0.04); border-bottom: 1px solid var(--border) !important; }
        .user-drop-google-icon { width: 28px; height: 28px; border-radius: 50%; background: #fff; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 1px 4px rgba(0,0,0,0.2); }
        .user-drop-account-info { flex: 1; display: flex; flex-direction: column; gap: 1px; }
        .user-drop-account-label { font-family: var(--font-head); font-size: 10px; font-weight: 800; color: var(--text-primary); letter-spacing: 0.5px; }
        .user-drop-account-sub { font-family: var(--font-num); font-size: 10px; color: var(--text-tertiary); }
        .user-drop-account-status { color: var(--text-tertiary); }
        .user-drop-account.connected .user-drop-account-label { color: #4285F4; }
        .user-drop-account.connected .user-drop-account-status { color: #34A853; }
        
        /* Items generales */
        .user-drop-item { padding: 12px 16px; display: flex; align-items: center; gap: 10px; cursor: pointer; font-family: var(--font-head); font-size: 11px; font-weight: 700; color: var(--text-secondary); letter-spacing: 0.5px; transition: background 0.2s, color 0.2s; border-top: 1px solid var(--border); }
        .user-drop-item:first-child { border-top: none; }
        .user-drop-item:active { background: rgba(59,130,246,0.1); color: var(--brand); }
        .user-drop-item svg { flex-shrink: 0; color: var(--text-tertiary); }
        .user-drop-item:active svg { color: var(--brand); }
        
        /* Botón flotante para ir al Monitor ETF */
        .etf-float-btn {
            position: fixed;
            bottom: calc(90px + var(--safe-bottom));
            right: 8px;
            width: 46px;
            height: 46px;
            border-radius: 50%;
            background: var(--brand);
            border: 2px solid var(--border);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
            cursor: pointer;
            z-index: 999;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
            transition: all 0.3s ease;
        }
        .etf-float-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.6);
        }
        .etf-float-btn:active {
            transform: scale(0.95);
        }
        .etf-float-btn.hidden {
            opacity: 0;
            pointer-events: none;
            transform: scale(0.8);
        }
        
        /* SISTEMA DE 3 PANELES DESLIZABLES (ESTILO WHATSAPP) */
        .panels-wrapper {
            position: fixed;
            top: calc(var(--safe-top) + 50px);
            left: 0;
            width: 100%;
            height: calc(100vh - var(--safe-top) - 50px);
            overflow: hidden;
            padding-bottom: var(--safe-bottom);
        }
        /* ==========================================
           SISTEMA DE 4 PANELES DESLIZABLES
           ==========================================
           - Panel 0 (ID: panel0): Dashboard de Trading (5 slots)
           - Panel 1 (ID: panel1): Temporalidades + Chart + Radar
           - Panel 4 (ID: panel4): Vacío
           - Panel 5 (ID: panel5): Chart Secundario + 12 Niveles de Trading
           
           Cada panel ocupa 25% del ancho total (100% / 4)
           El contenedor total es 400% (4 × 100%)
           Las transformaciones mueven el contenedor en incrementos de 25%
        ========================================== */
        
        .panels-container {
            display: flex;
            width: 300%;
            height: 100%;
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            will-change: transform;
        }
        
        .panel {
            width: 33.3333%;
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            flex-shrink: 0;
        }
        
        .panel-content { min-height: 100%; padding: 4px; }
        /* Panel 1 dashboards fill screen */
        #panel0 { display:flex; flex-direction:column; }
        #panel0 .panel-content { flex:1; display:flex; flex-direction:column; min-height:0; overflow:hidden; }
        #dashboardsContainer { flex:1; display:flex; flex-direction:column; min-height:0; }
        #dashboardsContainer .dashboard-card { flex:1; min-height:0 !important; margin:2px 4px !important; }
        
        /* Transformaciones para cada panel (0-2) */
        .panels-container[data-active="0"] { transform: translateX(0%); }
        .panels-container[data-active="1"] { transform: translateX(-33.3333%); }
        .panels-container[data-active="2"] { transform: translateX(-66.6666%); }
        
        /* Estilos para paneles vacíos */
        .empty-panel-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-tertiary);
            font-family: var(--font-head);
            text-align: center;
            padding: 40px 20px;
        }
        
        .empty-panel-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        .empty-panel-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--text-secondary);
        }
        
        .empty-panel-subtitle {
            font-size: 14px;
            opacity: 0.7;
        }
        
        /* Indicadores de panel */
        .panel-indicators {
            position: fixed;
            bottom: calc(10px + var(--safe-bottom));
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            z-index: 998;
            pointer-events: none;
        }
        
        .panel-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--border);
            transition: all 0.3s ease;
        }
        
        .panel-dot.active {
            background: var(--brand);
            width: 24px;
            border-radius: 4px;
        }
        
        /* Display de USDT disponible en header (reemplaza ticker en paneles 2 y 3) */
        .usdt-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--long);
            padding: 8px 20px;
            border-radius: 20px;
            font-family: var(--font-num);
            font-weight: 800;
            font-size: 18px;
            color: var(--long);
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.15);
        }
        
        .usdt-label {
            font-family: var(--font-head);
            font-size: 13px;
            font-weight: 900;
            letter-spacing: 2px;
            color: var(--long);
        }
        
        .usdt-amount {
            font-family: 'JetBrains Mono', monospace;
            font-size: 20px;
            font-weight: 800;
            color: var(--long);
            text-shadow: 0 0 8px rgba(16, 185, 129, 0.4);
        }
        
        
        .brand-text { font-family: var(--font-head); font-weight: 900; font-size: 24px; color: var(--brand); line-height: 1; }
        .ticker-container { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); display: flex; align-items: center; justify-content: center; width: 60%; max-width: 300px; z-index: 10; pointer-events: none; transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1); }
        .ticker-container.expanded { width: 95%; max-width: 600px; }
        .ticker-pill { display: flex; align-items: center; justify-content: center; gap: 12px; background: rgba(255,255,255,0.03); border: 1px solid var(--border); padding: 0 16px; border-radius: 24px; height: 40px; transition: all 0.4s ease; white-space: nowrap; overflow: hidden; width: 100%; pointer-events: auto; position: relative; }
        .ticker-pill.pinned-mode { border-color: var(--brand); background: rgba(59, 130, 246, 0.08); box-shadow: 0 0 10px rgba(59, 130, 246, 0.15); }
        .ticker-pill.scrolled-mode { background: rgba(59, 130, 246, 0.12); border-color: var(--brand); box-shadow: 0 4px 15px rgba(59, 130, 246, 0.25); }
        .ticker-group-left { display: flex; align-items: center; gap: 6px; flex: 0 0 auto; }
        .ticker-group-right { display: flex; align-items: center; gap: 8px; flex: 0 0 auto; }
        .ticker-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--text-secondary); transition: background 0.3s; flex-shrink: 0; }
        .ticker-dot.pulse { animation: pulse-ring 1.5s infinite; }
        .ticker-sym { font-family: var(--font-head); font-weight: 800; font-size: 14px; color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; }
        .ticker-price { font-family: var(--font-num); font-weight: 800; font-size: 16px; color: var(--text-primary); }
        .ticker-pct { font-family: var(--font-num); font-weight: 700; font-size: 12px; padding: 2px 6px; border-radius: 6px; }
        .ticker-pct.up { background: rgba(16, 185, 129, 0.15); color: var(--long); }
        .ticker-pct.down { background: rgba(239, 68, 68, 0.15); color: var(--short); }
        .content-spacer { margin-top: 80px; max-width: 800px; margin-left: auto; margin-right: auto; padding: 0 4px; transition: margin-top 0.3s; }
        .app-section { display: none; opacity: 0; transition: opacity 0.2s ease; }
        .app-section.active { display: block; opacity: 1; animation: slide-in 0.3s ease-out; }
        .scroll-hidden { opacity: 0 !important; pointer-events: none !important; max-height: 0px !important; padding-top: 0px !important; padding-bottom: 0px !important; transform: translateY(-20px); margin-top: 0 !important; margin-bottom: 0 !important; }
        .tf-bar { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; padding: 4px 12px 6px 12px; justify-content: center; background: var(--bg); border: none; margin: 0; box-shadow: none; overflow: hidden; max-height: 50px; opacity: 1; transform: translateY(0); transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease, padding 0.4s ease, transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .tf-btn { background: transparent; border: none; color: var(--text-tertiary); padding: 4px 0; text-align: center; font-family: sans-serif; font-size: 12px; font-weight: 700; border-radius: 8px 8px 0 0; transition: all 0.2s; }
        .tf-btn.active { color: var(--brand); background: rgba(59, 130, 246, 0.1); font-weight: 800; }
        
        /* SLOT NAV 8 SLOTS */
        
        .chart-wrapper { height: 280px; background: var(--chart-bg); margin: 0 10px 6px 10px; border-radius: var(--radius-m); border: 1px solid var(--border); overflow: hidden; position: relative; }
        .chart-wrapper.fullscreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 5000; margin: 0; border-radius: 0; border: none; padding-top: var(--safe-top); padding-bottom: var(--safe-bottom); background: var(--bg); }
        .price-lines-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 10; }
        .price-line { position: absolute; left: 0; right: 0; height: 2px; display: flex; align-items: center; }
        .price-line.avg-line { background: linear-gradient(90deg, transparent, rgba(92, 124, 138, 0.5) 5%, rgba(92, 124, 138, 0.5) 95%, transparent); }
        .price-line.target-line { background: linear-gradient(90deg, transparent, rgba(217, 158, 75, 0.5) 5%, rgba(217, 158, 75, 0.5) 95%, transparent); border-top: 2px dashed var(--warning); }
        .price-line.buy-line { background: linear-gradient(90deg, transparent, rgba(111, 156, 118, 0.3) 5%, rgba(111, 156, 118, 0.3) 95%, transparent); }
        .price-label { position: absolute; right: 10px; background: rgba(10, 14, 19, 0.9); padding: 3px 8px; border-radius: 4px; font-family: var(--font-num); font-size: 10px; font-weight: 800; white-space: nowrap; backdrop-filter: blur(4px); top: -12px; }
        .price-label.avg { color: var(--brand); border-left: 3px solid var(--brand); }
        .price-label.target { color: var(--warning); border-left: 3px solid var(--warning); }
        .price-label.buy { color: var(--long); border-left: 3px solid var(--long); }
        .chart-fs-btn { position: absolute; bottom: 10px; right: 10px; z-index: 20; width: 30px; height: 30px; background: rgba(128,128,128,0.2); border-radius: 6px; display: flex; align-items: center; justify-content: center; color: var(--text-primary); backdrop-filter: blur(4px); }
        .controls-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; padding: 10px; }
        .input-group { background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius-m); padding: 6px; text-align: center; transition: border-color 0.3s, background 0.3s; }
        .input-group:focus-within { border-color: var(--brand); }
        .input-label { font-size: 10px; color: var(--text-secondary); font-weight: 700; text-transform: uppercase; display: block; margin-bottom: 2px; }
        .input-field { width: 100%; background: transparent; border: none; color: var(--text-primary); font-family: var(--font-num); font-size: 15px; font-weight: 700; text-align: center; }
        .input-field.locked-input { color: var(--brand) !important; opacity: 1; cursor: context-menu; font-weight: 800; -webkit-text-fill-color: var(--brand); }
        .input-field.manual-edit { background: rgba(59, 130, 246, 0.15) !important; border-bottom: 2px solid var(--brand) !important; color: #fff !important; -webkit-text-fill-color: #fff !important; animation: pulse-ring 2s infinite; }
        .input-field.editing-mode { color: var(--text-primary) !important; -webkit-text-fill-color: var(--text-primary); border-bottom: 2px solid var(--brand); background: rgba(59, 130, 246, 0.1); opacity: 1; }
        
        .radar-ticker-large { 
            background: var(--surface); 
            border: 1px solid var(--border); 
            border-radius: 18px; 
            padding: 5px 10px; /* Padding reducido */
            margin: 4px 10px 10px; 
            text-align: center; 
            position: relative; 
            cursor: pointer; 
            transition: all 0.3s; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
            min-height: 85px; /* Reducido de 95px */
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            user-select: none;
            animation: breathe-radar 3s ease-in-out infinite;
        }
        .radar-ticker-large:active { transform: scale(0.98); background: var(--card-bg); }
        .radar-ticker-large.flash-gold { animation: gold-flash-anim 2s infinite ease-in-out !important; }
        .radar-ticker-large.gold-mode-active { 
            animation: breathe-gold 2s infinite ease-in-out !important; 
            border-color: rgba(251, 191, 36, 0.4);
            background: rgba(251, 191, 36, 0.05) !important;
            box-shadow: 0 4px 20px rgba(251, 191, 36, 0.15) !important;
        }
        .radar-status-dot { position: absolute; top: 10px; left: 10px; width: 7px; height: 7px; border-radius: 50%; background: var(--long); box-shadow: 0 0 8px var(--long); }
        .radar-status-dot.offline { background: var(--danger); box-shadow: none; opacity: 0.5; }
        
        /* FUENTE JETBRAINS MONO PARA TODOS LOS NÚMEROS */
        .number-display,
        #resInv,
        #resAvg,
        #resTarget,
        .stat-val,
        .u-val-primary,
        .u-val-secondary,
        .etf-change-badge,
        .etf-score-display,
        #totalBalanceDisplay,
        #radarValue,
        .ticker-price,
        #t-price,
        #t-pct,
        input[type="number"],
        .level-price,
        .level-profit,
        .level-qty {
            font-family: 'JetBrains Mono', monospace !important;
            font-weight: 700 !important;
            letter-spacing: 0.3px !important;
        }
        
        .radar-header-line {
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: 12px;
            width: 100%;
            padding: 2px 0; /* Reduced padding */
        }
        .radar-title-compact { 
            font-family: var(--font-head); 
            font-size: 14px; /* Aumentado de 11px */
            font-weight: 900; 
            color: var(--brand); 
            letter-spacing: 2px; /* Aumentado de 1.5px */
            display: flex; 
            align-items: center; 
            gap: 6px; /* Aumentado de 5px */
            text-transform: uppercase; 
            justify-self: start;
        }
        .radar-balance-compact {
            font-family: 'JetBrains Mono', monospace; /* Cambiado para mejor legibilidad */
            font-size: 24px; /* Aumentado de 18px */
            font-weight: 800; /* Aumentado de 900 para mejor visibilidad */
            color: var(--long);
            text-shadow: 0 0 12px rgba(16, 185, 129, 0.3); /* Aumentado glow */
            white-space: nowrap;
            justify-self: end;
            letter-spacing: 0.5px; /* Añadido para mejor separación de números */
        }
        
        .radar-token-centered { 
            font-family: var(--font-num); 
            font-weight: 800; 
            font-size: 20px; 
            color: var(--text-primary); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            gap: 4px;
            text-align: center;
            justify-self: center;
        }
        
        .dash-header-new {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 6px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border);
            gap: 0px;
        }
        .dash-app-label {
            font-family: var(--font-head);
            font-size: 10px;
            font-weight: 700;
            color: var(--text-tertiary);
            letter-spacing: 3px;
            text-transform: uppercase;
        }
        .dash-coin-title {
            font-family: var(--font-head);
            font-weight: 900;
            font-size: 32px;
            color: var(--brand);
            text-transform: uppercase;
            line-height: 1.1;
        }

        /* NUEVO GRID COMPACTO 6 SECCIONES */
        .dash-compact-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: auto auto;
            gap: 4px;
        }
        /* ACTIVO — celda normal en col 1 fila 1 */
        .dash-cell-coin {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 6px 8px;
            display: flex;
            flex-direction: column;
            gap: 1px;
        }
        .dash-cell-coin-label {
            font-family: var(--font-head);
            font-size: 9px;
            font-weight: 700;
            color: var(--text-tertiary);
            letter-spacing: 1.5px;
            text-transform: uppercase;
            line-height: 1;
        }
        .dash-cell-coin-name {
            font-family: var(--font-head);
            font-weight: 900;
            font-size: 20px;
            color: var(--brand);
            text-transform: uppercase;
            line-height: 1.1;
        }
        /* CELDAS INDIVIDUALES */
        .dash-cell {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 6px 8px;
            display: flex;
            flex-direction: column;
            gap: 1px;
            position: relative;
            transition: all 0.2s;
        }
        .dash-cell:active { transform: scale(0.97); }
        .dash-cell.pressing {
            background: rgba(239, 68, 68, 0.1) !important;
            border-color: var(--danger) !important;
        }
        .dash-cell-label {
            font-family: var(--font-head);
            font-size: 9px;
            font-weight: 700;
            color: var(--text-tertiary);
            letter-spacing: 1.5px;
            text-transform: uppercase;
            line-height: 1;
        }
        .dash-cell-value {
            font-family: var(--font-num);
            font-size: 13px;
            font-weight: 800;
            color: var(--text-primary);
            line-height: 1.1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .dash-cell-value.warning { color: var(--warning); }
        /* MANUAL — celda normal col 3 fila 2 */
        .dash-cell-manual { }
        
        .dashboard-card { background: var(--surface); border: 1px solid var(--border); border-radius: 18px; margin: 6px 6px 6px; padding: 8px; box-shadow: 0 8px 25px rgba(0,0,0,0.3); position: relative; overflow: hidden; transition: background 0.3s, border-color 0.3s; }
        .dashboard-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: linear-gradient(90deg, var(--brand), var(--long)); }
        .dashboard-card.slot-active { border-color: var(--brand); box-shadow: 0 0 0 2px rgba(59,130,246,0.35), 0 8px 25px rgba(0,0,0,0.3); }
        .dashboard-card.slot-active::before { background: linear-gradient(90deg, var(--brand), var(--long)); height: 3px; }
        .dash-slot-label { font-family: var(--font-head); font-size: 8px; font-weight: 900; letter-spacing: 2px; color: var(--text-tertiary); text-align: right; margin-bottom: 4px; padding-right: 2px; }
        .dashboard-card.slot-active .dash-slot-label { color: var(--brand); }
        .dash-controls-unified { display: grid; grid-template-columns: 1fr; gap: 4px; align-items: stretch; margin-top: 0; }
        
        #etfMonitorToggleBtn { display: none; background: rgba(59, 130, 246, 0.1); border: 1px solid var(--brand); border-radius: var(--radius-m); padding: 12px 16px; cursor: pointer; transition: all 0.3s ease; align-items: center; justify-content: space-between; margin-bottom: 10px; font-family: var(--font-head); font-weight: 800; font-size: 12px; letter-spacing: 1px; color: var(--brand); user-select: none; }
        #etfMonitorToggleBtn:hover { background: rgba(59, 130, 246, 0.15); transform: translateY(-2px); }
        #etfMonitorToggleBtn:active { transform: translateY(0); }
        #etfMonitorToggleBtn.collapsed { background: rgba(255, 255, 255, 0.02); border-color: var(--border); color: var(--text-secondary); }
        .toggle-icon { font-size: 10px; transition: transform 0.3s ease; margin-left: auto; }
        .toggle-icon.rotated { transform: rotate(180deg); }
        .dash-toggles-row { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-bottom: 8px; }
        .mode-toggle-pill, .strat-toggle-pill { text-align: center; font-family: var(--font-head); font-weight: 800; font-size: 11px; padding: 10px 4px; border-radius: 12px; cursor: pointer; transition: all 0.2s; border: 1px solid var(--border); background: rgba(255,255,255,0.02); text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; justify-content: center; height: 40px; user-select: none; }
        .mode-toggle-pill.real { background: rgba(16, 185, 129, 0.15); color: var(--long); border-color: var(--long); animation: breathe-real 4s infinite; }
        .mode-toggle-pill.real.disconnected { background: #2a2d35; color: #6b7280; border-color: #3a3d45; animation: none; opacity: 0.7; }
        .mode-toggle-pill.sim { background: rgba(245, 158, 11, 0.15); color: var(--warning); border-color: var(--warning); }
        .mode-toggle-pill:active, .strat-toggle-pill:active { transform: scale(0.95); opacity: 0.8; }
        
        .strategy-option { 
            text-align: center; 
            font-family: var(--font-head); 
            font-weight: 800; 
            font-size: 10px; 
            padding: 10px 4px; 
            border-radius: 12px; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            border: 1.5px solid var(--border); 
            background: rgba(255,255,255,0.02); 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            height: 40px; 
            user-select: none; 
            opacity: 0.4; 
            color: var(--text-secondary); 
        }
        .strategy-option:active { transform: scale(0.95); }
        .strategy-option.active { opacity: 1; border-width: 2px; }
        #stratNormal.active { background: rgba(59, 130, 246, 0.15); color: var(--brand); border-color: var(--brand); box-shadow: 0 0 12px rgba(59, 130, 246, 0.3); }
        .strat-toggle-pill.aggressive { color: var(--short); border-color: var(--short); background: rgba(239, 68, 68, 0.1); }
        .strat-toggle-pill.gold-mode { color: var(--warning); border-color: var(--warning); background: rgba(245, 158, 11, 0.1); animation: breathe-gold 2s infinite !important; }
        
        .target-and-strategies-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 3px;
            align-items: stretch;
            margin-bottom: 4px;
        }
        .strategy-option-compact {
            background: rgba(255,255,255,0.02);
            border: 1.5px solid var(--border);
            border-radius: 10px;
            padding: 0px 4px !important;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-head);
            font-weight: 900;
            font-size: 9px !important;
            letter-spacing: 0.3px;
            text-transform: uppercase;
            color: var(--text-secondary);
            user-select: none;
            opacity: 0.4;
            line-height: 1 !important;
        }
        .strategy-option-compact:active { transform: scale(0.95); }
        .strategy-option-compact.active { opacity: 1; border-width: 2px; }
        .strategy-option-compact.mode-normal { 
            background: rgba(59, 130, 246, 0.15); 
            color: var(--brand); 
            border-color: var(--brand); 
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.3);
            opacity: 1;
        }
        .strategy-option-compact.mode-dorada { 
            background: rgba(251, 191, 36, 0.20); 
            color: #fbbf24; 
            border-color: #fbbf24; 
            box-shadow: 0 0 8px rgba(251, 191, 36, 0.4);
            opacity: 1;
        }
        .strategy-option-compact#stratNormal.active { 
            background: rgba(59, 130, 246, 0.15); 
            color: var(--brand); 
            border-color: var(--brand); 
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.3); 
        }
            background: rgba(251, 191, 36, 0.20); 
            color: #fbbf24; 
            border-color: #fbbf24; 
            box-shadow: 0 0 8px rgba(251, 191, 36, 0.4); 
        }
        .strategy-option-compact.pressing,
        .dash-target-bar-compact.pressing {
            transform: scale(0.95) !important;
            background: rgba(59, 130, 246, 0.2) !important;
            border-color: var(--brand) !important;
            transition: all 0.1s ease;
            position: relative;
        }
        .strategy-option-compact.pressing::before,
        .dash-target-bar-compact.pressing::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 3px;
            background: var(--brand);
            animation: press-progress 1.2s linear;
            z-index: 10;
        }
        
        /* Inputs de Precio Base y Capital en Dashboard */
        .dash-input-box {
            background: rgba(255,255,255,0.02);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 4px 6px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .dash-input-box:active { transform: scale(0.98); }
        .dash-input-box .stat-lbl {
            font-size: 8px !important;
            margin-bottom: 2px !important;
        }
        .dash-input-box input {
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: var(--font-num);
            font-size: 13px !important;
            font-weight: 800;
            text-align: center;
            width: 100%;
            outline: none;
            padding: 0;
        }
        .dash-input-box input:focus {
            color: var(--brand);
        }
        .dash-input-box.editable {
            border-color: var(--brand);
            background: rgba(59, 130, 246, 0.05);
        }
        
        .dash-target-bar-compact {
            background: linear-gradient(90deg, rgba(245, 158, 11, 0.1), rgba(251, 146, 60, 0.05));
            border: 1px solid var(--warning);
            border-radius: 10px;
            padding: 0px 6px !important; /* Padding mínimo */
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            position: relative;
        }
        .dash-target-bar-compact:active { transform: scale(0.98); }
        .dash-target-bar-compact .target-center {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0 !important;
            justify-content: center;
        }
        .dash-target-bar-compact .stat-lbl {
            font-size: 8px !important;
            margin-bottom: 0px !important;
            line-height: 1 !important;
        }
        .dash-target-bar-compact .stat-val {
            font-size: 14px !important;
            line-height: 1.1 !important;
        }
        
        .dash-footer-hint { display: none !important; }
        .target-right-icon { display: none !important; }
        
        .dash-stats-matrix { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 3px; margin-bottom: 4px; }
        
        /* REGLA CRÍTICA: Todas las casillas del dashboard deben tener exactamente 48px de altura */
        .stat-box-unified,
        .strategy-option-compact,
        .dash-target-bar-compact {
            box-sizing: border-box !important;
            height: 48px !important;
            min-height: 48px !important;
            max-height: 48px !important;
            overflow: hidden !important;
        }
        
        .stat-box-unified { 
            background: rgba(255,255,255,0.02); 
            border: 1px solid var(--border); 
            border-radius: 10px; 
            padding: 2px 2px; 
            text-align: center; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            position: relative; 
        }
        .stat-lbl { font-size: 9px !important; color: var(--text-tertiary); font-weight: 700; margin-bottom: 0px !important; text-transform: uppercase; line-height: 1 !important; }
        .stat-val { font-family: var(--font-num); font-size: 14px !important; font-weight: 800; color: var(--text-primary); line-height: 1.1 !important; }
        .stat-val.green { color: var(--long); }
        .expand-icon { font-size: 10px; color: var(--brand); transition: transform 0.3s; }
        .expand-icon.expanded { transform: rotate(180deg); }
        .dash-controls-unified { display: grid; grid-template-columns: 1fr 44px; gap: 4px; align-items: stretch; margin-top: 4px; }
        .btn-mini-control { width: 44px; height: 44px; background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s; color: var(--text-secondary); }
        .btn-mini-control:active { transform: scale(0.95); }
        .btn-clean-unified:active { background: rgba(220, 38, 38, 0.1); color: var(--danger); border-color: var(--danger); }
        .btn-toggle-levels.active { background: rgba(59, 130, 246, 0.1); color: var(--brand); border-color: var(--brand); }
        .trading-manual-btn { background: rgba(59, 130, 246, 0.1); border: 2px solid var(--brand); border-radius: 12px; padding: 0 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 1px; font-family: var(--font-head); font-weight: 900; font-size: 12px; letter-spacing: 0.8px; color: var(--brand); cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; height: 44px; }
        .trading-manual-btn:active { transform: scale(0.98); background: rgba(59, 130, 246, 0.15); }
        .trading-manual-btn.auto-mode { background: rgba(16, 185, 129, 0.1); border-color: var(--long); color: var(--long); }
        .trading-manual-btn.auto-mode::before { content: ''; position: absolute; left: 0; top: 0; height: 100%; width: 4px; background: var(--long); animation: pulse-ring 2s infinite; }
        .trading-manual-btn.locked { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
        .levels-container { 
            padding: 8px 10px 8px 10px; 
            display: flex; 
            flex-direction: column; 
            gap: 7px; 
            padding-bottom: 8px;
            max-height: 100% !important;
            min-height: 0;
            height: auto;
            overflow-y: auto !important;
            overflow-x: hidden; 
            -webkit-overflow-scrolling: touch;
            transition: opacity 0.3s ease; 
            opacity: 1;
            position: relative;
            scroll-behavior: smooth;
            touch-action: pan-y !important;
            overscroll-behavior: contain;
            /* Permitir scroll desde toda el área */
            user-select: none;
            -webkit-user-select: none;
        }
        /* Scrollbar visible en todo el contenedor */
        .levels-container::-webkit-scrollbar { 
            width: 6px;
        }
        .levels-container::-webkit-scrollbar-track { 
            background: rgba(255,255,255,0.03); 
            border-radius: 3px;
        }
        .levels-container::-webkit-scrollbar-thumb { 
            background: var(--brand); 
            border-radius: 3px; 
        }
        .levels-container::-webkit-scrollbar-thumb:hover { 
            background: rgba(59, 130, 246, 1); 
        }
        .levels-container.collapsed { 
            max-height: 0 !important; 
            opacity: 0 !important; 
            padding-top: 0 !important; 
            padding-bottom: 0 !important; 
            overflow: hidden !important; 
        }
        
        /* Monitor ETF: Lista lineal sin scroll y sin espacios muertos */
        #etfGrid.levels-container {
            max-height: none; /* Eliminar límite de altura */
            overflow-y: visible; /* Sin scroll */
            padding: 0 10px; /* Sin padding arriba/abajo */
            padding-bottom: 8px; /* Reducido al mínimo */
            padding-top: 0; /* Sin espacio arriba */
        }
        
        .unified-card { 
            background: var(--card-bg); 
            border: 1px solid var(--border); 
            border-radius: var(--radius-m); 
            padding: 10px; 
            display: grid; 
            grid-template-columns: 44px 1fr auto; 
            gap: 10px; 
            align-items: center; 
            cursor: pointer; 
            transition: transform 0.1s ease, background 0.2s ease, border-color 0.3s, opacity 0.3s ease; 
            position: relative; 
            overflow: hidden; 
            height: 82px !important;
            min-height: 82px !important;
            max-height: 82px !important;
            opacity: 0.75; 
            flex-shrink: 0 !important;
            box-sizing: border-box !important;
            contain: layout style paint;
            will-change: auto;
            /* Permitir scroll sin interferencias */
            touch-action: pan-y !important;
            user-select: none;
            -webkit-user-select: none;
        }
        .unified-card:active { transform: scale(0.98); }
        .unified-card.is-pending { opacity: 1 !important; border: 1px dashed var(--warning) !important; background: rgba(245, 158, 11, 0.05) !important; transform: scale(1.0); }
        .unified-card.is-sent { opacity: 1 !important; border: 1px solid var(--warning) !important; background: rgba(245, 158, 11, 0.08) !important; transform: scale(1.0); }
        .unified-card.is-filled { opacity: 1 !important; background: rgba(16, 185, 129, 0.12) !important; border: 1px solid var(--long) !important; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.15); transform: scale(1.01); z-index: 5; }
        .unified-card.is-reached { opacity: 1 !important; border: 1px solid rgba(59, 130, 246, 0.6) !important; background: rgba(59, 130, 246, 0.08) !important; transform: scale(1.0); }
        .unified-card.flash-gold-card { animation: gold-flash-anim 1.5s infinite ease-in-out; border-color: var(--warning); background: rgba(245, 158, 11, 0.1); opacity: 1 !important; } 
        .order-status-badge { position: absolute; top: 4px; left: 48px; padding: 2px 6px; border-radius: 8px; font-size: 7px; font-weight: 800; font-family: var(--font-head); letter-spacing: 0.3px; text-transform: uppercase; z-index: 10; }
        .order-status-badge.selected { background: rgba(59, 130, 246, 0.2); color: var(--brand); border: 1px solid var(--brand); }
        .order-status-badge.pending { background: rgba(245, 158, 11, 0.2); color: var(--warning); border: 1px solid var(--warning); animation: pulse-ring 1.5s infinite; }
        .order-status-badge.sent { background: rgba(245, 158, 11, 0.25); color: var(--warning); border: 1px solid var(--warning); }
        .order-status-badge.filled { background: rgba(16, 185, 129, 0.2); color: var(--long); border: 1px solid var(--long); }
        .order-status-badge.error { background: rgba(239, 68, 68, 0.2); color: var(--short); border: 1px solid var(--short); }
        .order-status-badge.available { background: rgba(59, 130, 246, 0.2); color: var(--brand); border: 1px solid var(--brand); }
        .unified-card.pressing { 
            transform: scale(0.97) !important; 
            background: rgba(59, 130, 246, 0.15) !important; 
            border-color: var(--brand) !important;
            transition: all 0.1s ease;
        }
        .unified-card.pressing::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--brand);
            animation: press-progress 1.2s linear;
        }
        @keyframes press-progress {
            from { width: 0%; }
            to { width: 100%; }
        }
        .u-index { width: 42px; height: 42px; border-radius: 50%; background: rgba(59, 130, 246, 0.1); border: 2px solid var(--border); display: flex; align-items: center; justify-content: center; font-family: var(--font-head); font-weight: 900; color: var(--text-tertiary); font-size: 15px; box-shadow: 0 0 10px rgba(0,0,0,0.1); margin: 0 auto; transition: all 0.3s; }
        .unified-card.is-filled .u-index { background: var(--long); color: #fff; border-color: var(--long); box-shadow: 0 0 10px rgba(16, 185, 129, 0.4); }
        .unified-card.is-pending .u-index { background: rgba(245, 158, 11, 0.2); color: var(--warning); border-color: var(--warning); box-shadow: 0 0 10px rgba(245, 158, 11, 0.2); animation: pulse-ring 2s infinite; }
        .unified-card.is-sent .u-index { background: rgba(245, 158, 11, 0.15); color: var(--warning); border-color: var(--warning); }
        .u-center { display: flex; flex-direction: column; justify-content: center; overflow: hidden; gap: 6px; }
        .u-title { font-family: var(--font-num); font-size: 22px; font-weight: 800; color: var(--text-primary); line-height: 1; margin-bottom: 2px; }
        .u-sub { font-size: 11px; font-weight: 600; color: var(--text-tertiary); margin-top: 2px; text-transform: uppercase; }
        .u-right { text-align: right; display: flex; flex-direction: column; justify-content: center; gap: 4px; flex-shrink: 0; position: relative; }
        .multi-buy-indicator { position: absolute; top: -8px; right: -8px; background: var(--brand); color: #fff; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 900; font-family: var(--font-head); box-shadow: 0 2px 8px rgba(59, 130, 246, 0.5); z-index: 10; }
        .u-val-accumulated { font-family: var(--font-num); font-size: 11px; font-weight: 700; color: var(--long); margin-top: 2px; }
        .u-val-primary { font-family: var(--font-num); font-size: 15px; font-weight: 800; }
        .etf-score-display { font-family: var(--font-num); font-weight: 900; font-size: 20px; color: var(--warning); display:flex; align-items:center; justify-content:flex-end; gap:4px; }
        .etf-search-box { position: relative; margin: 0px 10px 2px 10px; } 
        .etf-search-input { width: 100%; background: var(--card-bg); border: 1px solid var(--border); padding: 14px 14px 14px 45px; border-radius: var(--radius-m); color: var(--text-primary); font-family: var(--font-head); font-weight: 700; font-size: 14px; transition: border 0.3s; }
        .etf-search-input:focus { border-color: var(--brand); }
        .etf-search-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--text-tertiary); }
        .etf-change-badge { padding: 4px 8px; border-radius: 6px; font-size: 13px; font-weight: 800; font-family: var(--font-num); }
        .etf-up { background: rgba(14, 203, 129, 0.18); color: var(--long); }
        .etf-down { background: rgba(246, 70, 93, 0.18); color: var(--short); }
        .setting-section-title { padding: 5px 5px; font-family: var(--font-head); color: var(--text-secondary); font-weight: 900; letter-spacing: 1.5px; display:flex; align-items:center; gap:8px; margin-top: 0px; font-size: var(--fs-set-title); }
        .settings-grid { display: flex; flex-direction: column; gap: 8px; }
        .setting-card-item { background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius-m); padding: 16px; display: flex; flex-direction: column; gap: 5px; transition: background 0.3s, border-color 0.3s; }
        .setting-label { font-size: var(--fs-set-label); color: var(--text-secondary); font-weight: 700; text-transform: uppercase; }
        .setting-input { width: 100%; background: transparent; border: none; color: var(--text-primary); font-family: var(--font-num); font-size: var(--fs-set-input); font-weight: 700; }
        .input-row-save { display: flex; align-items: center; gap: 10px; width: 100%; }
        .btn-save-mini { background: var(--brand); color: #fff; border: none; width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }
        .data-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .btn-data { background: var(--surface); border: 1px solid var(--border); color: var(--text-primary); padding: 12px; border-radius: 10px; font-size: 12px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-reset { background: rgba(207, 48, 74, 0.1); color: var(--danger); border: 1px solid var(--danger); padding: 12px 20px; border-radius: 10px; font-weight: 900; width: 100%; margin-top: 10px; font-family: var(--font-head); cursor: pointer; display:flex; align-items:center; justify-content:center; gap:8px; }
        .chip-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
        .chip { background: rgba(59, 130, 246, 0.1); border: 1px solid var(--border); border-radius: 20px; padding: 6px 12px; font-size: 12px; font-weight: 700; display: flex; align-items: center; gap: 8px; color: var(--text-primary); }
        .chip-del { cursor: pointer; width: 16px; height: 16px; border-radius: 50%; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; font-size: 10px; color: var(--text-secondary); }
        .multi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 5px; }
        .multi-item { background: rgba(0,0,0,0.2); border: 1px solid var(--border); border-radius: 8px; padding: 5px; text-align: center; }
        .multi-item.filled { border-color: var(--brand); background: rgba(59, 130, 246, 0.1); }
        .multi-lbl { font-size: var(--fs-set-label); color: var(--text-tertiary); display: block; font-weight: 700; }
        .multi-inp { width: 100%; background: transparent; border: none; color: var(--brand); font-family: var(--font-num); font-weight: 800; font-size: var(--fs-set-input); text-align: center; }
        #navModal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 2000; display: none; justify-content: center; align-items: center; padding-top: var(--safe-top); }
        .nav-content { background: var(--surface); width: 85%; max-width: 320px; border-radius: 30px; padding: 35px 25px; border: 1px solid var(--border); box-shadow: 0 30px 60px rgba(0,0,0,0.6); display: flex; flex-direction: column; gap: 15px; }
        .nav-title { font-family: var(--font-head); font-size: 18px; margin-bottom: 10px; color: var(--brand); text-align: center; font-weight: 900; letter-spacing: 2px; }
        .nav-item { display: flex; align-items: center; padding: 20px; border-radius: 18px; background: rgba(255,255,255,0.02); border: 1px solid var(--border); cursor: pointer; transition: 0.3s; }
        .nav-item.selected { background: rgba(59, 130, 246, 0.1); border-color: var(--brand); box-shadow: 0 5px 20px rgba(59, 130, 246, 0.15); }
        .nav-icon { width: 40px; height: 40px; margin-right: 20px; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); }
        .nav-item.selected .nav-icon { color: var(--brand); }
        .nav-text { font-family: var(--font-head); font-weight: 700; font-size: 14px; letter-spacing: 1px; color: var(--text-primary); }
        .btn-close-menu { margin-top: 10px; width: 100%; padding: 16px; border-radius: 16px; border: 1px solid var(--border); background: var(--surface); color: var(--danger); font-family: var(--font-head); font-weight: 900; font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .generic-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 3000; display: none; justify-content: center; align-items: center; }
        .modal-box { background: var(--surface); width: 85%; max-width: 300px; padding: 25px; border-radius: 20px; border: 1px solid var(--border); text-align: center; }
        .btn-modal { width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: 700; margin-bottom: 8px; cursor: pointer; }
        .btn-confirm { background: var(--brand); color: #fff; }
        .btn-cancel { background: transparent; color: var(--text-secondary); }
        .modal-inp { width: 100%; background: var(--bg); border: 1px solid var(--border); padding: 12px; border-radius: 10px; color: var(--text-primary); font-size: 24px; letter-spacing: 5px; text-align: center; margin: 20px 0; font-family: var(--font-num); monospace; }
        .action-btn { background: var(--surface); border: 1px solid var(--brand); color: var(--brand); padding: 6px 12px; border-radius: 8px; font-size: 11px; font-weight: 800; cursor: pointer; font-family: var(--font-head); display: flex; align-items: center; gap: 5px; }
        .log-header-bar { display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 5px 16px 10px 16px; }
        .log-title { margin-bottom: 0px; font-family: var(--font-head); font-weight: 900; letter-spacing: 1px; color:var(--brand); }
        .log-actions { display: flex; gap: 15px; width: 100%; justify-content: center; }
        .stats-card { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; margin: 0 10px 15px; padding: 15px; }
        .stats-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .stats-title { font-family: var(--font-head); font-size: 12px; font-weight: 900; color: var(--brand); letter-spacing: 1px; }
        .stats-toggles { display: flex; gap: 5px; background: rgba(0,0,0,0.2); padding: 3px; border-radius: 8px; border: 1px solid var(--border); }
        .stat-btn { background: transparent; border: none; color: var(--text-tertiary); font-size: 10px; font-weight: 800; padding: 4px 10px; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .stat-btn.active { background: var(--brand); color: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .chart-box { height: 160px; display: flex; align-items: flex-end; justify-content: space-between; gap: 4px; padding-bottom: 5px; border-bottom: 1px solid var(--border); margin-bottom: 10px; position: relative; }
        .chart-bar { flex: 1; min-width: 4px; border-radius: 2px 2px 0 0; position: relative; transition: height 0.5s ease; animation: grow-up 0.5s ease-out; }
        .chart-bar.win { background: linear-gradient(to top, rgba(16,203,129,0.3), var(--long)); }
        .chart-bar.loss { background: linear-gradient(to top, rgba(246,70,93,0.3), var(--short)); }
        .chart-bar:hover { opacity: 0.8; }
        .chart-bar::after { content: attr(data-val); position: absolute; top: -15px; left: 50%; transform: translateX(-50%); font-size: 9px; font-family: var(--font-num); color: var(--text-primary); opacity: 0; transition: 0.2s; pointer-events: none; white-space: nowrap; }
        .chart-bar:hover::after { opacity: 1; top: -20px; }
        .stats-summary { display: flex; justify-content: space-between; align-items: center; font-size: 12px; }
        .sum-label { color: var(--text-tertiary); font-weight: 700; margin-right: 5px; }
        .sum-val { font-family: var(--font-num); font-weight: 800; color: var(--text-primary); }
        #logGrid { max-height: 395px; overflow-y: auto; overscroll-behavior: contain; border-bottom: 1px solid var(--border); margin-bottom: 20px; padding-right: 2px; }
        #logGrid::-webkit-scrollbar { width: 4px; }
        #logGrid::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
        .modal-info-text { font-size: 12px; color: var(--text-secondary); margin-bottom: 15px; }
        .trade-details { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; margin-bottom: 15px; font-family: var(--font-num); font-size: 13px; text-align: left; }
        .gate-connection-indicator { display: inline-flex; align-items: center; gap: 5px; padding: 3px 8px; border-radius: 10px; font-size: 9px; font-weight: 700; letter-spacing: 0.3px; border: 1px solid; transition: all 0.3s ease; }
        .gate-connection-indicator.connected { background: rgba(16, 185, 129, 0.12); border-color: rgba(16, 185, 129, 0.4); color: var(--long); }
        .gate-connection-indicator.disconnected { background: rgba(245, 158, 11, 0.12); border-color: rgba(245, 158, 11, 0.4); color: var(--warning); }
        .gate-status-dot { width: 5px; height: 5px; border-radius: 50%; background: currentColor; }
        .gate-connection-indicator.connected .gate-status-dot { animation: pulse-dot 2s ease-in-out infinite; }
        @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        
        /* SISTEMA DE RADAR MEJORADO - LIMPIO */
        .radar-zone-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 800;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            display: inline-block;
        }
        
        .radar-zone-badge.gold {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #000;
            animation: pulse-gold 2s infinite;
        }
        
        .radar-zone-badge.hot {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: #fff;
        }
        
        .radar-zone-badge.warm {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: #fff;
        }
        
        @keyframes pulse-gold {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 2px 8px rgba(255, 215, 0, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 4px 16px rgba(255, 215, 0, 0.8);
            }
        }
        
        
        .radar-ticker-large {
            position: relative;
            overflow: visible;
        }
        
        #desktop-etf-list { display: none; }
        #layout-container { display: flex; flex-direction: column; width: 100%; gap: 2px; }
        .cols-container { display: contents; }
        .left-col, .right-col { display: contents; }
        
        #tv_chart { order: 1; margin-bottom: 2px !important; }
        #controlsGrid { order: 2; margin-bottom: 2px !important; }
        #radarTickerContainer { order: 3; margin-bottom: 2px !important; }
        #etfMonitorToggleBtn { order: 4; margin-bottom: 2px !important; }
        #dashMain { order: 5; margin-bottom: 2px !important; }
        #levelsGrid { order: 6; }
        #desktop-etf-list { display: none; order: 7; }
        @media (max-width: 767px) { .content-spacer { padding: 4px; margin-top: 80px !important; } #tv_chart, #controlsGrid, #radarTickerContainer, #dashMain { margin: 0 !important; margin-bottom: 2px !important; } .dashboard-card, .radar-ticker-large, .input-group, .unified-card { margin-left: 0 !important; margin-right: 0 !important; } }
        @media (min-width: 768px) { .content-spacer { padding: 4px; margin-top: 78px !important; max-width: 100%; } #layout-container { display: grid; grid-template-columns: 25% 50% 25%; grid-template-rows: auto minmax(0, 1fr) minmax(0, 1fr) minmax(0, 1fr) minmax(0, 1fr); gap: 4px; height: calc(100vh - 82px); } .cols-container { display: contents; } .left-col { display: contents; } .right-col { display: contents; } #controlsGrid { grid-column: 1; grid-row: 2; margin: 0; padding: 6px 8px !important; overflow: hidden; } #levelsGrid { grid-column: 1; grid-row: 3 / 6; margin: 0; padding: 8px !important; overflow-y: auto; overflow-x: hidden; max-height: 100% !important; -webkit-overflow-scrolling: touch; scroll-behavior: smooth; } #levelsGrid::-webkit-scrollbar { width: 6px; } #levelsGrid::-webkit-scrollbar-track { background: rgba(255,255,255,0.03); border-radius: 3px; } #levelsGrid::-webkit-scrollbar-thumb { background: var(--brand); border-radius: 3px; } #levelsGrid::-webkit-scrollbar-thumb:hover { background: rgba(59, 130, 246, 1); } #levelsGrid .unified-card { padding: 10px !important; min-height: 82px !important; gap: 10px !important; } #levelsGrid .u-index { width: 42px !important; height: 42px !important; font-size: 15px !important; } #levelsGrid .u-title { font-size: 22px !important; } #levelsGrid .u-price { font-size: 13px !important; } #tv_chart { grid-column: 2; grid-row: 2 / 4; width: 100% !important; height: 100% !important; margin: 0 !important; } .chart-wrapper { height: 100% !important; margin: 0 !important; } #dashMain { grid-column: 2; grid-row: 4 / 6; margin: 0; padding: 8px !important; overflow-y: auto; } #dashMain .dashboard-card { padding: 8px !important; margin: 0 0 6px 0 !important; } #dashMain .stat-box-unified { min-height: 48px !important; padding: 4px 3px !important; } #radarTickerContainer { grid-column: 3; grid-row: 2; margin: 0; padding: 8px 6px !important; min-height: auto !important; overflow: hidden; } #radarTickerContainer .radar-ticker-large { min-height: 115px !important; padding: 10px 12px !important; } #desktop-etf-list { display: flex !important; flex-direction: column; grid-column: 3; grid-row: 3 / 6; gap: 4px; overflow-y: auto; overflow-x: hidden; padding-right: 4px; margin: 0; } #desktop-etf-list::-webkit-scrollbar { width: 5px; } #desktop-etf-list::-webkit-scrollbar-thumb { background: var(--border-strong); border-radius: 3px; } #etfMonitorToggleBtn { display: none !important; } #desktop-etf-list .unified-card { padding: 10px !important; min-height: 88px !important; margin: 0; display: grid; grid-template-columns: 38px 1fr auto; gap: 10px; align-items: center; opacity: 0.9; font-size: 14px; } #desktop-etf-list .u-title { font-size: 18px !important; font-weight: 800; margin-bottom: 2px; } #desktop-etf-list .u-price { font-size: 13px !important; } 
            /* Ocultar sistema de paneles en desktop */
            .panels-wrapper { display: none !important; }
            .panel-indicators { display: none !important; }
            .panel-toggle-btn { display: none; }
        }

        @media (min-width: 1024px) { .content-spacer { max-width: 100%; padding: 12px; } }
        
        /* Modal de Confirmación Personalizado */
        #customConfirmModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            z-index: 10000;
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
        }
        #customConfirmModal.show {
            display: flex;
        }
        .confirm-dialog {
            background: var(--surface);
            border: 2px solid var(--border-strong);
            border-radius: 16px;
            padding: 16px;
            max-width: 280px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            animation: modal-pop 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes modal-pop {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .confirm-title {
            font-family: var(--font-head);
            font-size: 16px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 8px;
            text-align: center;
        }
        .confirm-message {
            font-family: var(--font-num);
            font-size: 20px;
            font-weight: 800;
            color: var(--brand);
            text-align: center;
            margin-bottom: 16px;
        }
        .confirm-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        .confirm-btn {
            padding: 10px;
            border-radius: 10px;
            font-family: var(--font-head);
            font-size: 13px;
            font-weight: 800;
            border: 2px solid;
            cursor: pointer;
            transition: all 0.2s;
        }
        .confirm-btn:active {
            transform: scale(0.95);
        }
        .confirm-btn-cancel {
            background: transparent;
            border-color: var(--border-strong);
            color: var(--text-secondary);
        }
        .confirm-btn-accept {
            background: var(--brand);
            border-color: var(--brand);
            color: #fff;
        }
        
        /* NUEVOS PANELES LATERALES TIPO WHATSAPP */
        
        /* Numeración de Panel */
        .panel-number { display: none; }
        
        /* Panel vacío placeholder */
        .empty-panel-placeholder {
            min-height: 60vh;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 12px;
            opacity: 0.5;
        }
        
        .empty-panel-text {
            font-family: var(--font-head);
            font-size: 14px;
            color: var(--text-tertiary);
            text-align: center;
        }
        
        .empty-panel-icon {
            width: 48px;
            height: 48px;
            border: 2px dashed var(--border);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-tertiary);
        }

        /* ═══════════════════════════════════════════════════════════
           ☁️  SECCIÓN CUENTA & SINCRONIZACIÓN EN LA NUBE — C5X Cloud
        ═══════════════════════════════════════════════════════════ */
        .cloud-hero { display:flex; flex-direction:column; align-items:center; gap:14px; padding:24px 16px 16px; }
        .cloud-icon-wrap { width:68px; height:68px; border-radius:50%; background:linear-gradient(135deg,var(--brand),#8b5cf6); display:flex; align-items:center; justify-content:center; font-size:30px; box-shadow:0 4px 24px rgba(59,130,246,0.35); }
        .cloud-hero-title { font-family:var(--font-head); font-size:15px; font-weight:900; color:var(--text-primary); letter-spacing:1px; text-align:center; }
        .cloud-hero-sub { font-family:var(--font-head); font-size:10px; color:var(--text-tertiary); text-align:center; line-height:1.8; letter-spacing:0.3px; }
        .btn-google-signin { display:flex; align-items:center; justify-content:center; gap:10px; width:100%; max-width:280px; background:#fff; color:#3c4043; border:1.5px solid #dadce0; border-radius:24px; padding:12px 20px; font-family:var(--font-head); font-size:12px; font-weight:700; cursor:pointer; box-shadow:0 2px 10px rgba(0,0,0,0.12); transition:all 0.2s; letter-spacing:0.4px; }
        .btn-google-signin:active { transform:scale(0.96); box-shadow:0 1px 4px rgba(0,0,0,0.1); }
        body.light-mode .btn-google-signin { background:#f8f9fa; }
        .cloud-card { background:var(--surface); border:1px solid var(--border); border-radius:16px; padding:14px; }
        .cloud-user-row { display:flex; align-items:center; gap:12px; padding-bottom:12px; border-bottom:1px solid var(--border); margin-bottom:12px; }
        .cloud-avatar { width:48px; height:48px; border-radius:50%; background:linear-gradient(135deg,var(--brand),#8b5cf6); display:flex; align-items:center; justify-content:center; font-size:22px; flex-shrink:0; overflow:hidden; border:2px solid var(--border); }
        .cloud-avatar img { width:100%; height:100%; object-fit:cover; border-radius:50%; }
        .cloud-user-info { flex:1; min-width:0; }
        .cloud-user-name { font-family:var(--font-head); font-size:13px; font-weight:800; color:var(--text-primary); display:flex; align-items:center; gap:6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .cloud-user-email { font-family:var(--font-num); font-size:10px; color:var(--text-tertiary); margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        /* ── MURO DE AUTENTICACIÓN ───────────────────────────────── */
        #authWall {
            position: fixed; inset: 0; z-index: 99999;
            background: var(--bg);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            padding: 32px 24px; text-align: center;
            transition: opacity 0.4s ease;
        }
        #authWall.hiding { opacity: 0; pointer-events: none; }
        #authWall.hidden { display: none !important; }
        .auth-wall-logo {
            font-family: var(--font-head); font-size: 48px; font-weight: 900;
            color: var(--brand); letter-spacing: 4px; margin-bottom: 8px;
        }
        .auth-wall-sub {
            font-family: var(--font-head); font-size: 10px; font-weight: 700;
            color: var(--text-tertiary); letter-spacing: 2px; margin-bottom: 48px;
        }
        .auth-wall-card {
            width: 100%; max-width: 320px;
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 20px; padding: 28px 20px;
        }
        .auth-wall-title {
            font-family: var(--font-head); font-size: 13px; font-weight: 900;
            color: var(--text-primary); letter-spacing: 1px; margin-bottom: 6px;
        }
        .auth-wall-desc {
            font-family: var(--font-head); font-size: 10px;
            color: var(--text-tertiary); line-height: 1.7; margin-bottom: 24px;
        }
        .btn-google-wall {
            width: 100%; padding: 14px 16px;
            background: var(--brand); color: #fff;
            border: none; border-radius: 14px;
            font-family: var(--font-head); font-size: 12px; font-weight: 900;
            letter-spacing: 1px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: opacity 0.2s;
        }
        .btn-google-wall:active { opacity: 0.8; }
        .auth-wall-checking {
            font-family: var(--font-head); font-size: 10px;
            color: var(--text-tertiary); margin-top: 16px;
            letter-spacing: 1px; animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
        .auth-wall-version {
            position: absolute; bottom: 20px;
            font-family: var(--font-head); font-size: 9px;
            color: var(--text-tertiary); letter-spacing: 1px;
        }

        /* Secciones solo visibles para el admin */
        .admin-only { display: none !important; }
        .admin-only.visible { display: block !important; }

        .admin-only-grid { display: none !important; }
        .admin-only-grid.visible { display: grid !important; }

        .admin-section-wrapper { display: none !important; }
        .admin-section-wrapper.visible { display: contents !important; }

        .cloud-admin-badge { background:linear-gradient(135deg,rgba(245,158,11,0.2),rgba(245,158,11,0.05)); border:1px solid rgba(245,158,11,0.4); border-radius:10px; padding:2px 7px; font-family:var(--font-head); font-size:8px; font-weight:900; color:var(--warning); letter-spacing:0.5px; flex-shrink:0; }
        .cloud-sync-pill { display:inline-flex; align-items:center; gap:5px; padding:4px 10px; border-radius:20px; font-family:var(--font-head); font-size:9px; font-weight:700; letter-spacing:0.5px; border:1px solid; transition:all 0.3s; }
        .cloud-sync-pill.synced { background:rgba(16,185,129,0.1); color:var(--long); border-color:rgba(16,185,129,0.3); }
        .cloud-sync-pill.syncing { background:rgba(59,130,246,0.1); color:var(--brand); border-color:rgba(59,130,246,0.3); }
        .cloud-sync-pill.offline { background:rgba(107,114,128,0.1); color:var(--text-tertiary); border-color:var(--border); }
        .cloud-sync-pill.error { background:rgba(239,68,68,0.1); color:var(--short); border-color:rgba(239,68,68,0.3); }
        .cloud-sync-dot { width:6px; height:6px; border-radius:50%; flex-shrink:0; }
        .synced .cloud-sync-dot { background:var(--long); animation:cloud-blink 2.5s infinite; }
        .syncing .cloud-sync-dot { background:var(--brand); animation:cloud-blink 0.8s infinite; }
        .offline .cloud-sync-dot { background:var(--text-tertiary); }
        .error .cloud-sync-dot { background:var(--short); }
        @keyframes cloud-blink { 0%,100%{opacity:1} 50%{opacity:0.3} }
        .cloud-stats { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:10px; }
        .cloud-stat { background:rgba(0,0,0,0.12); border-radius:10px; padding:8px 10px; text-align:center; }
        .cloud-stat-lbl { font-family:var(--font-head); font-size:8px; font-weight:700; color:var(--text-tertiary); letter-spacing:0.8px; display:block; margin-bottom:3px; }
        .cloud-stat-val { font-family:var(--font-num); font-size:13px; font-weight:800; color:var(--text-primary); }
        .cloud-actions { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
        .cloud-btn { padding:10px 8px; border-radius:12px; border:1px solid var(--border); background:var(--bg); color:var(--text-primary); font-family:var(--font-head); font-size:10px; font-weight:700; cursor:pointer; text-align:center; transition:all 0.2s; letter-spacing:0.3px; display:flex; align-items:center; justify-content:center; gap:5px; }
        .cloud-btn:active { transform:scale(0.96); }
        .cloud-btn:disabled { opacity:0.38; cursor:not-allowed; }
        .cloud-btn.primary { color:var(--brand); border-color:rgba(59,130,246,0.35); background:rgba(59,130,246,0.06); }
        .cloud-btn.success { color:var(--long); border-color:rgba(16,185,129,0.35); background:rgba(16,185,129,0.06); }
        .cloud-btn.warn { color:var(--warning); border-color:rgba(245,158,11,0.35); background:rgba(245,158,11,0.06); }
        .cloud-btn.danger { color:var(--short); border-color:rgba(239,68,68,0.3); }
        .cloud-last-sync { font-family:var(--font-num); font-size:9px; color:var(--text-tertiary); text-align:center; margin-top:8px; }
        .fb-config-card { background:var(--surface); border:1px solid rgba(245,158,11,0.3); border-radius:16px; padding:14px; margin-top:8px; }
        .fb-config-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
        .fb-cfg-inp { width:100%; background:rgba(0,0,0,0.15); border:1px solid var(--border); border-radius:8px; padding:8px 10px; color:var(--text-primary); font-family:var(--font-num); font-size:11px; outline:none; transition:border-color 0.2s; margin-bottom:7px; box-sizing:border-box; }
        .fb-cfg-inp:focus { border-color:var(--brand); }
        .fb-cfg-lbl { font-family:var(--font-head); font-size:8px; font-weight:700; color:var(--text-tertiary); letter-spacing:0.8px; display:block; margin-bottom:4px; }
        .cloud-info-tip { background:rgba(59,130,246,0.06); border:1px solid rgba(59,130,246,0.2); border-radius:10px; padding:10px 12px; font-family:var(--font-head); font-size:10px; color:var(--text-secondary); line-height:1.7; margin-top:8px; }
        .cloud-info-tip strong { color:var(--brand); }
        .cloud-not-configured { display:flex; flex-direction:column; align-items:center; gap:10px; padding:18px 12px; text-align:center; }
        .cloud-not-configured p { font-family:var(--font-head); font-size:10px; color:var(--text-tertiary); line-height:1.7; }
    </style>
</head>
<body onload="init()">
    <!-- Modal de Confirmación Personalizado -->
    <div id="customConfirmModal">
        <div class="confirm-dialog">
            <div class="confirm-title" id="confirmTitle">¿Comprar nivel?</div>
            <div class="confirm-message" id="confirmMessage">$0.00 USDT</div>
            <div class="confirm-buttons">
                <button class="confirm-btn confirm-btn-cancel" onclick="closeConfirmModal(false)">Cancelar</button>
                <button class="confirm-btn confirm-btn-accept" onclick="closeConfirmModal(true)">Aceptar</button>
            </div>
        </div>
    </div>

    <audio id="alertSound" preload="auto" src="data:audio/wav;base64,UklGRl9vT1BXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"></audio>
    <div id="toast">Notificación</div>
    
    <!-- Botón flotante para ir al Monitor ETF (solo visible en sección OPERAR) -->
    <div class="etf-float-btn anim-click" id="etfFloatBtn" onclick="goToETFMonitor()" title="Ir a Monitor ETF">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
    </div>
    <div id="navModal" onclick="if(event.target===this) closeMenuViaButton()">
        <div class="nav-content section-enter">
            <div class="nav-title">MENÚ C5X</div>
            <div class="nav-item anim-click" id="nav-etf" onclick="switchView('etf')"><div class="nav-icon anim-pulse"><svg width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg></div><div class="nav-text">MONITOR ETF</div></div>
            <div class="nav-item anim-click" id="nav-log" onclick="switchView('log')"><div class="nav-icon"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg></div><div class="nav-text">BITÁCORA</div></div>
            <div class="nav-item anim-click" id="nav-settings" onclick="switchView('settings')"><div class="nav-icon anim-spin"><svg width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></div><div class="nav-text">AJUSTES</div></div>
            <button class="btn-close-menu anim-click" onclick="closeMenuViaButton()"><svg width="18" height="18" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg> CERRAR MENÚ</button>
        </div>
    </div>
    <div class="fixed-header">
        <header class="app-header">
            <div class="brand-btn"><span class="brand-text">C5X</span></div>
            
            <!-- TICKER: entre C5X y el botón tema, siempre visible -->
            <div class="ticker-container" id="tickerContainer">
                <div class="ticker-pill anim-click" id="mainTickerPill" onclick="viewTickerChart(event)" ontouchstart="handleTickerTouchStart(event)" ontouchend="handleTickerTouchEnd(event)" onmousedown="handleTickerMouseDown(event)" onmouseup="handleTickerMouseUp(event)" onmouseleave="cancelTickerPress()">
                    <div class="ticker-group-left"><div class="ticker-dot" id="t-dot"></div><span class="ticker-sym" id="t-sym">BTC</span></div>
                    <div class="ticker-group-right"><span class="ticker-price" id="t-price"><span class="skeleton-text skeleton-box"></span></span><span class="ticker-pct" id="t-pct">--%</span></div>
                </div>
            </div>
            
            <!-- Display USDT (paneles 2 y 3) -->
            <div class="ticker-container" id="usdtContainer" style="display: none;">
                <div class="usdt-display">
                    <span class="usdt-label">USDT</span>
                    <span class="usdt-amount" id="usdtAvailable">1,000</span>
                </div>
            </div>
            
            <div class="user-menu-wrapper" id="userMenuWrapper">
                <div class="user-btn anim-click" onclick="toggleUserMenu()" title="Menú usuario" id="userAvatarBtn">
                    <span id="userAvatarEmoji">👤</span>
                </div>
                <div class="user-dropdown" id="userDropdown">

                    <!-- 1. C5X + Tema -->
                    <div class="user-drop-row1">
                        <span class="user-drop-c5x">C5X</span>
                        <div class="user-drop-theme-toggle anim-click" onclick="toggleTheme(); updateThemeIcon();" id="themeToggleBtn">
                            <span id="themeHint">🌙</span>
                            <span class="user-drop-theme-label" id="themeLabel">OSCURO</span>
                        </div>
                    </div>

                    <!-- 2. Cuenta Google -->
                    <div class="user-drop-item user-drop-account" id="googleAccountRow" onclick="handleGoogleAccount()">
                        <div class="user-drop-google-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                                <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                                <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" fill="#FBBC05"/>
                                <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                            </svg>
                        </div>
                        <div class="user-drop-account-info">
                            <span class="user-drop-account-label" id="googleLabel">CUENTA</span>
                            <span class="user-drop-account-sub" id="googleSub">Conectar con Google</span>
                        </div>
                        <div class="user-drop-account-status" id="googleStatus">
                            <svg width="12" height="12" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        </div>
                    </div>

                    <!-- 3. Monitor ETF -->
                    <div class="user-drop-item" onclick="closeUserMenu(); switchView('etf');">
                        <svg width="15" height="15" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>
                        MONITOR ETF
                    </div>

                    <!-- 4. Bitácora -->
                    <div class="user-drop-item" onclick="closeUserMenu(); switchView('log');">
                        <svg width="15" height="15" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>
                        BITÁCORA
                    </div>

                    <!-- 5. Chat Soporte -->
                    <div class="user-drop-item" id="chatSoporteMenuItem" onclick="closeUserMenu(); switchView('chat');">
                        <svg width="15" height="15" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                        SOPORTE
                        <span id="chatBadge" style="display:none; margin-left:auto; background:var(--short); color:#fff; border-radius:10px; padding:1px 7px; font-size:9px; font-weight:900; min-width:18px; text-align:center;">0</span>
                    </div>

                    <!-- 6. Ajustes -->
                    <div class="user-drop-item" onclick="closeUserMenu(); switchView('settings');">
                        <svg width="15" height="15" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                        AJUSTES
                    </div>

                </div>
            </div>
        </header>
    </div>
    <!-- ═══ MURO DE AUTENTICACIÓN — bloquea toda la app ═══ -->
    <div id="authWall">
        <div class="auth-wall-logo">C5X</div>
        <div class="auth-wall-sub">TRADING PRIVADO</div>
        <div class="auth-wall-card">
            <div class="auth-wall-title">🔒 ACCESO PRIVADO</div>
            <div class="auth-wall-desc" id="authWallDesc">
                Esta aplicación es de uso privado.<br>
                Inicia sesión con tu cuenta Google autorizada.
            </div>
            <button class="btn-google-wall anim-click" id="authWallBtn" onclick="loginWithGoogle()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" fill="#FBBC05"/>
                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                </svg>
                CONTINUAR CON GOOGLE
            </button>
            <div class="auth-wall-checking" id="authWallStatus" style="display:none;">
                ⏳ VERIFICANDO ACCESO...
            </div>
        </div>
        <div class="auth-wall-version">C5X V25.31</div>
    </div>
    <!-- ════════════════════════════════════════════════ -->

    <div class="content-spacer">
        <div id="section-operate" class="app-section active">
            <!-- Sistema de 3 Paneles Deslizables -->
            <div class="panels-wrapper">
                <div class="panels-container" id="panelsContainer" data-active="0">
                    
                    <!-- PANEL 0 (DEFAULT): CHART + RADAR + GATE.IO -->
                    <div class="panel" id="panel1">
                        <div class="panel-number">1</div>
                        <div class="panel-content" style="padding: 4px; overflow-y: auto;">
                            <!-- Temporalidades -->
                            <div class="tf-bar" id="tfBarContainer">
                                <button class="tf-btn anim-click" data-tf="15" onclick="updateTF('15', this)">15M</button><button class="tf-btn anim-click" data-tf="30" onclick="updateTF('30', this)">30M</button><button class="tf-btn anim-click" data-tf="60" onclick="updateTF('60', this)">1H</button><button class="tf-btn anim-click" data-tf="240" onclick="updateTF('240', this)">4H</button><button class="tf-btn anim-click" data-tf="D" onclick="updateTF('D', this)">1D</button>
                            </div>
                            <!-- Chart de Velas -->
                            <div id="tv_chart" class="chart-wrapper" style="margin: 6px 4px;">
                                <div id="priceLinesOverlay" class="price-lines-overlay"></div>
                                <div class="chart-fs-btn anim-click" onclick="toggleFullscreenChart(event)">
                                    <svg width="18" height="18" viewBox="0 0 24 24"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>
                                </div>
                            </div>
                            <!-- Radar -->
                            <div style="padding: 0 4px 8px 4px;">
                                <div id="radarTickerContainer" class="radar-ticker-large anim-pulse">
                                    <div id="radarStatus" class="radar-status-dot offline"></div>
                                    <div class="radar-header-line">
                                        <div class="radar-title-compact" onclick="switchView('etf'); event.stopPropagation();" style="cursor: pointer;">
                                            <svg width="16" height="16" viewBox="0 0 24 24"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>
                                            RADAR
                                        </div>
                                        <div id="radarValue" class="radar-token-centered"><span class="skeleton-text skeleton-box" style="width:80px; height:18px;"></span></div>
                                        <div class="radar-balance-compact" id="totalBalanceDisplay">$0.00</div>
                                    </div>
                                </div>
                                <div id="desktop-etf-list"></div>
                            </div>

                            <!-- ── GATE.IO COMMAND DASHBOARD ── -->
                            <div style="padding: 0 4px 80px 4px;">

                                <!-- HEADER DE CONEXIÓN -->
                                <div class="gd-header">
                                    <div style="display:flex; align-items:center; gap:8px;">
                                        <div class="gd-conn-dot" id="gdConnDot"></div>
                                        <span class="gd-brand">GATE.IO</span>
                                        <span class="gd-conn-label" id="gdConnLabel">DESCONECTADO</span>
                                    </div>
                                    <div style="display:flex; align-items:center; gap:8px;">
                                        <span class="gd-update-time" id="gdUpdateTime">--:--:--</span>
                                        <button class="gd-refresh-btn anim-click" onclick="refreshGateDashboard()">
                                            <svg width="14" height="14" viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
                                        </button>
                                    </div>
                                </div>

                                <!-- MÉTRICAS PRINCIPALES -->
                                <div class="gd-metrics-grid">
                                    <div class="gd-metric-card">
                                        <span class="gd-metric-label">TOTAL WALLET</span>
                                        <span class="gd-metric-value" id="gdTotal">$0.00</span>
                                        <span class="gd-metric-sub" id="gdTotalBTC">≈ 0.000 BTC</span>
                                    </div>
                                    <div class="gd-metric-card">
                                        <span class="gd-metric-label">USDT LIBRE</span>
                                        <span class="gd-metric-value" style="color:var(--long)" id="gdLibre">$0.00</span>
                                        <span class="gd-metric-sub" id="gdLibrePct">0% disponible</span>
                                    </div>
                                    <div class="gd-metric-card">
                                        <span class="gd-metric-label">EN OPERACIÓN</span>
                                        <span class="gd-metric-value" style="color:var(--warning)" id="gdEnUso">$0.00</span>
                                        <span class="gd-metric-sub" id="gdSlotCount">0 slots activos</span>
                                    </div>
                                </div>

                                <!-- PNL HOY · PNL TOTAL · MERCADO LIVE -->
                                <div class="gd-metrics-grid">
                                    <div class="gd-metric-card">
                                        <span class="gd-metric-label">PNL HOY</span>
                                        <span class="gd-metric-value" id="gdPnlHoy">$0.00</span>
                                        <span class="gd-metric-sub">sesión actual</span>
                                    </div>
                                    <div class="gd-metric-card">
                                        <span class="gd-metric-label">PNL TOTAL</span>
                                        <span class="gd-metric-value" id="gdPnlTotal">$0.00</span>
                                        <span class="gd-metric-sub">acumulado</span>
                                    </div>
                                    <div class="gd-metric-card" id="gdMarketCard" style="cursor:pointer;" onclick="gdJumpToNext()">
                                        <span class="gd-metric-label" style="display:flex;align-items:center;gap:5px;">
                                            <span id="gdMcSym">BTC</span>
                                            <span class="gd-live-dot"></span>
                                        </span>
                                        <span class="gd-metric-value" id="gdMcPrice">$0.00</span>
                                        <span class="gd-mc-change" id="gdMcChange" style="align-self:center;">0.00%</span>
                                        <div class="gd-mc-progress" id="gdMcProgress"></div>
                                    </div>
                                </div>

                                <!-- PORTAFOLIO C5X — barra rotatoria -->
                                <div class="gd-portfolio-bar">
                                    <span class="gd-dual-label">PORTAFOLIO C5X</span>
                                    <div class="gd-dual-scroll-wrap">
                                        <div class="gd-dual-track" id="gdPortfolioTrack"></div>
                                    </div>
                                    <div class="gd-dual-dots" id="gdPortfolioDots"></div>
                                </div>

                            </div>
                        </div>
                    </div>
                    
                    <!-- PANEL 1: 5 DASHBOARDS DE TRADING -->
                    <div class="panel" id="panel0">
                        <div class="panel-number">2</div>
                        <!-- Inputs ocultos requeridos por JS -->
                        <input type="text" id="coinInput" style="display: none;" readonly>
                        <input type="number" id="capitalInput" style="display: none;">
                        <input type="number" id="baseInput" style="display: none;">
                        <!-- Indicador de ajuste automático de precio -->
                        <div id="priceAdjustIndicator" style="display:none; position:fixed; bottom:calc(72px + var(--safe-bottom)); right:10px; background:rgba(245,158,11,0.15); border:1px solid var(--warning); border-radius:8px; padding:4px 8px; font-size:9px; font-family:var(--font-head); color:var(--warning); z-index:100;">📉 PRECIO AJUSTADO</div>
                        <div class="panel-content" style="padding: 4px; overflow-y: auto;">
                            <div id="dashboardsContainer"></div>
                        </div>
                    </div>
                    
                    <!-- PANEL 2: CHART SECUNDARIO + 12 NIVELES -->
                    <div class="panel" id="panel5">
                        <div class="panel-number">3</div>
                        <div class="panel-content" style="padding: 4px;">
                            <!-- Temporalidades del Chart Secundario -->
                            <div class="tf-bar" id="tfBarContainer2">
                                <button class="tf-btn anim-click" data-tf="15" onclick="updateTF('15', this)">15M</button><button class="tf-btn anim-click" data-tf="30" onclick="updateTF('30', this)">30M</button><button class="tf-btn anim-click" data-tf="60" onclick="updateTF('60', this)">1H</button><button class="tf-btn anim-click" data-tf="240" onclick="updateTF('240', this)">4H</button><button class="tf-btn anim-click" data-tf="D" onclick="updateTF('D', this)">1D</button>
                            </div>
                            <div id="tv_chart2" class="chart-wrapper">
                                <div id="priceLinesOverlay2" class="price-lines-overlay"></div>
                                <div class="chart-fs-btn anim-click" onclick="toggleFullscreenChart2(event)">
                                    <svg width="18" height="18" viewBox="0 0 24 24"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>
                                </div>
                            </div>
                            <!-- 12 NIVELES DE TRADING - siempre visibles debajo del chart -->
                            <main id="levelsGrid" class="levels-container"></main>
                        </div>
                    </div>
                    
                </div>
            </div>
            
            <!-- Indicadores de panel (3 paneles) -->
            <div class="panel-indicators" id="panelIndicators">
                <div class="panel-dot active"></div>
                <div class="panel-dot"></div>
                <div class="panel-dot"></div>
            </div>
        </div>
        <div id="section-etf" class="app-section"><div class="etf-search-box"><span class="etf-search-icon"><svg width="16" height="16" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></span><input type="text" class="etf-search-input" id="etfSearchInput" placeholder="BUSCAR TOKEN (Ej: BTC, SUI)" oninput="filterETFs(this.value)" onfocus="this.select()"></div><div id="etfGrid" class="levels-container"></div></div>
        <div id="section-log" class="app-section">
            <div class="log-header-bar">
                <div class="log-title">BITÁCORA</div>
                <div class="log-actions">
                    <button class="action-btn anim-click" onclick="exportPDF()"><svg width="14" height="14" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg> REPORTE</button>
                    <button class="action-btn anim-click" onclick="triggerDriveBackup()"><svg width="14" height="14" viewBox="0 0 24 24"><path d="M19 18a3.5 3.5 0 0 0 0-7h-1A5 4.5 0 0 0 8 9a4.5 4.5 0 0 0-4.5 4.5c0 .4.04.79.12 1.16"></path></svg> RESPALDO</button>
                    <button class="action-btn anim-click" style="color:var(--danger); border-color:var(--danger)" onclick="clearLogs()"><svg width="14" height="14" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2-2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg> BORRAR</button>
                </div>
            </div>
            <div class="stats-card anim-click">
                <div class="stats-header"><div class="stats-title">RENDIMIENTO</div><div class="stats-toggles"><button class="stat-btn active" onclick="updateStats('D')">1D</button><button class="stat-btn" onclick="updateStats('W')">1S</button><button class="stat-btn" onclick="updateStats('M')">1M</button><button class="stat-btn" onclick="updateStats('A')">TODO</button></div></div>
                <div class="chart-box" id="pnlChart"></div>
                <div class="stats-summary"><div><span class="sum-label">NETO (FEES INC.)</span><span class="sum-val" id="chartNeto">$0.00</span></div><div><span class="sum-label">WIN RATE</span><span class="sum-val" id="chartWr">0%</span></div></div>
            </div>
            <div id="logGrid" class="levels-container"></div>
        </div>
        <div id="section-settings" class="app-section">
            <div class="setting-section-title"><svg width="14" height="14" viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg> API & TRADING (GATE.IO)</div>
            <div class="settings-grid">
                <div class="setting-card-item">
                    <div class="input-row-save" style="margin-bottom:10px; justify-content:space-between;"><span class="setting-label">CREDENCIALES API</span><button class="btn-save-mini anim-click" onclick="saveApiKeysSecure()"><svg width="18" height="18" viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg></button></div>
                    <div style="display:flex; flex-direction:column; gap:10px"><input type="password" class="setting-input" id="apiKey" placeholder="API KEY (KEY)" style="border-bottom:1px solid var(--border)"><input type="password" class="setting-input" id="apiSecret" placeholder="API SECRET (SECRET)"></div>
                </div>
                <div class="setting-card-item">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;"><span class="setting-label">🔧 DIAGNÓSTICO</span><button class="btn-save-mini anim-click" onclick="testApiConnection()" style="background:var(--brand); color:#fff;">PROBAR</button></div>
                    <div id="apiTestResult" style="font-size:11px; color:var(--text-tertiary); padding:8px; background:rgba(0,0,0,0.2); border-radius:8px; font-family:monospace; max-height:120px; overflow-y:auto;">Presiona PROBAR para verificar conexión</div>
                </div>
            </div>
            <div class="setting-section-title admin-only" style="border-left:3px solid var(--brand); padding-left:8px;"><svg width="14" height="14" viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg> CAPITAL & RENDIMIENTO <span style="font-size:8px; color:var(--brand); margin-left:4px;">★ ADMIN</span></div>
            <div class="settings-grid admin-only-grid">
                <div class="setting-card-item">
                    <div class="input-row-save" style="margin-bottom:10px;"><span class="setting-label" style="flex:1">CAPITAL TOTAL BASE ($)</span><button class="btn-save-mini anim-click" onclick="saveGlobalCapSecure()"><svg width="18" height="18" viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg></button></div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px"><input type="number" class="setting-input" id="setGlobalCapital" placeholder="0.00" style="border-bottom:1px solid var(--border)"><div><label class="setting-label">COMISIÓN EXCHANGE (%)</label><input type="number" class="setting-input" id="setFee" placeholder="0.1" step="0.01"></div></div>
                </div>
                <div class="setting-card-item"><label class="setting-label">GANANCIA MES ACTUAL</label><div id="monthlyProfitDisplay" style="font-family:var(--font-num); font-size:16px; font-weight:800; color:var(--text-primary);">$0.00 <span style="font-size:12px; color:var(--text-tertiary)">(0%)</span></div></div>
            </div>
            <div class="setting-section-title admin-only" style="border-left:3px solid var(--brand); padding-left:8px;"><svg width="14" height="14" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg> ESTRATEGIA Y GESTIÓN <span style="font-size:8px; color:var(--brand); margin-left:4px;">★ ADMIN</span></div>
            <div class="settings-grid admin-only-grid">
                <div class="setting-card-item">
                    <div class="input-row-save" style="margin-bottom:10px; justify-content:space-between;"><span class="setting-label" style="color:var(--brand);">⚡ ESTRATEGIA NORMAL</span><button class="btn-save-mini anim-click" onclick="saveStrategyParams('normal')"><svg width="18" height="18" viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg></button></div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"><div><label class="setting-label">CAPITAL ($)</label><input type="number" class="setting-input" id="setCapitalNormal" value="5"></div><div><label class="setting-label">ROI (%)</label><input type="number" class="setting-input" id="setRoiNormal" value="100"></div><div><label class="setting-label">NIVEL 2+ (%)</label><input type="number" class="setting-input" id="setIncNormal" value="7"></div><div><label class="setting-label">NIVEL 1 (%)</label><input type="number" class="setting-input" id="setDescNormal" value="17"></div><div><label class="setting-label">DD MAX (%)</label><input type="number" class="setting-input" id="setDDNormal" value="17"></div></div>
                </div>

            </div>
            <div class="bot-section admin-only">
                <div class="bot-header"><div class="bot-title"><span>🤖</span><span>BOT AUTOMÁTICO</span></div><label class="bot-toggle"><input type="checkbox" id="botEnabled" onchange="toggleBot()"><span class="bot-slider"></span></label></div>
                <div class="bot-status inactive" id="botStatus"><span>⚫</span><span id="botStatusText">Bot desactivado</span></div>
                <div class="bot-param-grid">
                    <div class="bot-param"><label class="bot-param-label">Ganancia (%)</label><input type="number" class="bot-param-input" id="botNormalProfit" value="100" min="10" max="500" step="10" onchange="saveBotConfig()"></div>
                    <div class="bot-param"><label class="bot-param-label">Trailing Stop (%)</label><input type="number" class="bot-param-input" id="botTrailingStop" value="10" min="1" max="50" step="1" onchange="saveBotConfig()"></div>
                    <div class="bot-param"><label class="bot-param-label">Intervalo Check (seg)</label><input type="number" class="bot-param-input" id="botCheckInterval" value="30" min="10" max="300" step="10" onchange="saveBotConfig()"></div>
                </div>
                <div class="bot-info">ℹ️ <strong>Optimizaciones:</strong><br>• Solo funciona en <strong>modo automático</strong> con conexión a Gate.io</div>
            </div>
            <div class="setting-section-title admin-only" style="border-left:3px solid var(--brand); padding-left:8px;"><svg width="14" height="14" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg> AJUSTES AVANZADOS <span style="font-size:8px; color:var(--brand); margin-left:4px;">★ ADMIN</span></div>
            <div class="settings-grid admin-only-grid">
                <div class="setting-card-item">
                     <div class="input-row-save" style="justify-content:space-between; margin-bottom:10px; border-bottom:1px solid var(--border); padding-bottom:8px;"><span class="setting-label">RADAR & MONITOR</span><button class="btn-save-mini anim-click" onclick="saveRadarSecure()"><svg width="18" height="18" viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg></button></div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;"><div><label class="setting-label" style="display:block; margin-bottom:4px;">ITEMS RADAR</label><input type="number" class="setting-input" id="setRadarLimit" placeholder="12" style="background:rgba(0,0,0,0.2); border-radius:8px; padding:6px; text-align:center;"></div><div><label class="setting-label" style="display:block; margin-bottom:4px;">ITEMS MONITOR</label><input type="number" class="setting-input" id="setMonitorLimit" placeholder="20" style="background:rgba(0,0,0,0.2); border-radius:8px; padding:6px; text-align:center;"></div><div><label class="setting-label" style="display:block; margin-bottom:4px;">VEL. RADAR (s)</label><input type="number" class="setting-input" id="setRadarSpeed" placeholder="3" style="background:rgba(0,0,0,0.2); border-radius:8px; padding:6px; text-align:center;"></div><div><label class="setting-label" style="display:block; margin-bottom:4px;">VEL. TICKER (s)</label><input type="number" class="setting-input" id="setTickerSpeed" placeholder="7" style="background:rgba(0,0,0,0.2); border-radius:8px; padding:6px; text-align:center;"></div><div><label class="setting-label" style="display:block; margin-bottom:4px;">📉 AJUSTE AUTO (%)</label><input type="number" class="setting-input" id="setAutoAdjustThreshold" placeholder="3" step="0.5" style="background:rgba(0,0,0,0.2); border-radius:8px; padding:6px; text-align:center;"></div></div>
                </div>
                <div class="setting-card-item">
                    <div class="input-row-save" style="justify-content:space-between; margin-bottom:5px;"><span class="setting-label">MULTIPLICADORES</span><button class="btn-save-mini anim-click" onclick="saveMultiSecure()"><svg width="18" height="18" viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg></button></div>
                    <div id="multiGrid" class="multi-grid"></div>
                </div>
                <div class="setting-card-item"><label class="setting-label">MONEDAS DEL TICKER</label><div id="tickerChipsContainer" class="multi-grid"></div></div>
            </div>
            <div class="setting-section-title"><svg width="14" height="14" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg> SEGURIDAD</div>
            <div class="settings-grid">
                <div class="setting-card-item"><div class="input-row-save"><div style="flex:1"><label class="setting-label">NUEVA CLAVE</label><input type="password" class="setting-input" id="setNewPass" placeholder="****" maxlength="4" style="letter-spacing:4px;"></div><button class="btn-save-mini anim-click" onclick="savePassSecure()"><svg width="18" height="18" viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg></button></div></div>
            </div>
            <div class="setting-section-title"><svg width="14" height="14" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg> GESTIÓN DE DATOS</div>
            <div class="data-actions"><button class="btn-data anim-click" onclick="exportData()">⬇️ EXPORTAR BACKUP</button><button class="btn-data anim-click" onclick="document.getElementById('importFile').click()">⬆️ IMPORTAR BACKUP</button><input type="file" id="importFile" style="display:none" onchange="importData(this)"></div>
            <button class="btn-reset anim-click admin-only" style="margin-top:15px; border-color:var(--border); color:var(--text-secondary); background:transparent;" onclick="clearLogs()"><svg width="14" height="14" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2-2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg> BORRAR HISTORIAL</button>
            <button class="btn-reset anim-click admin-only" style="margin-top:5px; border-color:var(--border); color:var(--text-secondary); background:transparent;" onclick="clearCrashMemory()"><svg width="14" height="14" viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"></path></svg> RESETEAR ALERTAS CRASH</button>
            <div class="settings-card danger admin-only" style="margin-top:20px; border:1px solid var(--danger); background:rgba(207, 48, 74, 0.05); border-radius:16px; padding:15px;">
                <div class="setting-header" style="color:var(--danger); border-bottom:1px solid rgba(207, 48, 74, 0.3); padding-bottom:10px; margin-bottom:10px; font-weight:800;">⚠️ ZONA CRÍTICA</div>
                <div class="setting-info" style="text-align:center; margin-bottom:10px; font-size:12px; color:var(--text-secondary);"><p>Restablecer la aplicación borrará TODOS los datos.</p></div>
                <button class="btn-reset anim-click" onclick="resetApp()"><svg width="14" height="14" viewBox="0 0 24 24"><path d="M2.5 2v6h6M21.5 22v-6h-6"></path><path d="M22 11.5A10 10 0 0 0 3.2 7.2M2 12.5a10 10 0 0 0 18.8 4.2"></path></svg> RESTABLECER DE FÁBRICA</button>
            </div>
            <!-- ═══════════════════════════════════════════════════════
                 ☁️  CUENTA & SINCRONIZACIÓN EN LA NUBE
            ═══════════════════════════════════════════════════════ -->
            <div class="setting-section-title">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>
                CUENTA &amp; SINCRONIZACIÓN
            </div>

            <!-- ESTADO A: Firebase no configurado → mostrar formulario config -->
            <div id="cloudNeedsConfig" class="fb-config-card" style="display:none;">
                <div class="fb-config-row">
                    <span class="setting-label" style="color:var(--warning);">⚙️ CONFIGURAR FIREBASE</span>
                    <button class="btn-save-mini anim-click" onclick="saveFirebaseConfig()">
                        <svg width="16" height="16" viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/></svg>
                        GUARDAR
                    </button>
                </div>
                <span class="fb-cfg-lbl">API KEY</span>
                <input class="fb-cfg-inp" id="fbCfgApiKey" type="text" placeholder="AIzaSy..." autocomplete="off">
                <span class="fb-cfg-lbl">AUTH DOMAIN</span>
                <input class="fb-cfg-inp" id="fbCfgAuthDomain" type="text" placeholder="miproyecto.firebaseapp.com">
                <span class="fb-cfg-lbl">PROJECT ID</span>
                <input class="fb-cfg-inp" id="fbCfgProjectId" type="text" placeholder="miproyecto-id">
                <span class="fb-cfg-lbl">APP ID</span>
                <input class="fb-cfg-inp" id="fbCfgAppId" type="text" placeholder="1:000000000000:web:abc123">
                <span class="fb-cfg-lbl">MESSAGING SENDER ID</span>
                <input class="fb-cfg-inp" id="fbCfgSenderId" type="text" placeholder="000000000000">
                <div class="cloud-info-tip">
                    <strong>¿Cómo obtener estos datos?</strong><br>
                    Firebase Console → Tu Proyecto → ⚙️ Configuración del proyecto → Tu app web → Objeto <code>firebaseConfig</code>
                </div>
            </div>

            <!-- ESTADO B: Firebase configurado pero NO autenticado → botón login -->
            <div id="cloudNotLoggedIn" class="cloud-card" style="display:none;">
                <div class="cloud-hero">
                    <div class="cloud-icon-wrap">☁️</div>
                    <div class="cloud-hero-title">SINCRONIZA TUS DATOS</div>
                    <div class="cloud-hero-sub">
                        Inicia sesión con Google para que tus slots,<br>
                        estrategia e historial se sincronicen automáticamente<br>
                        y estén disponibles en cualquier dispositivo.
                    </div>
                    <button class="btn-google-signin anim-click" onclick="loginWithGoogle()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                            <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                            <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                            <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" fill="#FBBC05"/>
                            <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                        </svg>
                        CONTINUAR CON GOOGLE
                    </button>
                    <button class="cloud-btn danger" onclick="clearFirebaseConfig()" style="font-size:9px; padding:7px 14px; border-radius:10px; margin-top:4px;">
                        🗑️ BORRAR CONFIGURACIÓN FIREBASE
                    </button>
                </div>
            </div>

            <!-- ESTADO C: Autenticado y sincronizado -->
            <div id="cloudLoggedIn" class="cloud-card" style="display:none;">
                <div class="cloud-user-row">
                    <div class="cloud-avatar" id="cloudAvatar">👤</div>
                    <div class="cloud-user-info">
                        <div class="cloud-user-name">
                            <span id="cloudUserName">---</span>
                            <span class="cloud-admin-badge" id="cloudAdminBadge" style="display:none;">⭐ ADMIN</span>
                        </div>
                        <div class="cloud-user-email" id="cloudUserEmail">---</div>
                    </div>
                    <div id="cloudSyncPill" class="cloud-sync-pill offline">
                        <div class="cloud-sync-dot"></div>
                        <span id="cloudSyncLabel">OFFLINE</span>
                    </div>
                </div>

                <div class="cloud-stats">
                    <div class="cloud-stat">
                        <span class="cloud-stat-lbl">SLOTS ACTIVOS</span>
                        <span class="cloud-stat-val" id="csSlots">0/5</span>
                    </div>
                    <div class="cloud-stat">
                        <span class="cloud-stat-lbl">ÚLTIMO SYNC</span>
                        <span class="cloud-stat-val" id="csLastSync">---</span>
                    </div>
                    <div class="cloud-stat">
                        <span class="cloud-stat-lbl">HISTORIAL</span>
                        <span class="cloud-stat-val" id="csHistory">0</span>
                    </div>
                    <div class="cloud-stat">
                        <span class="cloud-stat-lbl">DISPOSITIVO</span>
                        <span class="cloud-stat-val" id="csDevice">📱</span>
                    </div>
                </div>

                <div class="cloud-actions">
                    <button class="cloud-btn success anim-click" onclick="saveToCloud(true)" id="btnCloudUpload">
                        ⬆️ SUBIR AHORA
                    </button>
                    <button class="cloud-btn primary anim-click" onclick="loadFromCloud(true)" id="btnCloudDownload">
                        ⬇️ RESTAURAR
                    </button>
                    <button class="cloud-btn warn anim-click" onclick="syncApiKeysSecureToCloud()">
                        🔐 SYNC API KEYS
                    </button>
                    <button class="cloud-btn danger anim-click" onclick="logoutGoogle()">
                        ↩️ CERRAR SESIÓN
                    </button>
                </div>
                <div class="cloud-last-sync" id="cloudLastSyncText">Sin sincronización reciente</div>

                <!-- Panel de identidad — solo visible para el admin -->
                <div id="cloudUIDPanel" class="admin-only" style="margin-top:10px; padding:10px; background:rgba(0,0,0,0.1); border:1px solid var(--border); border-radius:10px;">
                    <div style="font-family:var(--font-head); font-size:9px; font-weight:700; color:var(--text-tertiary); letter-spacing:0.8px; margin-bottom:6px;">🔑 TU IDENTIDAD (UID)</div>
                    <div id="adminUIDDisplay" style="font-family:monospace; font-size:9px; color:var(--brand); word-break:break-all; margin-bottom:8px; padding:6px; background:rgba(0,0,0,0.15); border-radius:6px; line-height:1.5;"></div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:6px;">
                        <button class="cloud-btn anim-click" onclick="copyAdminUID()" style="font-size:9px;">📋 COPIAR</button>
                        <button class="cloud-btn warn anim-click" id="btnSetAdmin" onclick="setMeAsAdmin()" style="font-size:9px;">⭐ SER ADMIN</button>
                    </div>
                    <div id="adminStatusText" style="font-family:var(--font-head); font-size:9px; color:var(--text-tertiary); text-align:center; margin-top:6px;"></div>
                </div>

                <!-- Panel Super Admin — gestión de usuarios -->
                <div id="cloudAdminPanel" style="display:none; margin-top:8px; padding:12px; background:rgba(245,158,11,0.06); border:1px solid rgba(245,158,11,0.3); border-radius:12px;">
                    <div style="font-family:var(--font-head); font-size:9px; font-weight:700; color:var(--warning); letter-spacing:0.8px; margin-bottom:10px;">⭐ GESTIÓN DE USUARIOS</div>

                    <!-- Agregar usuario -->
                    <div style="margin-bottom:10px;">
                        <div style="font-family:var(--font-head); font-size:8px; font-weight:700; color:var(--text-tertiary); letter-spacing:0.8px; margin-bottom:5px;">AGREGAR USUARIO</div>
                        <input id="wlInputName" type="text" placeholder="Nombre (opcional)"
                            style="width:100%; background:rgba(0,0,0,0.15); border:1px solid var(--border);
                            border-radius:8px; padding:7px 10px; color:var(--text-primary);
                            font-family:var(--font-head); font-size:11px; outline:none;
                            margin-bottom:5px; box-sizing:border-box;">
                        <div style="position:relative;">
                            <input id="wlInputEmail" type="text" placeholder="email@gmail.com"
                                autocomplete="off" autocorrect="off" autocapitalize="none"
                                style="width:100%; background:rgba(0,0,0,0.15); border:1px solid var(--border);
                                border-radius:8px; padding:7px 32px 7px 10px; color:var(--text-primary);
                                font-family:var(--font-head); font-size:11px; outline:none;
                                margin-bottom:6px; box-sizing:border-box;">
                            <span onclick="document.getElementById('wlInputEmail').value=''; document.getElementById('wlInputEmail').focus();"
                                style="position:absolute; right:8px; top:7px; cursor:pointer; color:var(--text-tertiary); font-size:14px; line-height:1;">✕</span>
                        </div>
                        <button class="cloud-btn success anim-click" style="width:100%; font-size:10px;"
                            onclick="wlAddAndClear()">
                            ✅ DAR ACCESO
                        </button>
                    </div>

                    <!-- Lista de usuarios con acceso -->
                    <div style="font-family:var(--font-head); font-size:8px; font-weight:700; color:var(--text-tertiary); letter-spacing:0.8px; margin-bottom:6px;">
                        USUARIOS CON ACCESO
                        <button onclick="renderWhitelist()" style="float:right; background:none; border:none; color:var(--brand); font-size:10px; cursor:pointer;">↻ ACTUALIZAR</button>
                    </div>
                    <div id="whitelistContainer" style="max-height:200px; overflow-y:auto;">
                        <div style="font-family:var(--font-head); font-size:10px; color:var(--text-tertiary); text-align:center; padding:10px;">
                            Toca ACTUALIZAR para ver la lista
                        </div>
                    </div>

                    <!-- Quitar rol -->
                    <!-- botón oculto — triple confirmación requerida -->
                    <div style="text-align:center; margin-top:16px;">
                        <span onclick="confirmRemoveAdmin()" style="font-size:9px; color:var(--border); cursor:pointer; letter-spacing:1px; user-select:none;">···</span>
                    </div>
                </div>
            </div>

            <div style="text-align:center; font-size:10px; color:var(--text-tertiary); margin-top:20px; font-weight:700; letter-spacing:1px; margin-bottom:40px;">C5X V25.31 - 5 SLOTS</div>
        </div>

        <!-- ══════════════════════════════════════════════════
             SECCIÓN CHAT DE SOPORTE — Firebase Realtime
        ══════════════════════════════════════════════════ -->
        <div id="section-chat" class="app-section">
            <!-- Header del chat -->
            <div class="chat-header">
                <div class="chat-header-avatar">
                    <svg width="18" height="18" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z" fill="currentColor"/></svg>
                </div>
                <div class="chat-header-info">
                    <span class="chat-header-name">SOPORTE C5X</span>
                    <span class="chat-header-status" id="chatStatusLabel">● Conectando...</span>
                </div>
                <div id="chatFirebaseStatus" style="width:8px;height:8px;border-radius:50%;background:var(--text-tertiary);flex-shrink:0;transition:background 0.4s;"></div>
            </div>

            <!-- Mensajes -->
            <div class="chat-messages" id="chatMessages">
                <div class="chat-empty-state" id="chatEmptyState">
                    <svg width="40" height="40" viewBox="0 0 24 24" style="color:var(--text-tertiary)"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                    <p>Escríbenos cualquier duda.<br>El equipo C5X te responderá aquí.</p>
                </div>
            </div>

            <!-- Input de mensaje -->
            <div class="chat-input-bar">
                <input type="text" class="chat-input" id="chatInput"
                    placeholder="Escribe tu mensaje..."
                    maxlength="500"
                    onkeydown="if(event.key==='Enter' && !event.shiftKey){ event.preventDefault(); enviarMensajeChat(); }">
                <button class="chat-send-btn anim-click" onclick="enviarMensajeChat()" id="chatSendBtn">
                    <svg width="18" height="18" viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </button>
            </div>
        </div>
    <div id="tradeModal" class="generic-modal">
        <div class="modal-box section-enter">
            <div class="nav-title" style="color:var(--brand); margin-bottom:10px;">EJECUTAR ORDEN</div>
            <div class="modal-info-text">Estás a punto de enviar una orden real a Gate.io</div>
            <div class="trade-details"><div>PAR: <span id="trade-pair" style="color:var(--text-primary); font-weight:800">BTC_USDT</span></div><div>PRECIO: <span id="trade-price" style="color:var(--text-primary); font-weight:800">0.00</span></div><div>CANTIDAD: <span id="trade-amount" style="color:var(--text-primary); font-weight:800">0.00</span></div><div>TOTAL: <span id="trade-total" style="color:var(--long); font-weight:800">$0.00</span></div></div>
            <button class="btn-modal btn-confirm anim-click" onclick="executeGateOrder()">CONFIRMAR COMPRA</button><button class="btn-modal btn-cancel anim-click" onclick="closeModals()">CANCELAR</button>
        </div>
    </div>
    <div id="confirmModal" class="generic-modal"><div class="modal-box section-enter"><div style="font-family:'Orbitron'; font-size:14px; margin-bottom:15px; color:var(--danger)">¿LIQUIDAR POSICIÓN?</div><p style="font-size:12px; color:var(--text-secondary); margin-bottom:20px;">Esta acción cerrará el slot actual y guardará el registro.</p><button class="btn-modal btn-confirm anim-click" style="background:var(--danger)" onclick="executeRelease()">SÍ, LIQUIDAR</button><button class="btn-modal btn-cancel anim-click" onclick="closeModals()">CANCELAR</button></div></div>
    <div id="securityModal" class="generic-modal"><div class="modal-box section-enter"><div style="font-family:'Orbitron'; font-size:12px;">SEGURIDAD</div><input type="password" id="secInput" class="modal-inp" placeholder="••••" maxlength="4" inputmode="numeric" pattern="[0-9]*"><button class="btn-modal btn-confirm anim-click" onclick="validateSecurity()">VALIDAR</button><button class="btn-modal btn-cancel anim-click" onclick="closeModals()">CANCELAR</button></div></div>
    <div id="sellOptionsModal" class="generic-modal" onclick="if(event.target===this) closeModals()">
        <div class="modal-box section-enter" style="max-width: 400px;">
            <div style="font-family:'Orbitron'; font-size:14px; margin-bottom:15px; color:var(--warning); text-align:center;">🎯 OPCIONES DE VENTA</div>
            <div style="font-size:11px; color:var(--text-tertiary); text-align:center; margin-bottom:20px;">
                <span id="sellModalInfo">Promedio: $0.00</span>
            </div>
            <div style="display:flex; flex-direction:column; gap:10px;">
                <button class="btn-modal anim-click" style="background:var(--danger); padding:14px; font-size:13px;" onclick="executeSellOption('now')">
                    <div style="font-weight:800;">🔴 VENDER AHORA</div>
                    <div style="font-size:10px; opacity:0.8; margin-top:4px;">Al precio actual de mercado</div>
                </button>
                <button class="btn-modal anim-click" style="background:rgba(16, 185, 129, 0.2); border:1px solid var(--long); color:var(--long); padding:14px; font-size:13px;" onclick="executeSellOption(50)">
                    <div style="font-weight:800;">💚 PROMEDIO + 50%</div>
                    <div style="font-size:10px; opacity:0.8; margin-top:4px;" id="sellPrice50">Precio: $0.00</div>
                </button>
                <button class="btn-modal anim-click" style="background:rgba(245, 158, 11, 0.2); border:1px solid var(--warning); color:var(--warning); padding:14px; font-size:13px;" onclick="executeSellOption(75)">
                    <div style="font-weight:800;">🟡 PROMEDIO + 75%</div>
                    <div style="font-size:10px; opacity:0.8; margin-top:4px;" id="sellPrice75">Precio: $0.00</div>
                </button>
                <button class="btn-modal anim-click" style="background:rgba(59, 130, 246, 0.2); border:1px solid var(--brand); color:var(--brand); padding:14px; font-size:13px;" onclick="executeSellOption(100)">
                    <div style="font-weight:800;">🔵 PROMEDIO + 100%</div>
                    <div style="font-size:10px; opacity:0.8; margin-top:4px;" id="sellPrice100">Precio: $0.00</div>
                </button>
            </div>
            <button class="btn-modal btn-cancel anim-click" style="margin-top:15px;" onclick="closeModals()">CANCELAR</button>
        </div>
    </div>
    <!-- incInput/descInput removed — valores vienen de strategyParams -->

    <script>
        const Core = { UI: { handleCoinTap: function() {} } };
        let coinPressTimer;
        let basePricePressTimer;
        
        function startCoinPress() { if(coinPressTimer) clearTimeout(coinPressTimer); coinPressTimer = setTimeout(() => { const el = document.getElementById('coinInput'); if(el.hasAttribute('readonly')) { el.removeAttribute('readonly'); el.classList.remove('locked-input'); el.classList.add('manual-edit'); el.value = ''; el.focus(); if(navigator.vibrate) navigator.vibrate(50); showToast("✏️ Escribe el ETF (ej: PEPE3L)"); } }, 1600); }
        function cancelCoinPress() { if(coinPressTimer) clearTimeout(coinPressTimer); }
        function finishEditingCoin() { const el = document.getElementById('coinInput'); if(!el.hasAttribute('readonly')) { let val = el.value.toUpperCase().trim().replace('USDT',''); if(val) { slots[activeIdx].name = val; save(); loadChart(val); calculate(); showToast("✅ Moneda Guardada: " + val); } el.setAttribute('readonly', true); el.classList.add('locked-input'); el.classList.remove('manual-edit'); el.value = slots[activeIdx].name || "---"; } }
        
        function startBasePricePress(e) {
            if (e) e.preventDefault();
            if(basePricePressTimer) clearTimeout(basePricePressTimer);
            basePricePressTimer = setTimeout(() => {
                const el = document.getElementById('baseInput');
                if(el.hasAttribute('readonly')) {
                    el.removeAttribute('readonly');
                    el.classList.remove('locked-input');
                    el.classList.add('manual-edit');
                    el.select();
                    if(navigator.vibrate) navigator.vibrate(50);
                    showToast("✏️ Modifica el precio - Se actualiza automáticamente");
                    el.oninput = function() {
                        const val = parseFloat(this.value);
                        if(!isNaN(val) && val > 0) {
                            slots[activeIdx].price = val;
                            renderLevels();
                        }
                    };
                }
            }, 1600);
        }
        function cancelBasePricePress() { if(basePricePressTimer) clearTimeout(basePricePressTimer); }
        function finishEditingBasePrice() { const el = document.getElementById('baseInput'); if(!el.hasAttribute('readonly')) { const val = parseFloat(el.value); if(!isNaN(val) && val > 0) { slots[activeIdx].price = val; if (!slots[activeIdx].initialPrice) { slots[activeIdx].initialPrice = val; } save(); renderLevels(); updateDashboardStats(); showToast("💾 Precio guardado: $" + val.toFixed(6)); } el.oninput = null; el.setAttribute('readonly', true); el.classList.add('locked-input'); el.classList.remove('manual-edit'); } }
        
        if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('sw.js').then(registration => { setInterval(() => { registration.update(); }, 5 * 60 * 1000); }).catch(err => { console.warn('⚠️ Service Worker fallo:', err); }); }); } 
        let isLight = localStorage.getItem('theme') === 'light';
        // Bloquear tema del sistema — solo cambia manualmente
        (function() {
            const style = document.createElement('style');
            style.textContent = ':root { color-scheme: only light !important; }';
            document.head.appendChild(style);
        })();
        let isPrivateMode = true; 
        
        function createEmptySlots() { return Array(5).fill(null).map(() => ({ name:'', price:0, capital:5, buys:[], strat:'normal', locked: true, roi: 75, note: '', alerted: false, multipleBuys: {} })); }
        let storedReal = localStorage.getItem('c5x_slots_real');
        let slots = storedReal ? JSON.parse(storedReal) : createEmptySlots();
        
        // ASEGURAR que TODOS los slots tengan la estructura correcta y solo estrategia normal
        slots.forEach(s => { 
            if (!s.buys) s.buys = [];
            if (!s.multipleBuys) s.multipleBuys = {};
            s.strat = 'normal'; // FORZAR siempre normal
            if (typeof s.locked === 'undefined') s.locked = true;
            if (!s.capital) s.capital = 5;
            if (!s.roi) s.roi = 75;
            if (!s.note) s.note = '';
            if (typeof s.alerted === 'undefined') s.alerted = false;
        });
        
        // Asegurar que tengamos exactamente 5 slots (dashboards de trading)
        while(slots.length < 5) {
            slots.push({ 
                name:'', 
                price:0, 
                capital:5, 
                buys:[], 
                strat:'normal', 
                locked: true, 
                roi: 75, 
                note: '', 
                alerted: false,
                multipleBuys: {}
            });
        }
        // Recortar a 5 si hay más (evita slots ocultos)
        if (slots.length > 5) slots = slots.slice(0, 5);
        
        let activeIdx = parseInt(localStorage.getItem('c5x_last_slot')); if(isNaN(activeIdx)) activeIdx = 0;

        // ── MULTI-DASHBOARD: renderiza las 5 tarjetas del Panel 1 ──
        function renderAllDashboards() {
            const container = document.getElementById('dashboardsContainer');
            if (!container) return;
            container.innerHTML = '';
            for (let i = 0; i < 5; i++) {
                const s = slots[i] || {};
                const isActive = (i === activeIdx);
                const coinName = s.name || '---';
                const coinColor = getCoinColor(s.name);
                const basePrice = s.price > 0 ? (s.price < 1 ? s.price.toFixed(6) : s.price.toFixed(4)) : '0.0000';
                const card = document.createElement('div');
                card.className = 'dashboard-card' + (isActive ? ' slot-active' : '');
                card.id = 'dashCard-' + i;
                card.onclick = () => activateDashSlot(i);
                card.innerHTML = `
                    <div class="dash-slot-label">SLOT ${i+1}${isActive ? ' ● ACTIVO' : ''}</div>
                    <div class="dash-compact-grid">
                        <div class="dash-cell-coin" id="basePriceBox-${i}"
                            ontouchstart="if(activeIdx===${i})startBasePricePress(event)" ontouchend="if(activeIdx===${i})cancelBasePricePress()"
                            onmousedown="if(activeIdx===${i})startBasePricePress(event)" onmouseup="if(activeIdx===${i})cancelBasePricePress()" onmouseleave="if(activeIdx===${i})cancelBasePricePress()">
                            <span class="dash-cell-coin-label">ACTIVO</span>
                            <div id="dashTradingCoin-${i}" class="dash-cell-coin-name" style="color:${coinColor}; cursor:pointer; text-decoration:${s.name ? 'underline dotted' : 'none'}; text-underline-offset:3px;" title="Ver 12 niveles" ontouchstart="event.stopPropagation(); event.preventDefault(); goToSlotLevels(${i});" onclick="event.stopPropagation(); goToSlotLevels(${i});">${coinName}</div>
                        </div>
                        <div class="dash-cell"
                            ontouchstart="if(activeIdx===${i})startBasePricePress(event)" ontouchend="if(activeIdx===${i})cancelBasePricePress()"
                            onmousedown="if(activeIdx===${i})startBasePricePress(event)" onmouseup="if(activeIdx===${i})cancelBasePricePress()" onmouseleave="if(activeIdx===${i})cancelBasePricePress()"
                            style="cursor:pointer;">
                            <span class="dash-cell-label">BASE</span>
                            <span class="dash-cell-value" id="dashBaseDisplay-${i}">${basePrice}</span>
                        </div>
                        <div class="dash-cell" id="investmentBox-${i}">
                            <span class="dash-cell-label">INVERSIÓN</span>
                            <span class="dash-cell-value" id="resInv-${i}">$0.00</span>
                        </div>
                        <div class="dash-cell" id="avgCell-${i}"
                            ontouchstart="if(activeIdx===${i})startClearSlotPress(event)" ontouchend="if(activeIdx===${i})cancelClearSlotPress()"
                            onmousedown="if(activeIdx===${i})startClearSlotPress(event)" onmouseup="if(activeIdx===${i})cancelClearSlotPress()" onmouseleave="if(activeIdx===${i})cancelClearSlotPress()"
                            style="cursor:pointer;">
                            <span class="dash-cell-label">PROMEDIO</span>
                            <span class="dash-cell-value" id="resAvg-${i}">0.0000</span>
                        </div>
                        <div class="dash-cell dash-cell-manual" style="padding:0; border:none; background:transparent;">
                            <div class="trading-manual-btn anim-click${i === 0 ? '' : ''}" id="tradingModeBtn-${i}"
                                ontouchstart="if(activeIdx===${i})startTradingPress(event)" ontouchend="if(activeIdx===${i})cancelTradingPress(event)"
                                onmousedown="if(activeIdx===${i})startTradingPress(event)" onmouseup="if(activeIdx===${i})cancelTradingPress(event)" onmouseleave="if(activeIdx===${i})cancelTradingPress(event)"
                                style="height:100%; min-height:44px; border-radius:12px; ${!isActive ? 'opacity:0.5' : ''}">
                                <div style="display:flex; align-items:center; gap:4px;">
                                    <svg width="13" height="13" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                                    <span id="tradingModeText-${i}" style="font-size:10px;">MANUAL</span>
                                </div>
                                <span class="mode-indicator" id="tradingModeIndicator-${i}" style="font-size:8px; margin:0;">ESPERANDO</span>
                            </div>
                        </div>
                        <div class="dash-cell" id="targetSection-${i}"
                            ontouchstart="if(activeIdx===${i})startSellPress(event)" ontouchend="if(activeIdx===${i})endSellPress(event)"
                            onmousedown="if(activeIdx===${i})startSellPress(event)" onmouseup="if(activeIdx===${i})endSellPress(event)" onmouseleave="if(activeIdx===${i})cancelSellPress()"
                            style="cursor:pointer;">
                            <span class="dash-cell-label">OBJETIVO</span>
                            <span class="dash-cell-value" id="resTarget-${i}">0.0000</span>
                        </div>
                    </div>`;
                container.appendChild(card);
            }
            // Actualizar stats de todos los slots
            for (let i = 0; i < 5; i++) updateDashboardStatsForSlot(i);
            updateTradingModeUIAll();
        }

        // Activar slot en Panel 2 (dashboards) — solo cambia slot activo
        function activateDashSlot(i) {
            if (i === activeIdx) return; // ya activo, nada que hacer
            selectSlot(i);
            renderAllDashboards();
            // Si el usuario YA estaba viendo Panel 3, actualizar niveles también
            if (currentPanel === 2) forceRenderLevels(i);
        }

        // Ir directo al Panel 3 (12 niveles) del slot i — la función principal
        function goToSlotLevels(i) {
            triggerHaptic();
            // 1. Activar el slot sin re-renderizar el dashboard (evita flash)
            activeIdx = i;
            localStorage.setItem('c5x_last_slot', i);
            const s = slots[i];
            // Actualizar inputs — SIEMPRE restaurar precio real del slot
            const cIn = document.getElementById('coinInput');
            if (cIn) { cIn.value = s ? (s.name || '') : ''; }
            const bIn = document.getElementById('baseInput');
            if (bIn) {
                // Si el slot tiene precio guardado, mostrarlo siempre
                const precio = s && s.price > 0 ? s.price : (s && s.initialPrice > 0 ? s.initialPrice : '');
                bIn.value = precio;
                if (precio) { bIn.setAttribute('readonly', true); bIn.classList.add('locked-input'); }
            }
            // Resaltar tarjeta activa sin recrear el DOM
            document.querySelectorAll('.dashboard-card').forEach((card, idx) => {
                card.classList.toggle('slot-active', idx === i);
                const lbl = card.querySelector('.dash-slot-label');
                if (lbl) lbl.textContent = 'SLOT ' + (idx+1) + (idx === i ? ' ● ACTIVO' : '');
                const btn = card.querySelector('[id^="tradingModeBtn-"]');
                if (btn) btn.style.opacity = idx === i ? '1' : '0.5';
            });
            updateDashUI();
            // 2. Renderizar niveles inmediatamente (síncronamente)
            forceRenderLevels(i);
            // 3. Navegar al Panel 3
            switchPanel(2);
            // 4. Backup: segundo render tras la animación de panel
            setTimeout(() => forceRenderLevels(i), 320);
        }

        // Renderizar niveles del slot i de forma forzada y confiable
        function forceRenderLevels(slotIdx) {
            const grid = document.getElementById('levelsGrid');
            if (!grid) return;
            const prevActive = activeIdx;
            activeIdx = slotIdx; // garantizar que activeIdx es correcto
            renderLevels();
            // Cargar chart del símbolo correcto
            const sym = slots[slotIdx] && slots[slotIdx].name ? slots[slotIdx].name : 'BTC5L';
            if (sym) setTimeout(() => loadChart2(sym), 80);
            activeIdx = slotIdx; // mantener correcto tras renderLevels
        }
        // Tap en nombre de moneda → panel 2 (Chart2 + 12 Niveles)
        function openCoinInLevels(slotIdx) {
            goToSlotLevels(slotIdx); // unificado
        }
        let activeTF = localStorage.getItem('c5x_last_tf') || '60';
        let chartSymbol = '';
        let history = JSON.parse(localStorage.getItem('c5x_history')) || [];
        let strategyParams = JSON.parse(localStorage.getItem('c5x_strategy_params')) || { normal: { capital: 5, roi: 100, inc: 7, desc: 17, dd: 17 } };
        
        // Bot config
        let botConfig = JSON.parse(localStorage.getItem('c5x_bot_config')) || {
            enabled: false,
            normalProfit: 100,
            trailingStop: 10,
            checkInterval: 30
        };
        
        if (!strategyParams.normal) strategyParams.normal = { capital: 5, roi: 75, inc: 7, desc: 17, dd: 17 };
        
        let currentSection = 'operate';
        let modalCallback = null;
        let customMultipliers = JSON.parse(localStorage.getItem('c5x_multipliers')) || [1.0, 1.0, 1.5, 1.5, 2.0, 2.0, 5.0, 5.0, 8.0, 8.0, 16.0, 16.0];
        let etfFavorites = JSON.parse(localStorage.getItem('c5x_etf_favorites')) || [];
        let globalCapital = parseFloat(localStorage.getItem('c5x_global_capital')) || 0; 
        let availableUSDT = 1000.00; // USDT disponible (se actualizará desde Gate.io)
        let exchangeFee = parseFloat(localStorage.getItem('c5x_fee')) || 0.1;
        let appConfig = JSON.parse(localStorage.getItem('c5x_config')) || { pin: '2524', dd: 10 };
        let apiConfig = JSON.parse(localStorage.getItem('c5x_api_keys')) || { key: '', secret: '' };
        let tickerAssets = JSON.parse(localStorage.getItem('c5x_ticker_assets')) || ["BTC", "ETH", "SUI", "AVAX", "SOL", "BNB"]; 
        let isTickerPinned = localStorage.getItem('c5x_ticker_pinned') === 'true'; 
        let assetIdx = parseInt(localStorage.getItem('c5x_ticker_index')) || 0; 
        let currentTickerSymbol = "BTC";
        let currentWs = null; 
        let tickerIntervalId = null;
        let tickerSpeed = parseInt(localStorage.getItem('c5x_ticker_speed')) || 7;
        let radarLimit = parseInt(localStorage.getItem('c5x_radar_limit')) || 10; 
        let radarSpeed = parseInt(localStorage.getItem('c5x_radar_speed')) || 7; 
        let autoAdjustThreshold = parseFloat(localStorage.getItem('c5x_auto_adjust_threshold')) || 3; 
        let allGateETFs = []; let topDroppers = []; let dropperIdx = 0; let radarQueue = [];
        let radarIntervalId = null;
        let monitorLimit = 20; // Fijo en 20 ETFs
        let tradingMode = localStorage.getItem('c5x_trading_mode') || 'manual'; 
        let activeOrders = {}; 
        let isHeaderPinnedByScroll = false;
        let tickerPressTimer = null; let tickerLongPressTriggered = false;
        let tradingPressTimer = null; let strategyPressTimer = null; let modePressTimer = null; let longPressTriggered = false;
        let isETFMonitorVisible = true;
        let clearSlotPressTimer = null; let clearSlotLongPressTriggered = false;
        let etfSearchPressTimer = null; let etfSearchLongPressTriggered = false; 

        function handleTickerTouchStart(e) { startTickerPress(); }
        function handleTickerTouchEnd(e) { endTickerPress(); }
        function handleTickerMouseDown(e) { if(e.type==='touchstart')return; startTickerPress(); }
        function handleTickerMouseUp(e) { endTickerPress(); }
        function startTickerPress() { tickerLongPressTriggered = false; tickerPressTimer = setTimeout(() => { tickerLongPressTriggered = true; toggleTickerPin(); }, 1600); }
        function endTickerPress() { if(tickerPressTimer) clearTimeout(tickerPressTimer); }
        function cancelTickerPress() { if(tickerPressTimer) clearTimeout(tickerPressTimer); }
        
        function startClearSlotPress(e) {
            if (e) e.preventDefault();
            clearSlotLongPressTriggered = false;
            const cell = document.getElementById('avgCell-' + activeIdx);
            if (cell) cell.classList.add('pressing');
            clearSlotPressTimer = setTimeout(() => {
                clearSlotLongPressTriggered = true;
                if (cell) cell.classList.remove('pressing');
                clearCurrentSlot();
                triggerHaptic();
                if(navigator.vibrate) navigator.vibrate([100, 50, 100]);
            }, 2000); 
        }
        function cancelClearSlotPress() { 
            if (clearSlotPressTimer) { clearTimeout(clearSlotPressTimer); clearSlotPressTimer = null; } 
            const cell = document.getElementById('avgCell-' + activeIdx);
            if (cell) cell.classList.remove('pressing');
            if (!clearSlotLongPressTriggered) { showHoldHint('Limpiar Slot'); } 
            clearSlotLongPressTriggered = false; 
        }
        
        function clearCurrentSlot() {
            const s = slots[activeIdx];
            if (!s.name) {
                showToast("⚠️ El slot ya está vacío");
                return;
            }
            s.name = '';
            s.price = 0;
            s.capital = 5;
            s.buys = [];
            s.strat = 'normal';
            s.roi = 75;
            s.note = '';
            s.alerted = false;
            for (let i = 0; i < 12; i++) {
                const key = getOrderKey(activeIdx, i);
                if (activeOrders[key]) {
                    delete activeOrders[key];
                }
            }
            save();
            saveActiveOrders();
            saveInvestmentValue(); 
            
            sortSlots();
            
            selectSlot(0);
            renderAllDashboards();
            
            showToast("🗑️ Slot limpiado y movido al final");
        }
        
        function showHoldHint(action) { showToast(`👆 Mantén presionado para ${action}`); }
        function getOrderKey(slotIdx, levelIdx) { return `s${slotIdx}_l${levelIdx}`; }
        function toggleETFMonitor() { triggerHaptic(); const etfList = document.getElementById('desktop-etf-list'); const toggleBtn = document.getElementById('etfMonitorToggleBtn'); const toggleIcon = document.getElementById('etfToggleIcon'); isETFMonitorVisible = !isETFMonitorVisible; if (isETFMonitorVisible) { etfList.classList.remove('collapsed'); toggleBtn.classList.remove('collapsed'); toggleIcon.classList.remove('rotated'); } else { etfList.classList.add('collapsed'); toggleBtn.classList.add('collapsed'); toggleIcon.classList.add('rotated'); } localStorage.setItem('c5x_etf_monitor_visible', isETFMonitorVisible); }
        
        function loadETFMonitorState() { const saved = localStorage.getItem('c5x_etf_monitor_visible'); if (saved !== null) { isETFMonitorVisible = saved === 'true'; if (!isETFMonitorVisible) { const etfList = document.getElementById('desktop-etf-list'); const toggleBtn = document.getElementById('etfMonitorToggleBtn'); const toggleIcon = document.getElementById('etfToggleIcon'); if (etfList) etfList.classList.add('collapsed'); if (toggleBtn) toggleBtn.classList.add('collapsed'); if (toggleIcon) toggleIcon.classList.add('rotated'); } } }
        let sellScrollStartY = 0;
        let sellScrollStartTime = 0;
        let isSellScrolling = false;
        let sellPressTimer = null;
        let activeSellTarget = null; // {type: 'now'|50|75|100, targetPrice: number, avgPrice: number}
        
        function startSellPress(e) { 
            sellScrollStartY = e.touches ? e.touches[0].clientY : e.clientY;
            sellScrollStartTime = Date.now();
            isSellScrolling = false;
            
            const btnEl = document.getElementById('targetSection-' + activeIdx);
            if (btnEl) btnEl.classList.add('pressing');
            
            sellPressTimer = setTimeout(() => { 
                if (!isSellScrolling) {
                    if (navigator.vibrate) navigator.vibrate([80, 50, 80]);
                    if (btnEl) btnEl.classList.remove('pressing');
                    openSellOptionsModal();
                }
            }, 2400);
        }
        
        function endSellPress(e) { 
            const currentY = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
            const scrollDistance = Math.abs(currentY - sellScrollStartY);
            const scrollTime = Date.now() - sellScrollStartTime;
            
            const btnEl = document.getElementById('targetSection-' + activeIdx);
            if (btnEl) btnEl.classList.remove('pressing');
            
            if (scrollDistance > 10 || scrollTime < 150) {
                isSellScrolling = true;
            }
            
            if (sellPressTimer) clearTimeout(sellPressTimer);
        }
        
        function cancelSellPress() { 
            isSellScrolling = true;
            const btnEl = document.getElementById('targetSection-' + activeIdx);
            if (btnEl) btnEl.classList.remove('pressing');
            if (sellPressTimer) clearTimeout(sellPressTimer);
        }
        
        function openSellOptionsModal() {
            const s = slots[activeIdx];
            if (!s || !s.name || s.buys.length === 0) {
                return showToast("⚠️ No hay compras para vender");
            }
            
            // Calcular precio promedio
            const avgPrice = calculateAvgPriceForSlotData(s, activeIdx);
            if (avgPrice <= 0) {
                return showToast("⚠️ No se puede calcular precio promedio");
            }
            
            // Actualizar información del modal
            document.getElementById('sellModalInfo').textContent = `Promedio: $${avgPrice.toFixed(6)}`;
            document.getElementById('sellPrice50').textContent = `Precio: $${(avgPrice * 1.5).toFixed(6)}`;
            document.getElementById('sellPrice75').textContent = `Precio: $${(avgPrice * 1.75).toFixed(6)}`;
            document.getElementById('sellPrice100').textContent = `Precio: $${(avgPrice * 2).toFixed(6)}`;
            
            // Mostrar modal
            document.getElementById('sellOptionsModal').style.display = 'flex';
            setTimeout(() => {
                document.getElementById('sellOptionsModal').classList.add('show');
            }, 10);
        }
        
        function executeSellOption(option) {
            const s = slots[activeIdx];
            const avgPrice = calculateAvgPriceForSlotData(s, activeIdx);
            
            if (option === 'now') {
                // Vender inmediatamente al precio actual
                if (confirm(`🔴 ¿Vender AHORA al precio actual?\n\nEsto cerrará todas las compras de ${s.name}`)) {
                    closeModals();
                    executeSellNow(s, activeIdx);
                }
            } else {
                // Configurar objetivo de venta automática
                const profitPercent = option;
                const targetPrice = avgPrice * (1 + (profitPercent / 100));
                
                activeSellTarget = {
                    slotIndex: activeIdx,
                    type: profitPercent,
                    targetPrice: targetPrice,
                    avgPrice: avgPrice,
                    symbol: s.name
                };
                
                // Guardar en localStorage
                localStorage.setItem('c5x_sell_target', JSON.stringify(activeSellTarget));
                
                closeModals();
                
                // Actualizar UI del objetivo
                const targetSection = document.getElementById('targetSection-' + activeIdx);
                targetSection.style.borderColor = 'var(--long)';
                targetSection.style.background = 'linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(14, 203, 129, 0.1))';
                document.getElementById('resTarget-' + activeIdx).textContent = targetPrice.toFixed(6);
                
                showToast(`🎯 Objetivo: $${targetPrice.toFixed(6)} (+${profitPercent}%)`, 3000, false, true);
                
                // Iniciar monitoreo
                if (!priceMonitorInterval) {
                    priceMonitorInterval = setInterval(() => {
                        checkSellTargets();
                    }, 3000);
                }
            }
        }
        
        function executeSellNow(slot, slotIdx) {
            // Simular venta inmediata
            const currentPrice = parseFloat(document.getElementById('t-price').textContent.replace('$', '')) || slot.price;
            const avgPrice = calculateAvgPriceForSlotData(slot, slotIdx);
            const profitPercent = ((currentPrice - avgPrice) / avgPrice * 100).toFixed(2);
            
            showToast(`💰 Vendido: ${slot.name} al +${profitPercent}%`, 3000, false, true);
            
            // Registrar en historial
            addToHistory(slot, slotIdx, currentPrice, 'manual');
            
            // Limpiar slot
            const currentStrat = slot.strat || 'normal';
            const currentCapital = strategyParams.normal.capital;
            const currentRoi = strategyParams.normal.roi;
            
            slots[slotIdx] = { 
                name: '', 
                price: 0, 
                capital: currentCapital, 
                buys: [], 
                strat: currentStrat, 
                locked: true, 
                roi: currentRoi, 
                note: '', 
                alerted: false, 
                multipleBuys: {} 
            };
            
            // Limpiar órdenes activas
            const keyPrefix = `s${slotIdx}_`;
            Object.keys(activeOrders).forEach(k => {
                if (k.startsWith(keyPrefix)) delete activeOrders[k];
            });
            
            save();
            
            if (slotIdx === activeIdx) {
                selectSlot(activeIdx);
            }
            
            
        }
        
        function checkSellTargets() {
            if (!activeSellTarget) {
                // Cargar desde localStorage si existe
                const saved = localStorage.getItem('c5x_sell_target');
                if (saved) {
                    try {
                        activeSellTarget = JSON.parse(saved);
                    } catch(e) {
                        return;
                    }
                } else {
                    return;
                }
            }
            
            const s = slots[activeSellTarget.slotIndex];
            if (!s || !s.name || s.name !== activeSellTarget.symbol) {
                // Slot fue limpiado o cambió
                activeSellTarget = null;
                localStorage.removeItem('c5x_sell_target');
                return;
            }
            
            // Obtener precio actual del coin objetivo (no del ticker, que puede mostrar otro)
            let currentPrice = 0;
            const liveETF = allGateETFs.find(t => t.currency_pair === activeSellTarget.symbol + '_USDT');
            if (liveETF) {
                currentPrice = parseFloat(liveETF.last);
            } else {
                // Fallback: usar precio del ticker solo si el símbolo coincide
                const tickerSym = document.getElementById('t-sym') ? document.getElementById('t-sym').textContent : '';
                if (tickerSym === activeSellTarget.symbol) {
                    currentPrice = parseFloat(document.getElementById('t-price').textContent.replace('$',''));
                }
            }
            if (isNaN(currentPrice) || currentPrice <= 0) return;
            
            // Verificar si el precio alcanzó el objetivo
            if (currentPrice >= activeSellTarget.targetPrice) {
                // ¡Objetivo alcanzado! Vender automáticamente
                const profitPercent = ((currentPrice - activeSellTarget.avgPrice) / activeSellTarget.avgPrice * 100).toFixed(2);
                
                showToast(`🎉 OBJETIVO ALCANZADO! +${profitPercent}%`, 4000, false, true);
                
                if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 100]);
                
                // Registrar venta
                addToHistory(s, activeSellTarget.slotIndex, currentPrice, 'auto');
                
                // Limpiar slot
                const currentStrat = s.strat || 'normal';
                const currentCapital = strategyParams.normal.capital;
                const currentRoi = strategyParams.normal.roi;
                
                slots[activeSellTarget.slotIndex] = { 
                    name: '', 
                    price: 0, 
                    capital: currentCapital, 
                    buys: [], 
                    strat: currentStrat, 
                    locked: true, 
                    roi: currentRoi, 
                    note: '', 
                    alerted: false, 
                    multipleBuys: {} 
                };
                
                // Limpiar órdenes activas
                const keyPrefix = `s${activeSellTarget.slotIndex}_`;
                Object.keys(activeOrders).forEach(k => {
                    if (k.startsWith(keyPrefix)) delete activeOrders[k];
                });
                
                save();
                
                // Guardar el slotIndex antes de limpiar el objetivo
                const completedSlotIndex = activeSellTarget.slotIndex;
                
                // Limpiar objetivo
                activeSellTarget = null;
                localStorage.removeItem('c5x_sell_target');
                
                // Actualizar UI
                const targetSection = document.getElementById('targetSection-' + completedSlotIndex);
                if (targetSection) { targetSection.style.borderColor = ''; targetSection.style.background = ''; }
                
                // Refrescar todos los dashboards
                renderAllDashboards();
                if (completedSlotIndex === activeIdx) {
                    selectSlot(activeIdx);
                }
                
                
            }
        }
        
        function addToHistory(slot, slotIdx, exitPrice, mode) {
            const avgPrice = calculateAvgPriceForSlotData(slot, slotIdx);
            let totalInvested = 0;
            
            // Calcular inversión total
            slot.buys.forEach(levelIdx => {
                const levelData = getLevelData(slot, levelIdx);
                totalInvested += levelData.usd;
            });
            
            // Agregar inversiones de compras múltiples
            if (slot.multipleBuys) {
                Object.values(slot.multipleBuys).forEach(buysArray => {
                    if (Array.isArray(buysArray)) {
                        buysArray.forEach(buy => {
                            totalInvested += buy.usd;
                        });
                    }
                });
            }
            
            const grossProfit = (exitPrice - avgPrice) * (totalInvested / avgPrice);
            const netProfit = grossProfit - (totalInvested * (exchangeFee / 100));
            const roi = ((netProfit / totalInvested) * 100).toFixed(2);
            
            const log = {
                date: new Date().toLocaleDateString(),
                time: mode === 'auto' ? 'AUTO' : new Date().toLocaleTimeString(),
                coin: slot.name,
                avgPrice: avgPrice,
                exitPrice: exitPrice,
                totalInv: totalInvested,
                profit: grossProfit.toFixed(2),
                netProfit: netProfit.toFixed(2),
                roi: roi + '%'
            };
            
            history.push(log);
            localStorage.setItem('c5x_history', JSON.stringify(history));
            renderHistory();
            calculateGlobalStats();
        }
        
        function updateStrategyButtonVisuals() { 
            // Estrategia única NORMAL - sin elemento visual en dashboard
        }
        
        // Nueva función para toggle de estrategia con pulsación larga
        let strategyTogglePressTimer = null;
        let strategyToggleLongPress = false;
        
        function startStrategyTogglePress(e) {
            // Solo estrategia normal disponible - función mantenida para compatibilidad
            e.preventDefault();
        }
        
        function endStrategyTogglePress(e) {
            // Solo estrategia normal disponible - función mantenida para compatibilidad
        }
        
        function cancelStrategyTogglePress() {
            // Solo estrategia normal disponible - función mantenida para compatibilidad
            strategyToggleLongPress = false;
        }

        function init() { 
             try {
                // Mostrar pantalla de verificación — Firebase puede tener sesión cacheada
                // Así el usuario con sesión activa no ve el login innecesariamente
                lockApp('checking');
                if(!tickerAssets || tickerAssets.length === 0) { tickerAssets = ["BTC", "ETH", "SUI", "AVAX", "BNB"]; localStorage.setItem('c5x_ticker_assets', JSON.stringify(tickerAssets)); }
                // Filtrar tokens ETF del ticker (no 3L, 5L, 3S, 5S)
                tickerAssets = tickerAssets.filter(t => !t.match(/[35][LS]/));
                if(isLight) { document.body.classList.add('light-mode'); }
                
                slots.forEach(s => { if (!s.strat) s.strat = 'normal'; });
                loadInvestmentValue(); loadSlotsLevels(); updateThemeIcon(); loadActiveOrders(); loadSellOrder(); loadSellTarget(); updateStrategyButtonVisuals(); updateTradingModeUI(); loadETFMonitorState();
                if (apiConfig.key && apiConfig.secret) fetchWalletBalance();
                initGoogleSignIn();
                // Inicializar Firebase (auth + cloud sync + chat)
                // Siempre intentar; si no está configurado, muestra el form en Ajustes
                initFirebase();
                // Mostrar el estado correcto en la sección de Ajustes → Cuenta
                updateCloudUI();
                if(!slots[activeIdx]) activeIdx = 0;
                updateDashUI();  selectSlot(activeIdx); renderHistory(); updatePinUI(); startTickerSystem(); fetchAndCalcTopDroppers(); setupSwipe(); setupPanelSwipe(); renderAllDashboards();
                document.querySelectorAll('.tf-btn').forEach(btn => { if(btn.dataset.tf === activeTF) btn.classList.add('active'); });
                calculateGlobalStats(); updateStats('D'); updateDashboardStats(); startGateMonitoring();
                startMasterClock(); // reloj maestro — todas las rotaciones sincronizadas cada 10s
                initGateDashboard(); // dashboard en panel 2, inicializar desde el arranque
                // Establecer estado inicial del historial de navegación
                // Esto previene que el primer "Atrás" cierre la app
                window.history.replaceState({ c5xView: 'operate' }, '', window.location.pathname);
                window.addEventListener('scroll', handleWindowScroll);
                document.body.addEventListener('click', unlockAudioAndWake, { once: true }); document.body.addEventListener('touchstart', unlockAudioAndWake, { once: true }); requestWakeLock();
                if(tradingMode === 'auto') startAutoTrading(); loadGateETFs(); 
                // Iniciar monitoreo de objetivos de venta
                if (!priceMonitorInterval) {
                    priceMonitorInterval = setInterval(() => {
                        checkSellTargets();
                    }, 3000);
                }
                
                // GUARDADO AUTOMÁTICO cada 30 segundos
                setInterval(() => {
                    save();
                    saveActiveOrders();
                    saveSellOrder();
                    if (activeSellTarget) {
                        localStorage.setItem('c5x_sell_target', JSON.stringify(activeSellTarget));
                    }
                }, 30000);
                
                // GUARDADO antes de cerrar/salir
                window.addEventListener('beforeunload', (e) => {
                    save();
                    saveActiveOrders();
                    saveSellOrder();
                    if (activeSellTarget) {
                        localStorage.setItem('c5x_sell_target', JSON.stringify(activeSellTarget));
                    }
                    localStorage.setItem('c5x_history', JSON.stringify(history));
                });
                
                // GUARDADO al cambiar de pestaña o minimizar
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        save();
                        saveActiveOrders();
                        saveSellOrder();
                    }
                });
                
            } catch(e) { console.error("Init Error", e); showToast("⚠️ Error de inicio: " + e.message); }
        }
        
        function loadSellTarget() {
            const saved = localStorage.getItem('c5x_sell_target');
            if (saved) {
                try {
                    activeSellTarget = JSON.parse(saved);
                    // Actualizar UI si el slot activo tiene objetivo
                    if (activeSellTarget && activeSellTarget.slotIndex === activeIdx) {
                        const targetSection = document.getElementById('targetSection-' + activeIdx);
                        if (targetSection) {
                            targetSection.style.borderColor = 'var(--long)';
                            targetSection.style.background = 'linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(14, 203, 129, 0.1))';
                        }
                        const resTarget = document.getElementById('resTarget-' + activeIdx);
                        if (resTarget && activeSellTarget.targetPrice) {
                            resTarget.textContent = activeSellTarget.targetPrice.toFixed(6);
                        }
                    }
                } catch(e) {
                    console.warn("Error cargando objetivo de venta", e);
                }
            }
        }
        function handleWindowScroll() { const scrollY = window.scrollY; const threshold = 30; const brandBtn = document.querySelector('.brand-btn'); const themeBtn = document.querySelector('.theme-btn'); if (scrollY > threshold) { if (!isHeaderPinnedByScroll) { isHeaderPinnedByScroll = true; if(brandBtn) brandBtn.classList.add('hidden'); if(themeBtn) themeBtn.classList.add('hidden'); } } else { if (isHeaderPinnedByScroll) { isHeaderPinnedByScroll = false; if(brandBtn) brandBtn.classList.remove('hidden'); if(themeBtn) themeBtn.classList.remove('hidden'); updateTicker(); } } }
        function startTradingPress(e) { if(e.type==='touchstart' && e.cancelable) e.preventDefault(); longPressTriggered = false; tradingPressTimer = setTimeout(() => { longPressTriggered = true; toggleTradingMode(); }, 1600); }
        function cancelTradingPress(e) { if (tradingPressTimer) clearTimeout(tradingPressTimer); }
        let strategyScrollStartY = 0;
        let strategyScrollStartTime = 0;
        let isStrategyScrolling = false;
        let strategyPressedButton = null;
        function startStrategyPress(e, strategy) {
            // Estrategia única — solo para compatibilidad de eventos heredados
        }
        function endStrategyPress(e) {
            if (strategyPressTimer) clearTimeout(strategyPressTimer);
        }
        function cancelStrategyPress(e) {
            if (strategyPressTimer) clearTimeout(strategyPressTimer);
        }
        
        let levelPressTimer = null;
        let levelLongPressTriggered = false;
        let currentPressedLevel = -1;
        let scrollStartY = 0;
        let scrollStartTime = 0;
        let isScrolling = false;
        function startLevelPress(e, levelIndex) { 
            scrollStartY = e.touches ? e.touches[0].clientY : e.clientY;
            scrollStartTime = Date.now();
            isScrolling = false;
            currentPressedLevel = levelIndex; 
            levelLongPressTriggered = false; 
            
            // Agregar clase visual de presión
            const cardEl = document.querySelector(`[data-level-index="${levelIndex}"]`);
            if (cardEl) {
                cardEl.classList.add('pressing');
            }
            
            levelPressTimer = setTimeout(() => { 
                if (!isScrolling) {
                    levelLongPressTriggered = true; 
                    if (navigator.vibrate) navigator.vibrate([80, 50, 80]); 
                    
                    // Remover clase de presión antes de ejecutar
                    if (cardEl) cardEl.classList.remove('pressing');
                    
                    handleLevelClick(levelIndex); 
                }
            }, 2400); 
        }
        function endLevelPress(e) { 
            const currentY = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
            const scrollDistance = Math.abs(currentY - scrollStartY);
            const scrollTime = Date.now() - scrollStartTime;
            
            // Remover clase de presión
            const cardEl = document.querySelector(`[data-level-index="${currentPressedLevel}"]`);
            if (cardEl) cardEl.classList.remove('pressing');
            
            // Si se movió más de 10px o pasó menos de 150ms, es scroll
            if (scrollDistance > 10 || scrollTime < 150) {
                isScrolling = true;
            }
            
            if (levelPressTimer) clearTimeout(levelPressTimer); 
            levelLongPressTriggered = false; 
            currentPressedLevel = -1; 
        }
        function cancelLevelPress() { 
            isScrolling = true;
            
            // Remover clase de presión
            const cardEl = document.querySelector(`[data-level-index="${currentPressedLevel}"]`);
            if (cardEl) cardEl.classList.remove('pressing');
            
            if (levelPressTimer) clearTimeout(levelPressTimer); 
            levelLongPressTriggered = false; 
            currentPressedLevel = -1; 
        }
        
        function updateDashUI() { 
            const s = slots[activeIdx]; 
            const btnMode = document.getElementById('tradingModeBtn-' + activeIdx); 
            const capitalInput = document.getElementById('capitalInput'); 
            if (btnMode) btnMode.classList.remove('locked'); 
            updateStrategyButtonVisuals(); 
            
            if(capitalInput) { 
                capitalInput.value = s.capital || 5; 
                capitalInput.removeAttribute('readonly'); 
                capitalInput.style.opacity = '1'; 
                capitalInput.style.cursor = 'text'; 
            } 
            
            updateBodyMode(s.name); 
            updateTradingInfoDisplay(); 
            calculate(); 
        }
        
        function updateCapitalAndSave() { 
            const capitalInput = document.getElementById('capitalInput'); 
            const s = slots[activeIdx]; 
            
            if (capitalInput && s) { 
                const newCapital = parseFloat(capitalInput.value) || 5; 
                s.capital = newCapital; 
                save(); 
                calculate(); 
                showToast("💾 Capital guardado"); 
            } 
        }
        
        function updateTradingInfoDisplay() {
            const s = slots[activeIdx];
            const coinEl = document.getElementById('dashTradingCoin-' + activeIdx);
            if (coinEl) {
                coinEl.textContent = s.name || '---';
                coinEl.style.color = getCoinColor(s.name);
            }
            const baseEl = document.getElementById('dashBaseDisplay-' + activeIdx);
            if (baseEl && s.price > 0) {
                const p = s.price;
                baseEl.textContent = p < 0.0001 ? p.toFixed(10).replace(/\.?0+$/, '') : p < 1 ? p.toFixed(6) : p.toFixed(4);
            } else if (baseEl) {
                baseEl.textContent = '0.0000';
            }
        }
        
        function toggleTradingMode() { triggerHaptic(); if(navigator.vibrate) navigator.vibrate([50, 50]); if (tradingMode === 'manual') { tradingMode = 'auto'; localStorage.setItem('c5x_trading_mode', 'auto'); updateTradingModeUI(); startAutoTrading(); showToast("🤖 AUTOMÁTICO - Compras y ventas automáticas activadas"); } else { tradingMode = 'manual'; localStorage.setItem('c5x_trading_mode', 'manual'); updateTradingModeUI(); showToast("👆 MANUAL - Monitoreo de precios sigue activo"); } }
        function updateTradingModeUI() { 
            updateTradingModeUIAll(); 
        }
        function updateTradingModeUIAll() {
            const modeEmoji = "💎";
            for (let i = 0; i < 5; i++) {
                const btn = document.getElementById('tradingModeBtn-' + i);
                const text = document.getElementById('tradingModeText-' + i);
                const indicator = document.getElementById('tradingModeIndicator-' + i);
                if (!btn) continue;
                if (tradingMode === 'auto') {
                    btn.classList.add('auto-mode');
                    if (text) text.textContent = 'AUTOMÁTICO';
                    if (indicator) indicator.textContent = `${modeEmoji} ACTIVO`;
                } else {
                    btn.classList.remove('auto-mode');
                    if (text) text.textContent = 'MANUAL';
                    if (indicator) indicator.textContent = 'ESPERANDO';
                }
            }
        }
        function updateTickerWithActiveCoin() { const s = slots[activeIdx]; if (s && s.name) { let price = s.price || 0; const liveData = allGateETFs.find(t => t.currency_pair === s.name + "_USDT"); if (liveData) price = parseFloat(liveData.last); updateTickerUI(s.name, price, true); document.getElementById('t-dot').style.background = 'var(--brand)'; } else { updateTickerUI("SIN COIN", 0, false); } }
        function getCoinColor(name) { if (!name) return 'var(--brand)'; const upper = name.toUpperCase(); if (upper.includes('3S') || upper.includes('5S') || upper.endsWith('S')) return 'var(--short)'; if (upper.includes('3L') || upper.includes('5L') || upper.endsWith('L')) return 'var(--long)'; return 'var(--brand)'; }
        function loadActiveOrders() { const storageKey = 'c5x_active_orders_real'; const saved = localStorage.getItem(storageKey); if (saved) { try { activeOrders = JSON.parse(saved); } catch (e) { activeOrders = {}; } } else { activeOrders = {}; } }
        function saveActiveOrders() { const storageKey = 'c5x_active_orders_real'; localStorage.setItem(storageKey, JSON.stringify(activeOrders)); }
        function updateLevelsUI() { const levelCards = document.querySelectorAll('[data-level-index]'); levelCards.forEach((card, index) => { card.classList.remove('order-selected', 'order-pending', 'order-filled', 'order-error', 'is-filled', 'is-pending', 'bought'); const badge = card.querySelector('.order-status-badge'); if (badge) badge.remove(); const key = getOrderKey(activeIdx, index); const s = slots[activeIdx]; const isBought = s.buys && s.buys.includes(index); if (activeOrders[key]) { const order = activeOrders[key]; if (order.status === 'open') { updateLevelStatus(index, 'pending', 'PENDIENTE'); card.classList.add('is-pending'); } else if (order.status === 'filled') { updateLevelStatus(index, 'filled', 'EJECUTADA ✓'); card.classList.add('is-filled'); } } else if (isBought) { card.classList.add('is-filled'); } }); }
        function loadSellOrder() { const saved = localStorage.getItem('c5x_sell_order'); if (saved) { try { const sellOrder = JSON.parse(saved); const sellIcon = document.getElementById('sellIcon'); const targetSection = document.getElementById('targetSection-' + activeIdx); if (sellOrder.status === 'open') { if(sellIcon) sellIcon.textContent = '⏳'; targetSection.style.borderColor = 'var(--long)'; targetSection.style.background = 'linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(14, 203, 129, 0.1))'; showToast("📊 Orden de venta activa"); monitorSellOrder(sellOrder.orderId, sellOrder.symbol); } } catch (e) { console.error("Error cargando orden de venta:", e); } } }
        
        function selectSlot(i) { 
            triggerHaptic(); 
            activeIdx = i; 
            localStorage.setItem('c5x_last_slot', i); 
            
            // MOSTRAR niveles por defecto al cambiar de slot
            const levelsContainer = document.getElementById('levelsGrid'); 
            if (levelsContainer) levelsContainer.classList.remove('collapsed'); 
            
            const s = slots[i]; 
            const cInput = document.getElementById('coinInput'); 
            if (cInput) { cInput.value = s.name; cInput.setAttribute('readonly', true); cInput.classList.remove('editing-mode'); cInput.classList.add('locked-input'); }
            
            const bInput = document.getElementById('baseInput'); 
            if (bInput) {
                // SIEMPRE mostrar el precio real del slot — nunca dejarlo vacío si hay precio
                bInput.value = (s.price > 0) ? s.price : '';
                bInput.setAttribute('readonly', true);
                bInput.classList.add('locked-input');
                bInput.classList.remove('manual-edit');
            }
            
            const capInput = document.getElementById('capitalInput');
            if (capInput) capInput.value = s.capital; 
            
            const indicator = document.getElementById('priceAdjustIndicator'); 
            if (indicator) { 
                if (s.priceAdjusted && s.initialPrice) { 
                    const dropPercent = (((s.price - s.initialPrice) / s.initialPrice) * 100); 
                    indicator.style.display = 'block'; 
                    indicator.title = `Ajustado automáticamente de $${s.initialPrice.toFixed(4)} (${dropPercent.toFixed(1)}%)`; 
                } else { 
                    indicator.style.display = 'none'; 
                } 
            } 
            
            // Resaltar tarjeta activa en el multi-dashboard
            document.querySelectorAll('.dashboard-card').forEach((card, idx) => {
                card.classList.toggle('slot-active', idx === i);
                const lbl = card.querySelector('.dash-slot-label');
                if (lbl) lbl.textContent = `SLOT ${idx+1}${idx === i ? ' ● ACTIVO' : ''}`;
                const btn = card.querySelector('[id^="tradingModeBtn-"]');
                if (btn) btn.style.opacity = idx === i ? '1' : '0.5';
            });
            
            loadChart(s.name); 
            // Chart2 (Panel 3) siempre refleja el slot activo
            if (currentPanel === 2) { setTimeout(() => loadChart2(getChart2Symbol()), 100); }
            updateDashUI(); 
            updateTickerWithActiveCoin(); 
            renderLevels();
            
            // Actualizar UI del objetivo de venta si hay uno activo para este slot
            const targetSection = document.getElementById('targetSection-' + i);
            const resTarget = document.getElementById('resTarget-' + i);
            if (activeSellTarget && activeSellTarget.slotIndex === i) {
                if (targetSection) {
                    targetSection.style.borderColor = 'var(--long)';
                    targetSection.style.background = 'linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(14, 203, 129, 0.1))';
                }
                if (resTarget && activeSellTarget.targetPrice) {
                    resTarget.textContent = activeSellTarget.targetPrice.toFixed(6);
                }
            } else {
                if (targetSection) {
                    targetSection.style.borderColor = '';
                    targetSection.style.background = '';
                }
            }
        }
        function updateCoin() { const el = document.getElementById('coinInput'); let val = el.value.toUpperCase().replace('USDT','').trim(); el.value = val; slots[activeIdx].name = val; save();  loadChart(val); calculate(); }
        function rotateDash() { 
            // Solo estrategia normal disponible - función mantenida para compatibilidad
            triggerHaptic(); 
            showToast(`⚡ ESTRATEGIA: NORMAL`); 
        }
        function calculate() {
            const s = slots[activeIdx];
            const baseInput = document.getElementById('baseInput');
            if (!baseInput || baseInput.classList.contains('manual-edit')) return;
            const inputVal = parseFloat(baseInput.value);
            const newPrice = isNaN(inputVal) ? 0 : inputVal;
            // PROTECCIÓN: si el slot tiene buys o niveles activos, NUNCA resetear a 0
            const hasActivity = (s.buys && s.buys.length > 0) ||
                Object.keys(activeOrders).some(k => k.startsWith('s' + activeIdx + '_'));
            if (newPrice === 0 && hasActivity) {
                // Restaurar el input con el precio actual del slot
                if (s.price > 0) baseInput.value = s.price;
                renderLevels();
                return;
            }
            if (newPrice === 0 && s.price > 0 && !baseInput.classList.contains('manual-edit')) {
                // Input vacío pero slot tiene precio — no sobreescribir
                baseInput.value = s.price;
                renderLevels();
                return;
            }
            if (newPrice > 0) {
                if (s.price === 0 && !s.initialPrice) s.initialPrice = newPrice;
                s.price = newPrice;
                save();
            }
            renderLevels();
            updateDashboardStats();
            baseInput.setAttribute('readonly', true);
            baseInput.classList.add('locked-input');
        }
        function getStrategyParams(stratType) { return strategyParams.normal; }
        function getStepForLevel(stratType, levelIndex) { 
            const params = strategyParams.normal; 
            if (levelIndex <= 0) {
                return 0; // Nivel 1 = precio base, sin caída
            } else if (levelIndex === 1) { 
                return params.desc; 
            } else { 
                return params.desc + (params.inc * (levelIndex - 1)); 
            } 
        }
        function toggleTickerPin() { triggerHaptic(); isTickerPinned = !isTickerPinned; localStorage.setItem('c5x_ticker_pinned', isTickerPinned); const pill = document.getElementById('mainTickerPill'); if(isTickerPinned) { const currentSym = document.getElementById('t-sym').textContent; const foundIdx = tickerAssets.indexOf(currentSym); if(foundIdx !== -1) { assetIdx = foundIdx; localStorage.setItem('c5x_ticker_index', assetIdx); } pill.classList.add('pinned-mode'); if(navigator.vibrate) navigator.vibrate([50,50]); showToast("⚓ PRECIO FIJADO: " + currentSym); } else { pill.classList.remove('pinned-mode'); showToast("▶️ ROTACIÓN ACTIVADA"); updateTicker(); } }
        function updatePinUI() { const pill = document.getElementById('mainTickerPill'); if(isTickerPinned) pill.classList.add('pinned-mode'); else pill.classList.remove('pinned-mode'); }
        function viewTickerChart(e) { if(e) e.stopPropagation(); chartSymbol = currentTickerSymbol.toUpperCase(); loadChart(chartSymbol); if(currentSection !== 'operate') switchView('operate', false); }
        function updateTF(tf, btn) { triggerHaptic(); activeTF = tf; localStorage.setItem('c5x_last_tf', tf); document.querySelectorAll('.tf-btn').forEach(b => { b.classList.remove('active'); if(b.dataset.tf === tf) b.classList.add('active'); }); loadChart(chartSymbol); if (currentPanel === 2) { setTimeout(() => loadChart2(getChart2Symbol()), 150); } }
        let tvWidget = null;
        let tvWidget2 = null;
        // Símbolo para Chart2 (Panel 3): slot activo o BTC5L si vacío
        function getChart2Symbol() {
            const name = slots[activeIdx] && slots[activeIdx].name;
            return name ? name.toUpperCase() : 'BTC5L';
        }

        function loadChart(coin) { chartSymbol = (coin || 'BTC3L').toUpperCase(); if(tvWidget) { try{ tvWidget.remove(); }catch(e){} } if(typeof TradingView !== 'undefined') { tvWidget = new TradingView.widget({ "autosize": true, "symbol": `GATEIO:${chartSymbol.replace('USDT','') }USDT`, "interval": activeTF, "theme": isLight ? "light" : "dark", "container_id": "tv_chart", "hide_top_toolbar": true, "backgroundColor": isLight ? "#F2F0E9" : "#0b0e11", "locale": "es", "disabled_features": ["use_localstorage_for_settings"], "enabled_features": ["study_templates"] }); } setTimeout(() => { addTradingLevelsToChart(); }, 500); }
        function loadChart2(coin) { const sym = (coin || chartSymbol || 'BTC3L').toUpperCase(); if(tvWidget2) { try{ tvWidget2.remove(); }catch(e){} } if(typeof TradingView !== 'undefined') { tvWidget2 = new TradingView.widget({ "autosize": true, "symbol": `GATEIO:${sym.replace('USDT','') }USDT`, "interval": activeTF, "theme": isLight ? "light" : "dark", "container_id": "tv_chart2", "hide_top_toolbar": true, "backgroundColor": isLight ? "#F2F0E9" : "#0b0e11", "locale": "es", "disabled_features": ["use_localstorage_for_settings"], "enabled_features": ["study_templates"] }); } }
        function addTradingLevelsToChart() { const overlay = document.getElementById('priceLinesOverlay'); if (!overlay) return; overlay.innerHTML = ''; const s = slots[activeIdx]; const avg = calculateAvgPriceForSlot(s, activeIdx); if (avg <= 0 || !s.buys || s.buys.length === 0 || !s.price) { return; } const params = getStrategyParams(s.strat); const roiTarget = params.roi; const targetPrice = avg * (1 + (roiTarget / 100)); let lowestPrice = s.price; const maxLevel = Math.max(...s.buys); let currentP = s.price; for(let i = 1; i <= maxLevel; i++) { const step = getStepForLevel(s.strat, i); currentP = currentP * (1 - (step / 100)); } lowestPrice = currentP; const priceRange = targetPrice - lowestPrice; const minPrice = lowestPrice - (priceRange * 0.1); const maxPrice = targetPrice + (priceRange * 0.1); const totalRange = maxPrice - minPrice; function getPricePosition(price) { const percentage = ((price - minPrice) / totalRange) * 100; return 100 - percentage; } const avgPos = getPricePosition(avg); const avgLine = document.createElement('div'); avgLine.className = 'price-line avg-line'; avgLine.style.top = avgPos + '%'; avgLine.innerHTML = `<div class="price-label avg">🟢 PROM: $${avg.toFixed(avg < 1 ? 6 : 4)}</div>`; overlay.appendChild(avgLine); const targetPos = getPricePosition(targetPrice); const targetLine = document.createElement('div'); targetLine.className = 'price-line target-line'; targetLine.style.top = targetPos + '%'; targetLine.innerHTML = `<div class="price-label target">🎯 +${roiTarget}%: $${targetPrice.toFixed(targetPrice < 1 ? 6 : 4)}</div>`; overlay.appendChild(targetLine); let lastPrice = s.price; s.buys.forEach((levelIdx) => { let tempP = s.price; for(let i = 1; i <= levelIdx; i++) { const step = getStepForLevel(s.strat, i); tempP = tempP * (1 - (step / 100)); } const buyPos = getPricePosition(tempP); const buyLine = document.createElement('div'); buyLine.className = 'price-line buy-line'; buyLine.style.top = buyPos + '%'; buyLine.innerHTML = `<div class="price-label buy">🔹 N${levelIdx + 1}</div>`; overlay.appendChild(buyLine); }); }
        function renderLevels() {
            const grid = document.getElementById('levelsGrid');
            let s = slots[activeIdx];
            // Sin moneda activa → usar BTC5L como default
            if (!s || !s.name) {
                let p = 0;
                if (typeof allGateETFs !== 'undefined' && allGateETFs.length > 0) {
                    const e = allGateETFs.find(t => t.currency_pair === 'BTC5L_USDT');
                    if (e) { p = parseFloat(e.last) || 0; if (p > 0) localStorage.setItem('c5x_btc5l_cache', String(p)); }
                }
                if (!p) { const c = parseFloat(localStorage.getItem('c5x_btc5l_cache')); if (c > 0) p = c; }
                if (!p) { p = 1.0; if (typeof allGateETFs !== 'undefined' && !allGateETFs.length) setTimeout(renderLevels, 2000); }
                s = { name: 'BTC5L', price: p, strat: 'normal', buys: [], multipleBuys: {} };
            }
            if (s.price <= 0) { grid.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-tertiary)">DEFINE PRECIO BASE</div>'; return; } const limit = customMultipliers ? customMultipliers.length : 12; let html = ''; let currentPrice = s.price; let totalInvested = 0; let totalQty = 0; const params = getStrategyParams(s.strat); for (let i = 0; i < limit; i++) { let levelPrice, step; if (i === 0) { levelPrice = s.price; step = 0; } else { step = getStepForLevel(s.strat, i); levelPrice = currentPrice * (1 - (step / 100)); } currentPrice = levelPrice; let multiplier = customMultipliers ? (customMultipliers[i] || 1) : 1; let levelCapital = params.capital * multiplier; let qty = levelCapital / levelPrice; const key = getOrderKey(activeIdx, i); let badgeHtml = ''; let cardStateClass = ''; const isBoughtLegacy = s.buys.includes(i); const canBuyMultiple = (i >= 6 && i <= 11); // NIVELES 7-12
            let buyCount = 0; let accumulatedUSDT = 0; let accumulatedQty = 0; if (canBuyMultiple && s.multipleBuys && s.multipleBuys[i]) { buyCount = s.multipleBuys[i].length; for (let buy of s.multipleBuys[i]) { accumulatedUSDT += buy.usd; accumulatedQty += buy.qty; } } if(activeOrders[key]) { const status = activeOrders[key].status === 'open' ? 'PENDIENTE' : 'EJECUTADA ✓'; const cssClass = activeOrders[key].status === 'open' ? 'pending' : 'filled'; badgeHtml = `<div class="order-status-badge ${cssClass}">${status}</div>`; if(activeOrders[key].status === 'filled') { cardStateClass = 'is-filled'; totalInvested += levelCapital; totalQty += qty; } else { cardStateClass = 'is-pending'; } } else if (isBoughtLegacy || buyCount > 0) { cardStateClass = 'is-filled'; if (buyCount > 0) { totalInvested += accumulatedUSDT; totalQty += accumulatedQty; } else { totalInvested += levelCapital; totalQty += qty; } } const displayPrice = (levelPrice < 1) ? levelPrice.toFixed(6) : levelPrice.toFixed(4); let displayStep = step; const buyTimesLabel = ''; const multiBuyBadge = (canBuyMultiple && buyCount > 0) ? `<div class="multi-buy-indicator">${buyCount}</div>` : ''; const accumulatedLabel = (canBuyMultiple && accumulatedUSDT > 0) ? `<div class="u-val-accumulated">+$${accumulatedUSDT.toFixed(2)}</div>` : ''; html += `<div class="unified-card ${cardStateClass}" data-level-index="${i}" ontouchstart="startLevelPress(event, ${i})" ontouchend="endLevelPress(event)" onmousedown="startLevelPress(event, ${i})" onmouseup="endLevelPress(event)" onmouseleave="cancelLevelPress()"><div class="u-index">${i + 1}${canBuyMultiple ? '<br><small style="font-size:7px;">×4</small>' : ''}</div><div class="u-center"><div class="u-title" style="font-size:18px;">$${displayPrice}</div><div class="u-sub">CANT: ${(canBuyMultiple && buyCount > 0 ? accumulatedQty : qty).toFixed(4)}</div></div><div class="u-right">${multiBuyBadge}<div class="u-val-primary">$${(canBuyMultiple && accumulatedUSDT > 0 ? accumulatedUSDT : levelCapital).toFixed(2)}</div><div class="u-val-secondary" style="color:var(--short)">-${displayStep.toFixed(0)}%</div></div>${badgeHtml}</div>`; } grid.innerHTML = html; updateLevelsUI(); }
        function getLevelData(s, i) { let currentPrice = s.price; const limit = customMultipliers ? customMultipliers.length : 12; for (let k = 0; k <= i; k++) { if (k === 0) { currentPrice = s.price; } else { const step = getStepForLevel(s.strat, k); currentPrice = currentPrice * (1 - (step / 100)); } } const params = getStrategyParams(s.strat); let multiplier = customMultipliers ? (customMultipliers[i] || 1) : 1; let levelCapital = params.capital * multiplier; return { price: currentPrice, qty: levelCapital / currentPrice, usd: levelCapital }; }
        function updateDashboardStats(currentMarketPrice = null) {
            // Actualizar slot activo inmediatamente
            updateDashboardStatsForSlot(activeIdx, currentMarketPrice);
            // Programar refresh de los demás slots y dashboard general en siguiente tick
            setTimeout(() => {
                for (let i = 0; i < 5; i++) { if (i !== activeIdx) updateDashboardStatsForSlot(i); }
                if (typeof refreshAllDashboardData === 'function') refreshAllDashboardData();
            }, 50);
        }

        function updateDashboardStatsForSlot(slotIdx, currentMarketPrice = null) { 
            const slot = slots[slotIdx]; 
            const suffix = '-' + slotIdx;
            const invEl = document.getElementById('resInv' + suffix);
            const avgEl = document.getElementById('resAvg' + suffix);
            const targetEl = document.getElementById('resTarget' + suffix);
            if (!invEl) return;
            if (!slot || !slot.name) { 
                invEl.textContent = '$0.00'; 
                avgEl.textContent = '0.0000'; 
                targetEl.textContent = '0.0000'; 
                if (slotIdx === activeIdx) updateTradingInfoDisplay(); 
                return; 
            } 
            let totalInvested = 0; 
            let totalQuantity = 0; 
            for (let i = 0; i < 12; i++) { 
                const key = getOrderKey(slotIdx, i); 
                const canBuyMultiple = (i >= 6 && i <= 11);
                if (activeOrders[key] && activeOrders[key].status === 'filled') { 
                    const order = activeOrders[key]; 
                    totalInvested += order.price * order.amount; 
                    totalQuantity += order.amount; 
                } else if (slot.buys && slot.buys.includes(i) && !activeOrders[key]) { 
                    const d = getLevelData(slot, i); 
                    totalInvested += d.usd; 
                    totalQuantity += d.qty; 
                }
                if (canBuyMultiple && slot.multipleBuys && slot.multipleBuys[i]) {
                    for (let buy of slot.multipleBuys[i]) {
                        totalInvested += buy.usd;
                        totalQuantity += buy.qty;
                    }
                }
            } 
            invEl.textContent = totalInvested > 0 ? `$${totalInvested.toFixed(2)}` : '$0.00'; 
            const avgPrice = totalQuantity > 0 ? totalInvested / totalQuantity : 0; 
            avgEl.textContent = avgPrice > 0 ? ((avgPrice < 0.0001) ? avgPrice.toFixed(10).replace(/\.?0+$/, "") : (avgPrice < 1) ? avgPrice.toFixed(6) : avgPrice.toFixed(4)) : '0.0000'; 
            const currentRoi = strategyParams.normal.roi;
            const targetPrice = avgPrice * (1 + (currentRoi / 100)); 
            targetEl.textContent = targetPrice > 0 ? ((targetPrice < 0.0001) ? targetPrice.toFixed(10).replace(/\.?0+$/, "") : (targetPrice < 1) ? targetPrice.toFixed(6) : targetPrice.toFixed(4)) : '0.0000'; 
            // Actualizar coin y base para este slot
            const coinEl = document.getElementById('dashTradingCoin' + suffix);
            if (coinEl) { coinEl.textContent = slot.name || '---'; coinEl.style.color = getCoinColor(slot.name); }
            const baseEl = document.getElementById('dashBaseDisplay' + suffix);
            if (baseEl) { baseEl.textContent = slot.price > 0 ? (slot.price < 1 ? slot.price.toFixed(6) : slot.price.toFixed(4)) : '0.0000'; }
            if (slotIdx === activeIdx) updateTradingInfoDisplay(); 
        }
        // ── REFRESCO COMPLETO DE TODOS LOS DASHBOARDS ──────────────────
        // Se llama tras cualquier compra/cambio de nivel para sincronizar
        // el Panel 2 (5 slots) y el Panel 1 (Gate.io dashboard) al instante
        function refreshAllDashboardData() {
            // 1. Actualizar los 5 slots del Panel de Dashboards
            for (let i = 0; i < 5; i++) updateDashboardStatsForSlot(i);
            // 2. Recalcular inversión activa para Gate.io
            const enUso = calcGdEnUso();
            const libre = globalCapital > 0 ? globalCapital - enUso : 0;
            const total = globalCapital > 0 ? globalCapital : enUso;
            setGdEl('gdEnUso', '$' + enUso.toFixed(2));
            if (total > 0) {
                const librePct = ((libre / total) * 100).toFixed(0);
                setGdEl('gdLibrePct', librePct + '% disponible');
            }
            const activeSlots = slots.filter(s => s.name).length;
            setGdEl('gdSlotCount', activeSlots + (activeSlots === 1 ? ' slot activo' : ' slots activos'));
            // 3. Refrescar barra de portafolio
            renderGdDualBar();
            // 4. PNL
            calcGdStats();
        }

        function switchStrategy(strategy) { 
            // Solo estrategia normal disponible
            triggerHaptic(); 
            if(navigator.vibrate) navigator.vibrate([80, 50]); 
            const s = slots[activeIdx]; 
            
            s.strat = 'normal'; 
            s.capital = strategyParams.normal.capital || 5; 
            s.roi = strategyParams.normal.roi || 100; 
            showToast(`⚡ ESTRATEGIA NORMAL - Capital: $${s.capital}`, 2500); 
            
            save(); 
            updateStrategyButtonVisuals(); 
            updateDashUI(); 
            calculate(); 
        }

        async function fetchWalletBalance() { 
            try { 
                const usdtData = await callGateApi("GET", "/spot/accounts", {currency: "USDT"}, true); 
                if (!usdtData) throw new Error("No se recibió respuesta de Gate.io"); 
                let usdtAvailable = 0; 
                let usdtRows = Array.isArray(usdtData) ? usdtData : (usdtData.result || []); 
                if (usdtRows.length > 0) { usdtAvailable = parseFloat(usdtRows[0].available); }
                globalCapital = usdtAvailable; 
                localStorage.setItem('c5x_global_capital', globalCapital); 
                const formatted = "$" + usdtAvailable.toFixed(2); 
                const elCap = document.getElementById('setGlobalCapital'); 
                if(elCap) elCap.value = usdtAvailable.toFixed(2);
                const totalBalanceEl = document.getElementById('totalBalanceDisplay');
                if (totalBalanceEl) totalBalanceEl.textContent = formatted;
                autoImportGatePositions(); 
            } catch (e) { 
                const savedCapital = globalCapital || 0; 
                const totalBalanceEl = document.getElementById('totalBalanceDisplay');
                if (totalBalanceEl) totalBalanceEl.textContent = "$" + savedCapital.toFixed(2);
            } 
        }
        async function autoImportGatePositions() { try { const balances = await callGateApi("GET", "/spot/accounts"); if(!balances || !Array.isArray(balances)) return; const activeBalances = balances.filter(b => b.currency !== 'USDT' && parseFloat(b.available) > 0.001); let imported = 0; activeBalances.forEach(bal => { const coinName = bal.currency; const exists = slots.some(s => s.name === coinName); if (!exists) { const emptyIdx = slots.findIndex(s => !s.name || s.name === ''); if (emptyIdx !== -1) { slots[emptyIdx].name = coinName; slots[emptyIdx].price = 0; slots[emptyIdx].capital = 5; slots[emptyIdx].strat = 'normal'; slots[emptyIdx].locked = true; imported++; } } }); if (imported > 0) { save(); selectSlot(activeIdx); renderAllDashboards(); showToast(`✅ ${imported} pos. importada(s)`); } } catch(e) { console.warn("Auto-Import Error", e); } }
        function setLightMode(isLightMode) { triggerHaptic(); isLight = isLightMode; if(isLight) { document.body.classList.add('light-mode'); } else { document.body.classList.remove('light-mode'); } updateThemeIcon(); localStorage.setItem('theme', isLight ? 'light' : 'dark'); if(chartSymbol) loadChart(chartSymbol); }
        let secCallback = null;
        function reqSec(cb) { secCallback = cb; const m = document.getElementById('securityModal'); document.getElementById('secInput').value = ''; m.style.display = 'flex'; void m.offsetWidth; }
        function validateSecurity() { const inp = document.getElementById('secInput').value; closeModals(); if(inp === appConfig.pin) { if(secCallback) secCallback(); } else { showToast("⛔ PIN INCORRECTO"); } }
        function saveApiKeysSecure() { reqSec(() => { const k = document.getElementById('apiKey').value.trim(); const s = document.getElementById('apiSecret').value.trim(); if(k && s) { apiConfig = { key: k, secret: s }; localStorage.setItem('c5x_api_keys', JSON.stringify(apiConfig)); showToast("✅ API Keys Guardadas"); document.getElementById('apiKey').value = ''; document.getElementById('apiSecret').value = ''; isPrivateMode = true; fetchWalletBalance(); } else { showToast("⚠️ Campos vacíos"); } }); }
        function saveGlobalCapSecure() { reqSec(() => { const val = parseFloat(document.getElementById('setGlobalCapital').value); const feeVal = parseFloat(document.getElementById('setFee').value); if(!isNaN(val)) { globalCapital = val; localStorage.setItem('c5x_global_capital', globalCapital); } if(!isNaN(feeVal)) { exchangeFee = feeVal; localStorage.setItem('c5x_fee', exchangeFee); } calculateGlobalStats(); showToast("✅ Capital y Comisión Guardados"); }); }
        function saveRadarSecure() { reqSec(() => { const lim = parseInt(document.getElementById('setRadarLimit').value); const spd = parseInt(document.getElementById('setRadarSpeed').value); const tickSpd = parseInt(document.getElementById('setTickerSpeed').value); const monLim = parseInt(document.getElementById('setMonitorLimit').value); const autoAdj = parseFloat(document.getElementById('setAutoAdjustThreshold').value); if(lim > 0) { radarLimit = lim; localStorage.setItem('c5x_radar_limit', lim); fetchAndCalcTopDroppers(); } if(spd > 0) { radarSpeed = spd; localStorage.setItem('c5x_radar_speed', spd); startRadarRotation(); } if(tickSpd > 0) { tickerSpeed = tickSpd; localStorage.setItem('c5x_ticker_speed', tickSpd); startTickerSystem(); } if(monLim > 0) { monitorLimit = monLim; localStorage.setItem('c5x_monitor_limit', monLim); } if(autoAdj > 0) { autoAdjustThreshold = autoAdj; localStorage.setItem('c5x_auto_adjust_threshold', autoAdj); } showToast("✅ Tiempos y Límites Actualizados"); }); }
        function saveMultiSecure() { reqSec(() => { const inputs = document.querySelectorAll('.multi-inp'); let newMultipliers = []; inputs.forEach(inp => { let val = parseFloat(inp.value); if(!isNaN(val)) newMultipliers.push(val); }); if(newMultipliers.length >= 5) { customMultipliers = newMultipliers; localStorage.setItem('c5x_multipliers', JSON.stringify(customMultipliers)); calculate(); showToast("✅ Multiplicadores Guardados"); } else { showToast("⚠️ Mínimo 5 Niveles"); } }); }
        function savePassSecure() { reqSec(() => { const newPass = document.getElementById('setNewPass').value; if(newPass && newPass.length === 4) { appConfig.pin = newPass; localStorage.setItem('c5x_config', JSON.stringify(appConfig)); showToast("✅ Contraseña Cambiada"); } else { showToast("⚠️ Clave debe ser 4 dígitos"); } }); }
        function saveStrategyParams(strategyType) { 
            reqSec(() => { 
                // Solo estrategia normal disponible
                if (strategyType === 'normal') { 
                    const capital = parseFloat(document.getElementById('setCapitalNormal').value); 
                    const roi = parseFloat(document.getElementById('setRoiNormal').value); 
                    const inc = parseFloat(document.getElementById('setIncNormal').value); 
                    const desc = parseFloat(document.getElementById('setDescNormal').value); 
                    const dd = parseFloat(document.getElementById('setDDNormal').value); 
                    
                    if(isNaN(capital) || isNaN(roi) || isNaN(inc) || isNaN(dd)) { 
                        return showToast("⚠️ Valores Inválidos"); 
                    } 
                    
                    strategyParams.normal = { capital, roi, inc, desc, dd }; 
                    localStorage.setItem('c5x_strategy_params', JSON.stringify(strategyParams)); 
                    showToast(`✅ Estrategia normal guardada`); 
                    
                    const currentSlot = slots[activeIdx]; 
                    if (currentSlot.strat === 'normal') { 
                        calculate(); 
                    } 
                }
            }); 
        }
        function updateStats(tf) { triggerHaptic(); document.querySelectorAll('.stat-btn').forEach(b => b.classList.remove('active')); const btns = document.querySelectorAll('.stat-btn'); if(tf === 'D') btns[0].classList.add('active'); else if(tf === 'W') btns[1].classList.add('active'); else if(tf === 'M') btns[2].classList.add('active'); else if(tf === 'A') btns[3].classList.add('active'); const chart = document.getElementById('pnlChart'); chart.innerHTML = ''; const now = new Date(); let totalNet = 0; let wins = 0, total = 0; const filtered = history.filter(h => { if(!h.date) return false; const parts = h.date.split('/'); const hDate = new Date(parts[2], parts[1]-1, parts[0]); const diffTime = Math.abs(now - hDate); const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); if(tf === 'D' && diffDays <= 7) return true; if(tf === 'W' && diffDays <= 60) return true; if(tf === 'M' && diffDays <= 365) return true; if(tf === 'A') return true; return false; }).reverse(); let groups = {}; filtered.forEach(h => { let key = h.date; if(tf === 'M' || tf === 'A') { const parts = h.date.split('/'); key = parts[1] + '/' + parts[2].substring(2); } if(!groups[key]) groups[key] = 0; const p = (h.netProfit !== undefined) ? parseFloat(h.netProfit) : (parseFloat(h.profit) || 0); groups[key] += p; totalNet += p; total++; if(p > 0) wins++; }); const keys = Object.keys(groups); const maxVal = Math.max(...Object.values(groups).map(Math.abs), 1); keys.forEach(k => { const val = groups[k]; const heightPct = (Math.abs(val) / maxVal) * 100; const bar = document.createElement('div'); bar.className = `chart-bar ${val >= 0 ? 'win' : 'loss'}`; bar.style.height = Math.max(heightPct, 5) + '%'; bar.setAttribute('data-val', (val>=0?'+':'') + Math.round(val)); chart.appendChild(bar); }); if(keys.length === 0) chart.innerHTML = '<div style="width:100%; text-align:center; color:var(--text-tertiary); font-size:10px; padding-bottom:20px;">SIN ACTIVIDAD RECIENTE</div>'; const netEl = document.getElementById('chartNeto'); netEl.textContent = (totalNet>=0?'+':'') + '$' + totalNet.toFixed(2); netEl.style.color = totalNet >= 0 ? 'var(--long)' : 'var(--short)'; document.getElementById('chartWr').textContent = total > 0 ? Math.round((wins/total)*100) + '%' : '0%'; }
        function openMenuViaButton() { document.getElementById('navModal').style.display = 'flex'; }
        function closeMenuViaButton() { document.getElementById('navModal').style.display = 'none'; switchView('operate'); }

        // ── NAVEGACIÓN CON HISTORIAL DEL NAVEGADOR ──────────────────────
        // Permite que el botón Atrás del móvil regrese al dashboard
        // en lugar de cerrar la app.

        function switchView(viewName) {
            triggerHaptic();
            document.getElementById('navModal').style.display = 'none';
            closeUserMenu();

            // Si ya estamos en esa sección, no hacer nada
            if (currentSection === viewName) return;

            // Empujar estado al historial del navegador
            // (solo si vamos a una sección diferente de operate)
            if (viewName !== 'operate') {
                window.history.pushState({ c5xView: viewName }, '', '#' + viewName);
            } else {
                // Al volver a operate: reemplazar estado para no acumular
                window.history.replaceState({ c5xView: 'operate' }, '', window.location.pathname);
            }

            updateViewVisuals(viewName);
        }

        function updateViewVisuals(viewName) {
            currentSection = viewName;
            document.querySelectorAll('.app-section').forEach(el => el.classList.remove('active'));
            const section = document.getElementById('section-' + viewName);
            if (section) section.classList.add('active');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('selected'));
            const navItem = document.getElementById('nav-' + viewName);
            if (navItem) navItem.classList.add('selected');
            const spacer = document.querySelector('.content-spacer');
            if (spacer) spacer.style.marginTop = '60px';
            if (viewName === 'operate') {
                if (chartSymbol) loadChart(chartSymbol);
                if (currentPanel === 2) forceRenderLevels(activeIdx);
            }
            if (viewName === 'etf') loadGateETFs();
            if (viewName === 'settings') { loadSettingsValues(); renderTickerSettings(); updateCloudUI(); updateCloudStats(); applyRoleVisibility(); }
            if (viewName === 'log') updateStats('D');
            if (viewName === 'chat') initChatSection();
            updateETFFloatButtonVisibility();
            window.scrollTo(0, 0);
        }

        // Botón Atrás del sistema (Android/iOS/PC)
        window.onpopstate = function(event) {
            // Cerrar modal de menú si está abierto
            document.getElementById('navModal').style.display = 'none';
            closeUserMenu();

            const estado = event.state;

            if (estado && estado.c5xView && estado.c5xView !== 'operate') {
                // Hay un estado previo que no es operate → navegar a él
                updateViewVisuals(estado.c5xView);
            } else {
                // Sin estado o es operate → volver al dashboard principal
                updateViewVisuals('operate');
                // Asegurar que exista un estado base para no salir con el siguiente Atrás
                window.history.replaceState({ c5xView: 'operate' }, '', window.location.pathname);
            }
        };
        function setupSwipe() { document.addEventListener('touchstart', e => { window.touchStartX = e.changedTouches[0].screenX; window.touchStartY = e.changedTouches[0].screenY; }, {passive: true}); document.addEventListener('touchend', e => { let touchEndX = e.changedTouches[0].screenX; let touchEndY = e.changedTouches[0].screenY; handleSwipe(window.touchStartX, window.touchStartY, touchEndX, touchEndY); }, {passive: true}); }
        function handleSwipe(tsX, tsY, teX, teY) { 
            const threshold = 60; 
            const diffX = teX - tsX; 
            const diffY = teY - tsY; 
            
            // Ignorar si es más vertical que horizontal
            if (Math.abs(diffY) > Math.abs(diffX)) return; 
            
            // En sección OPERAR: navegar entre slots
            if (currentSection === 'operate') { 
                const occupiedIndices = slots.map((s, i) => s.name ? i : -1).filter(i => i !== -1); 
                if (occupiedIndices.length === 0) { 
                    if (diffX < -threshold) { 
                        let next = activeIdx + 1; 
                        if(next > 4) next = 0; 
                        selectSlot(next); 
                    } else if (diffX > threshold) { 
                        let prev = activeIdx - 1; 
                        if(prev < 0) prev = 4; 
                        selectSlot(prev); 
                    } 
                    return; 
                } 
                let currentPos = occupiedIndices.indexOf(activeIdx); 
                if (diffX < -threshold) { 
                    let nextIndex; 
                    if (currentPos === -1) { 
                        nextIndex = occupiedIndices[0]; 
                    } else { 
                        let nextPos = currentPos + 1; 
                        if (nextPos >= occupiedIndices.length) nextPos = 0; 
                        nextIndex = occupiedIndices[nextPos]; 
                    } 
                    selectSlot(nextIndex); 
                } else if (diffX > threshold) { 
                    let prevIndex; 
                    if (currentPos === -1) { 
                        prevIndex = occupiedIndices[occupiedIndices.length - 1]; 
                    } else { 
                        let prevPos = currentPos - 1; 
                        if (prevPos < 0) prevPos = occupiedIndices.length - 1; 
                        prevIndex = occupiedIndices[prevPos]; 
                    } 
                    selectSlot(prevIndex); 
                } 
            } 
            // En otras secciones: navegar entre secciones principales
            else { 
                const sections = ['operate', 'etf', 'log', 'settings'];
                const currentIdx = sections.indexOf(currentSection);
                
                if (diffX < -threshold) {
                    // Swipe izquierda: siguiente sección
                    const nextIdx = (currentIdx + 1) % sections.length;
                    switchView(sections[nextIdx]);
                } else if (diffX > threshold) {
                    // Swipe derecha: sección anterior
                    const prevIdx = (currentIdx - 1 + sections.length) % sections.length;
                    switchView(sections[prevIdx]);
                }
            } 
        }
        async function requestWakeLock() { try { if ('wakeLock' in navigator) await navigator.wakeLock.request('screen'); } catch (err) {} }
        function unlockAudioAndWake() { const audio = document.getElementById('alertSound'); if(audio) { audio.play().then(() => { audio.pause(); audio.currentTime = 0; }).catch(e=>{}); } if("Notification" in window && Notification.permission !== "granted") { Notification.requestPermission(); } requestWakeLock(); }
        function showToast(txt, duration = 2500, isAlert = false, isSuccess = false) { const t = document.getElementById("toast"); t.textContent = txt; t.className = ""; if(isAlert) t.classList.add("alert-mode"); if(isSuccess) t.classList.add("success-mode"); t.classList.add("show"); setTimeout(() => { t.classList.remove("show"); }, duration); }
        
        function sortSlots() { const filled = slots.filter(s => s.name && s.name !== ''); const empty = slots.filter(s => !s.name || s.name === ''); slots = [...filled, ...empty]; save();  }
        
        function calculateGlobalStats() { let totalRealizedProfit = history.reduce((sum, item) => { return sum + (item.netProfit !== undefined ? parseFloat(item.netProfit) : (parseFloat(item.profit) || 0)); }, 0); let currentEquity = globalCapital + totalRealizedProfit; }
        
        function cleanSlotOnly() { 
            triggerHaptic(); 
            if(confirm("¿Limpiar datos del Slot actual?")) { 
                const currentStrat = slots[activeIdx].strat || 'normal'; 
                const currentCapital = strategyParams.normal.capital; 
                const currentRoi = strategyParams.normal.roi; 
                slots[activeIdx] = { name:'', price:0, capital: currentCapital, buys:[], strat: currentStrat, locked: true, roi: currentRoi, note: '', alerted: false, multipleBuys: {} }; 
                
                for (let i = 0; i < 12; i++) {
                    const key = getOrderKey(activeIdx, i);
                    if (activeOrders[key]) delete activeOrders[key];
                }
                saveActiveOrders();
                
                sortSlots();
                
                selectSlot(0);
                
                showToast("🗑️ Slot Limpiado y reordenado"); 
            } 
        }
        
        async function fetchAndCalcTopDroppers() { 
            const elVal = document.getElementById('radarValue'); 
            const elStatus = document.getElementById('radarStatus'); 
            const radarContainer = document.getElementById('radarTickerContainer'); 
            elStatus.className = 'radar-status-dot offline'; 
            
            try { 
                const res = await callGateApi("GET", "/spot/tickers"); 
                let tickers = Array.isArray(res) ? res : (res.result || res.data || []); 
                if(tickers.length === 0) throw new Error("No data"); 
                
                elStatus.className = 'radar-status-dot online'; 
                
                // Obtener info de BTC y ETH para correlación
                const btcTicker = tickers.find(t => t.currency_pair === 'BTC_USDT');
                const ethTicker = tickers.find(t => t.currency_pair === 'ETH_USDT');
                const btcChange = btcTicker ? parseFloat(btcTicker.change_percentage) : 0;
                const ethChange = ethTicker ? parseFloat(ethTicker.change_percentage) : 0;
                const btcVolume = btcTicker ? parseFloat(btcTicker.quote_volume) : 0;
                
                console.log(`📊 BTC: ${btcChange.toFixed(2)}% | ETH: ${ethChange.toFixed(2)}% | BTC Vol: $${(btcVolume/1e9).toFixed(2)}B`);
                
                allGateETFs = tickers.filter(t => { 
                    const pair = t.currency_pair; 
                    return pair.endsWith('_USDT') && (pair.includes('3L') || pair.includes('3S') || pair.includes('5L') || pair.includes('5S')); 
                }).map(t => { 
                    const change = parseFloat(t.change_percentage); 
                    const volume = parseFloat(t.quote_volume); 
                    const price = parseFloat(t.last);
                    const high24h = parseFloat(t.high_24h);
                    const low24h = parseFloat(t.low_24h);
                    const leverage = t.currency_pair.match(/5[LS]/) ? 5 : 3; 
                    const isShort = t.currency_pair.includes('S');
                    const isLong = t.currency_pair.includes('L');
                    const baseCoin = t.currency_pair.replace('_USDT', '').replace(/[35][LS]/, '');
                    
                    // Determinar el cambio del activo principal
                    let mainCoinChange = 0;
                    if (baseCoin === 'BTC') mainCoinChange = btcChange;
                    else if (baseCoin === 'ETH') mainCoinChange = ethChange;
                    else mainCoinChange = btcChange * 0.8; // Aproximación para otros
                    
                    let score = 0; 
                    let zone = 'WARM';
                    let isGoldenOpportunity = false;
                    
                    // ===========================================
                    // SISTEMA AVANZADO DE DETECCIÓN DE OPORTUNIDADES
                    // ===========================================
                    
                    // 1. ANÁLISIS DE CORRELACIÓN CON ACTIVO PRINCIPAL
                    let correlationScore = 0;
                    if (isShort && mainCoinChange > 30) correlationScore = 40;
                    else if (isShort && mainCoinChange > 25) correlationScore = 35;
                    else if (isShort && mainCoinChange > 20) correlationScore = 25;
                    else if (isLong && mainCoinChange < -30) correlationScore = 40;
                    else if (isLong && mainCoinChange < -25) correlationScore = 35;
                    else if (isLong && mainCoinChange < -20) correlationScore = 25;
                    else if (isShort && mainCoinChange > 0) correlationScore = 5;
                    else if (isLong && mainCoinChange < 0) correlationScore = 5;
                    
                    // 2. ANÁLISIS DE CAÍDA (Factor más importante)
                    let dropScore = 0;
                    if (change < -85) dropScore = 50;
                    else if (change < -80) dropScore = 45;
                    else if (change < -75) dropScore = 40;
                    else if (change < -70) dropScore = 35;
                    else if (change < -65) dropScore = 30;
                    else if (change < -60) dropScore = 25;
                    else if (change < -55) dropScore = 20;
                    else if (change < -50) dropScore = 15;
                    else dropScore = 10;
                    
                    // 3. ANÁLISIS DE VOLUMEN (Liquidez)
                    let volumeScore = 0;
                    if (volume > 20000000) volumeScore = 20;
                    else if (volume > 15000000) volumeScore = 18;
                    else if (volume > 10000000) volumeScore = 15;
                    else if (volume > 7000000) volumeScore = 12;
                    else if (volume > 5000000) volumeScore = 10;
                    else if (volume > 3000000) volumeScore = 8;
                    else if (volume > 1000000) volumeScore = 5;
                    else volumeScore = 2;
                    
                    // 4. ANÁLISIS DE VOLATILIDAD (24h range)
                    const volatilityRange = high24h > 0 ? ((high24h - low24h) / low24h) * 100 : 0;
                    let volatilityScore = 0;
                    if (volatilityRange > 100) volatilityScore = 15; // Altísima volatilidad
                    else if (volatilityRange > 80) volatilityScore = 12;
                    else if (volatilityRange > 60) volatilityScore = 10;
                    else if (volatilityRange > 40) volatilityScore = 8;
                    else if (volatilityRange > 20) volatilityScore = 5;
                    else volatilityScore = 2;
                    
                    // 5. BONUS POR APALANCAMIENTO
                    const leverageScore = leverage === 5 ? 10 : 5;
                    
                    // 6. ANÁLISIS DE MOMENTUM (RSI simulado basado en posición en el rango)
                    let rsiSimulated = 50;
                    if (high24h > low24h && high24h > 0) {
                        rsiSimulated = ((price - low24h) / (high24h - low24h)) * 100;
                    }
                    let momentumScore = 0;
                    if (rsiSimulated < 10) momentumScore = 10; // Extrema sobreventa
                    else if (rsiSimulated < 20) momentumScore = 8;
                    else if (rsiSimulated < 30) momentumScore = 5;
                    else if (rsiSimulated < 40) momentumScore = 3;
                    
                    // 7. BONUS POR CONTEXTO DE MERCADO
                    let marketContextScore = 0;
                    const btcIsExtreme = Math.abs(btcChange) > 15;
                    if (btcIsExtreme && btcVolume > 5e9) marketContextScore = 5; // Mercado muy activo
                    
                    // ===========================================
                    // CÁLCULO DE SCORE TOTAL
                    // ===========================================
                    score = dropScore + volumeScore + correlationScore + volatilityScore + 
                            leverageScore + momentumScore + marketContextScore;
                    
                    // ===========================================
                    // DETECCIÓN DE OPORTUNIDADES
                    // ===========================================
                    if (change < -75 && correlationScore >= 35) {
                        isGoldenOpportunity = true;
                        score = 100;
                        console.log(`🔥 OPORTUNIDAD: ${t.currency_pair} | Caída: ${change.toFixed(1)}% | ${baseCoin}: ${mainCoinChange > 0 ? '+' : ''}${mainCoinChange.toFixed(1)}% | Vol: $${(volume/1e6).toFixed(1)}M`);
                    }
                    
                    else if (change < -70 && correlationScore >= 40) {
                        isGoldenOpportunity = true;
                        score = 100;
                        console.log(`🔥 OPORTUNIDAD (alt): ${t.currency_pair} | Caída: ${change.toFixed(1)}% | Correlación perfecta`);
                    }
                    
                    // ===========================================
                    // CLASIFICACIÓN POR ZONAS
                    // ===========================================
                    if (isGoldenOpportunity) {
                        zone = 'GOLD';
                    } else if (score >= 80) {
                        zone = 'HOT';
                    } else if (score >= 60) {
                        zone = 'WARM';
                    } else {
                        zone = 'COOL'; // Nueva zona para oportunidades menores
                    }
                    
                    return { 
                        ...t, 
                        score: Math.min(score, 100), 
                        zone: zone,
                        isGolden: isGoldenOpportunity,
                        btcCorrelation: isShort ? mainCoinChange : -mainCoinChange,
                        mainCoin: baseCoin,
                        mainCoinChange: mainCoinChange,
                        volatilityRange: volatilityRange,
                        rsiSimulated: rsiSimulated,
                        // Factores de análisis para debugging
                        factors: {
                            drop: dropScore,
                            volume: volumeScore,
                            correlation: correlationScore,
                            volatility: volatilityScore,
                            leverage: leverageScore,
                            momentum: momentumScore,
                            context: marketContextScore
                        }
                    }; 
                }); 
                
                // FILTRAR SOLO CAÍDAS
                const allCaiders = allGateETFs.filter(t => { 
                    const change = parseFloat(t.change_percentage); 
                    return change < 0; // Todas las caídas
                }); 
                
                // ORDENAR POR MAYOR CAÍDA (más negativo primero)
                allCaiders.sort((a, b) => {
                    const changeA = parseFloat(a.change_percentage);
                    const changeB = parseFloat(b.change_percentage);
                    return changeA - changeB; // Menor valor (más negativo) primero
                });
                
                // TOMAR LOS 6 QUE MÁS HAN CAÍDO (últimas 6 oportunidades en 24h)
                topDroppers = allCaiders.slice(0, 6);
                // Cache BTC5L price for renderLevels default
                const _b5l = allGateETFs.find(t => t.currency_pair === 'BTC5L_USDT');
                if (_b5l && parseFloat(_b5l.last) > 0) {
                    localStorage.setItem('c5x_btc5l_cache', _b5l.last);
                    if (typeof currentPanel !== 'undefined' && currentPanel === 2 && slots[activeIdx] && !slots[activeIdx].name) renderLevels();
                }
                
                // LOGGING DETALLADO
                console.log(`━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━`);
                console.log(`📊 RADAR ACTUALIZADO - ${new Date().toLocaleTimeString()}`);
                console.log(`━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━`);
                console.log(`Total oportunidades: ${topDroppers.length}`);
                console.log(`🔥 OPORTUNIDADES: ${topDroppers.filter(t => t.isGolden).length}`);
                console.log(`🟡 HOT: ${topDroppers.filter(t => t.zone === 'HOT' && !t.isGolden).length}`);
                console.log(`⚪ WARM: ${topDroppers.filter(t => t.zone === 'WARM').length}`);
                
                // Mostrar top 3 con detalles
                topDroppers.slice(0, 3).forEach((t, i) => {
                    const emoji = t.zone === 'GOLD' ? '🔥' : t.zone === 'HOT' ? '🟡' : '⚪';
                    console.log(`${emoji} #${i+1}: ${t.currency_pair} | Score: ${t.score} | ${parseFloat(t.change_percentage).toFixed(1)}% | $${(parseFloat(t.quote_volume)/1e6).toFixed(1)}M`);
                });
                console.log(`━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━`);
                
                radarQueue = [...topDroppers]; 
                dropperIdx = 0; 
                startRadarRotation(); 
                
                if(window.innerWidth > 768) filterETFs(""); 
            } catch(e) { 
                console.error("❌ Radar Error:", e); 
                elStatus.className = 'radar-status-dot offline'; 
                elVal.innerHTML = '<div style="font-size:10px; color:var(--danger); cursor:pointer; padding:5px;" onclick="fetchAndCalcTopDroppers()">⚠️ SIN CONEXIÓN - TOCAR</div>'; 
            } 
        }
        let currentRadarObj = null; let radarPressTimer = null; let radarLongPressTriggered = false; let radarTouchStartX = 0; let radarTouchStartY = 0; let isRadarSwipe = false;
        function quickInstallCurrentRadar() { 
            triggerHaptic(); 
            if(!currentRadarObj) return showToast("⚠️ Radar vacío"); 
            const list = (radarQueue.length > 0) ? radarQueue : topDroppers;
            const currentItem = list[dropperIdx];
            const isGolden = currentItem && (currentItem.zone === 'GOLD' || currentItem.isGolden);
            smartSelectETF(currentRadarObj.pair, currentRadarObj.price, isGolden); 
        }
        function startRadarRotation() { 
            if(radarIntervalId) clearTimeout(radarIntervalId);
            updateRadarUI();
            // El avance del radar lo maneja el masterClock cada 10s
        }
        
        function tickRadar() {
            const list = (radarQueue.length > 0) ? radarQueue : topDroppers;
            if(list.length === 0) return;
            dropperIdx = (dropperIdx + 1) % list.length;
            updateRadarUI();
        }
        
        function updateRadarUI() { 
            const list = (radarQueue.length > 0) ? radarQueue : topDroppers; 
            if(list.length === 0) return; 
            
            const elVal = document.getElementById('radarValue'); 
            const radarContainer = document.getElementById('radarTickerContainer'); 
            const item = list[dropperIdx]; 
            if(!item) return; 
            
            currentRadarObj = { 
                pair: item.currency_pair.replace('_USDT', ''), 
                price: parseFloat(item.last) 
            }; 
            
            // Aplicar animación según la zona
            radarContainer.classList.remove('gold-mode-active', 'flash-gold');
            if (item.zone === 'GOLD' || item.isGolden) { 
                radarContainer.classList.add('gold-mode-active'); 
                radarContainer.classList.add('flash-gold'); 
            } 
            
            // Fade out
            elVal.style.opacity = 0; 
            
            setTimeout(() => { 
                const pairName = item.currency_pair.replace('_USDT', ''); 
                const change = parseFloat(item.change_percentage).toFixed(2); 
                const price = parseFloat(item.last); 
                const displayPrice = price < 1 ? price.toFixed(4) : price.toFixed(2); 
                const volume = (parseFloat(item.quote_volume) / 1000000).toFixed(1); 
                
                // Determinar emoji y texto según la zona
                let zoneEmoji, zoneText, zoneClass;
                if (item.zone === 'GOLD' || item.isGolden) {
                    zoneEmoji = '🔥';
                    zoneText = 'OPORTUNIDAD';
                    zoneClass = 'gold';
                } else if (item.zone === 'HOT') {
                    zoneEmoji = '🟡';
                    zoneText = 'ZONA CALIENTE';
                    zoneClass = 'hot';
                } else {
                    zoneEmoji = '⚪';
                    zoneText = 'ZONA TEMPLADA';
                    zoneClass = 'warm';
                }
                
                const nameColor = getCoinColor(pairName); 
                
                
                let detailedInfo = '';
                if (item.isGolden && item.mainCoin) {
                    const direction = item.mainCoinChange > 0 ? '↑' : '↓';
                    detailedInfo = `<div style="font-size:13px; font-family:'JetBrains Mono', monospace; color:#FFD700; font-weight:700; margin-top:6px; display:flex; gap:12px; justify-content:center;">
                        <span>✨ ${item.mainCoin} ${direction}${Math.abs(item.mainCoinChange).toFixed(1)}%</span>
                        <span>Vol: $${volume}M</span>
                    </div>`;
                } else {
                    
                    detailedInfo = '';
                }
                
                elVal.innerHTML = `
                    <div style="display:flex; flex-direction:column; gap:6px; align-items:center; position:relative; z-index:1;">
                        <div class="radar-zone-badge ${zoneClass}" style="font-family:'JetBrains Mono', monospace; letter-spacing:1px;">
                            ${zoneEmoji} ${zoneText} • ${item.score}
                        </div>
                        <div id="radarCoinName" style="color:${nameColor}; font-size:28px; line-height:1.1; font-weight:800; cursor:pointer; text-decoration:underline dotted; text-underline-offset:6px; margin: 4px 0;" onclick="quickInstallCurrentRadar(); event.stopPropagation();">
                            ${pairName}
                        </div>
                        <div style="display:flex; gap:15px; font-size:15px; color:var(--text-secondary); align-items:center; font-family:'JetBrains Mono', monospace;">
                            <span style="color:var(--short); font-weight:900; font-size:18px;">${change}%</span>
                            <span style="font-weight:700; font-size:16px;">$${displayPrice}</span>
                        </div>
                        ${detailedInfo}
                    </div>
                `; 
                
                // Fade in
                elVal.style.opacity = 1;
                
                // ── SINCRONIZAR CHART CON RADAR ──
                // Cuando el radar muestra un nuevo ETF, ambos charts lo reflejan
                if (pairName && pairName !== chartSymbol) {
                    chartSymbol = pairName;
                    loadChart(pairName);
                }
            }, 200); 
        }
        function updateSlotStatus(symbol, currentPrice) { try { let needsDashRefresh = false; slots.forEach((s, idx) => { if(s.name === symbol) { if (s.buys.length === 0 && s.price > 0) { smartPriceAdjustment(s, idx, currentPrice); } if(s.buys.length > 0) { // Verificar alerta de objetivo (para cualquier nivel comprado)
                let avg = calculateAvgPriceForSlotData(s, idx); if(avg > 0) { if(currentPrice > avg) { const roiTarget = strategyParams.normal.roi; const target = avg * (1 + (roiTarget/100)); if(currentPrice >= target && !s.alerted) { triggerAlert(s.name); s.alerted = true; save(); } } else { s.alerted = false; } } if(s.buys.includes(0) && tradingMode === 'auto') { checkAndSendNextAutoLevel(s, idx, currentPrice); } } // Actualizar dashboard de este slot con precio en tiempo real
            updateDashboardStatsForSlot(idx, currentPrice); needsDashRefresh = true; } if(idx === activeIdx && s.name === symbol && s.price > 0) { updateLevelStatesRealTime(s, currentPrice); } }); } catch(e) { console.warn("Heatmap/Auto Error", e); } }
        function updateLevelStatesRealTime(slot, currentPrice) { 
            const limit = customMultipliers ? customMultipliers.length : 12; 
            let priceAtLevel = slot.price; 
            
            for (let i = 0; i < limit; i++) { 
                if (i > 0) { 
                    const step = getStepForLevel(slot.strat, i); 
                    priceAtLevel = priceAtLevel * (1 - (step / 100)); 
                } 
                
                const key = getOrderKey(activeIdx, i); 
                const cardEl = document.querySelector(`[data-level-index="${i}"]`); 
                if (!cardEl) continue; 
                
                // Si el precio actual llegó o pasó el nivel y no está en órdenes activas
                if (currentPrice <= priceAtLevel) {
                    // Marcar automáticamente como alcanzado si no tiene orden activa
                    if (!activeOrders[key]) {
                        // Solo para niveles 1-5, marcar automáticamente como comprado
                        if (i >= 0 && i <= 4) {
                            if (!slot.buys.includes(i)) {
                                slot.buys.push(i);
                                save();
                                showToast(`✅ N${i+1} Alcanzado: $${priceAtLevel.toFixed(6)}`, 2000, false, true);
                                
                                // Marcar visualmente como ejecutado
                                cardEl.classList.remove('is-sent', 'is-pending');
                                cardEl.classList.add('is-filled');
                                
                                let badge = cardEl.querySelector('.order-status-badge');
                                if (!badge) { 
                                    badge = document.createElement('div'); 
                                    badge.className = 'order-status-badge'; 
                                    cardEl.appendChild(badge); 
                                } 
                                badge.className = 'order-status-badge filled'; 
                                badge.textContent = 'ALCANZADO ✓';
                            }
                        } 
                        // Para niveles 6-12, solo marcar visualmente como "listo para comprar"
                        else {
                            cardEl.classList.remove('is-filled', 'is-pending');
                            cardEl.classList.add('is-sent');
                            
                            let badge = cardEl.querySelector('.order-status-badge');
                            if (!badge) { 
                                badge = document.createElement('div'); 
                                badge.className = 'order-status-badge'; 
                                cardEl.appendChild(badge); 
                            } 
                            badge.className = 'order-status-badge sent'; 
                            badge.textContent = 'DISPONIBLE';
                        }
                    } 
                    else if (activeOrders[key] && activeOrders[key].status === 'filled') { 
                        cardEl.classList.remove('is-sent', 'is-pending'); 
                        cardEl.classList.add('is-filled'); 
                        
                        let badge = cardEl.querySelector('.order-status-badge');
                        if (badge) {
                            badge.className = 'order-status-badge filled'; 
                            badge.textContent = 'EJECUTADA ✓';
                        }
                    } 
                    else if (activeOrders[key] && activeOrders[key].status === 'open') { 
                        cardEl.classList.remove('is-sent', 'is-filled'); 
                        cardEl.classList.add('is-pending'); 
                    } 
                }
                // Si el precio no ha llegado al nivel, limpiar estados
                else {
                    if (!activeOrders[key] && !slot.buys.includes(i)) {
                        cardEl.classList.remove('is-sent', 'is-pending', 'is-filled');
                        const badge = cardEl.querySelector('.order-status-badge');
                        if (badge) badge.remove();
                    }
                }
            } 
        }
        function calculateAvgPriceForSlot(s, slotIdx) {
            // slotIdx opcional — si no se pasa usa activeIdx (compatibilidad hacia atrás)
            const idx = (slotIdx !== undefined) ? slotIdx : activeIdx;
            if(!s.price) return 0; 
            let totalSpent = 0, totalQty = 0, lastPrice = s.price; 
            const limit = customMultipliers.length || 12; 
            const params = strategyParams.normal; 
            
            for(let i=0; i<limit; i++){ 
                let pLevel; 
                let mUSD; 
                
                if(i===0) {
                    pLevel = s.price;
                } else { 
                    const step = getStepForLevel('normal', i); 
                    pLevel = lastPrice*(1-(step/100)); 
                } 
                
                const m = customMultipliers[i]||1; 
                mUSD = m*params.capital; 
                
                const key = getOrderKey(idx, i); 
                if(activeOrders[key] && activeOrders[key].status === 'filled') { 
                    totalSpent += activeOrders[key].price * activeOrders[key].amount; 
                    totalQty += activeOrders[key].amount; 
                } else if(s.buys && s.buys.includes(i)) { 
                    totalSpent += mUSD; 
                    totalQty += mUSD/pLevel; 
                }
                // Compras múltiples (niveles 7-12)
                if (i >= 6 && i <= 11 && s.multipleBuys && s.multipleBuys[i]) {
                    for (let buy of s.multipleBuys[i]) {
                        totalSpent += buy.usd;
                        totalQty += buy.qty;
                    }
                }
                lastPrice = pLevel; 
            } 
            return totalQty > 0 ? totalSpent/totalQty : 0; 
        }
        function triggerAlert(coin) { const audio = document.getElementById('alertSound'); if(audio) audio.play().catch(e => console.log("Audio autoplay blocked by browser")); if(navigator.vibrate) navigator.vibrate([200, 100, 200]); showToast("🎯 OBJETIVO ALCANZADO: " + coin); }
        function toggleTheme() { isLight = !isLight; if(isLight) document.body.classList.add('light-mode'); else document.body.classList.remove('light-mode'); updateThemeIcon(); localStorage.setItem('theme', isLight ? 'light' : 'dark'); if(chartSymbol) loadChart(chartSymbol); }
        
        // Función para ir al Monitor ETF
        function goToETFMonitor() {
            triggerHaptic();
            switchView('etf');
        }
        
        // Función para mostrar/ocultar el botón flotante ETF según la sección activa
        function updateETFFloatButtonVisibility() {
            const etfFloatBtn = document.getElementById('etfFloatBtn');
            if (!etfFloatBtn) return;
            
            // Solo mostrar en la sección OPERAR
            if (currentSection === 'operate') {
                etfFloatBtn.classList.remove('hidden');
            } else {
                etfFloatBtn.classList.add('hidden');
            }
        }
        
        // ================================================================================
        // FUNCIONES DEL BOT (IMPLEMENTADAS)
        // ================================================================================
        
        function toggleBot() {
            const checkbox = document.getElementById('botEnabled');
            botConfig.enabled = checkbox.checked;
            localStorage.setItem('c5x_bot_config', JSON.stringify(botConfig));
            
            const statusEl = document.getElementById('botStatus');
            const statusText = document.getElementById('botStatusText');
            
            if (botConfig.enabled) {
                statusEl.classList.remove('inactive');
                statusEl.classList.add('active');
                statusText.textContent = 'Bot activado';
                showToast('🤖 Bot activado', 2000);
            } else {
                statusEl.classList.remove('active');
                statusEl.classList.add('inactive');
                statusText.textContent = 'Bot desactivado';
                showToast('🤖 Bot desactivado', 2000);
            }
        }
        
        function saveBotConfig() {
            botConfig.normalProfit = parseFloat(document.getElementById('botNormalProfit').value) || 100;
            botConfig.trailingStop = parseFloat(document.getElementById('botTrailingStop').value) || 10;
            botConfig.checkInterval = parseInt(document.getElementById('botCheckInterval').value) || 30;
            
            localStorage.setItem('c5x_bot_config', JSON.stringify(botConfig));
            showToast('✅ Configuración del bot guardada', 2000);
        }
        
        // ================================================================================
        // FUNCIONES DE PANELES LATERALES
        // ================================================================================
        
        
        // SISTEMA DE 3 PANELES DESLIZABLES
        let currentPanel = 0;
        let panelTouchStartX = 0;
        let panelTouchStartY = 0;
        
        function switchPanel(panelIndex) {
            if (panelIndex < 0 || panelIndex > 2) return;
            currentPanel = panelIndex;
            const container = document.getElementById('panelsContainer');
            const indicators = document.querySelectorAll('.panel-dot');
            if (container) container.setAttribute('data-active', panelIndex);
            indicators.forEach((dot, idx) => dot.classList.toggle('active', idx === panelIndex));
            updateHeaderForPanel(panelIndex);
            // Panel 0: Chart + Radar + Gate.io (inicio/default)
            if (panelIndex === 0) {
                setTimeout(() => loadChart(chartSymbol), 100);
                initGateDashboard();
            }
            // Panel 1: 5 Dashboards — nada extra
            // Panel 2: Chart2 + 12 Niveles
            if (panelIndex === 2) {
                forceRenderLevels(activeIdx);
            }
            triggerHaptic();
        }
        
        // Actualizar header (ticker vs USDT display)
        function updateHeaderForPanel(panelIndex) {
            const tickerContainer = document.getElementById('tickerContainer');
            const usdtContainer = document.getElementById('usdtContainer');
            if (panelIndex === 1) {
                // Panel 1 (Dashboards): mostrar USDT
                if (tickerContainer) tickerContainer.style.display = 'none';
                if (usdtContainer) usdtContainer.style.display = '';
                updateUSDTDisplay();
            } else {
                // Panel 0 (Chart+Radar) y Panel 2 (Chart2+Niveles): ticker
                if (tickerContainer) tickerContainer.style.display = '';
                if (usdtContainer) usdtContainer.style.display = 'none';
            }
        }
        
        // Actualizar el valor de USDT disponible
        function updateUSDTDisplay() {
            const usdtElement = document.getElementById('usdtAvailable');
            if (usdtElement) {
                usdtElement.textContent = availableUSDT.toLocaleString('en-US', { 
                    minimumFractionDigits: 0, 
                    maximumFractionDigits: 0 
                });
            }
        }
        
        // Cancela TODOS los timers de pulsación larga activos (evita activación accidental al deslizar)
        function cancelAllLongPresses() {
            if (typeof coinPressTimer !== 'undefined' && coinPressTimer) { clearTimeout(coinPressTimer); coinPressTimer = null; }
            if (typeof basePricePressTimer !== 'undefined' && basePricePressTimer) { clearTimeout(basePricePressTimer); basePricePressTimer = null; }
            if (typeof clearSlotPressTimer !== 'undefined' && clearSlotPressTimer) { clearTimeout(clearSlotPressTimer); clearSlotPressTimer = null; }
            if (typeof sellPressTimer !== 'undefined' && sellPressTimer) { clearTimeout(sellPressTimer); sellPressTimer = null; }
            if (typeof tradingPressTimer !== 'undefined' && tradingPressTimer) { clearTimeout(tradingPressTimer); tradingPressTimer = null; }
            if (typeof strategyPressTimer !== 'undefined' && strategyPressTimer) { clearTimeout(strategyPressTimer); strategyPressTimer = null; }
            if (typeof levelPressTimer !== 'undefined' && levelPressTimer) { clearTimeout(levelPressTimer); levelPressTimer = null; }
            if (typeof tickerPressTimer !== 'undefined' && tickerPressTimer) { clearTimeout(tickerPressTimer); tickerPressTimer = null; }
            // Limpiar estados visuales de presión
            document.querySelectorAll('.pressing').forEach(el => el.classList.remove('pressing'));
            if (typeof longPressTriggered !== 'undefined') longPressTriggered = false;
            if (typeof levelLongPressTriggered !== 'undefined') levelLongPressTriggered = false;
            if (typeof clearSlotLongPressTriggered !== 'undefined') clearSlotLongPressTriggered = false;
            if (typeof isSellScrolling !== 'undefined') isSellScrolling = true;
            if (typeof isScrolling !== 'undefined') isScrolling = true;
        }
        
        function setupPanelSwipe() {
            const panelsWrapper = document.querySelector('.panels-wrapper');
            if (!panelsWrapper) return;
            
            panelsWrapper.addEventListener('touchstart', (e) => {
                panelTouchStartX = e.touches[0].clientX;
                panelTouchStartY = e.touches[0].clientY;
            }, { passive: true });
            
            // Cancelar pulsaciones largas cuando el gesto es horizontal (deslizamiento de panel)
            panelsWrapper.addEventListener('touchmove', (e) => {
                const moveX = Math.abs(e.touches[0].clientX - panelTouchStartX);
                const moveY = Math.abs(e.touches[0].clientY - panelTouchStartY);
                if (moveX > 12 && moveX > moveY) {
                    cancelAllLongPresses();
                    closeUserMenu(); // Cerrar menú al detectar deslizamiento horizontal
                }
            }, { passive: true });
            
            panelsWrapper.addEventListener('touchend', (e) => {
                const touchEndX = e.changedTouches[0].clientX;
                const touchEndY = e.changedTouches[0].clientY;
                const diffX = touchEndX - panelTouchStartX;
                const diffY = touchEndY - panelTouchStartY;
                
                // Solo actuar si es más horizontal que vertical
                if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                    closeUserMenu(); // Cerrar menú al cambiar panel
                    if (diffX > 0) {
                        // Swipe derecha: panel anterior
                        if (currentPanel > 0) {
                            switchPanel(currentPanel - 1);
                        }
                    } else {
                        // Swipe izquierda: siguiente panel
                        if (currentPanel < 2) {
                            switchPanel(currentPanel + 1);
                        }
                    }
                }
            }, { passive: true });
        }
        
        // ════════════════════════════════════════════════════════════════
        //  CHAT DE SOPORTE — Firebase Firestore Realtime
        //  Ruta: /consultas_privadas/{uid}/mensajes/{id}
        //  Solo visible para el usuario propietario + Super Admin
        // ════════════════════════════════════════════════════════════════

        // ════════════════════════════════════════════════════════════════
        //  FIREBASE — Configuración dinámica (el usuario la ingresa en Ajustes)
        //  Estructura Firestore:
        //    users/{uid}/data     → slots, history, activeOrders, settings
        //    users/{uid}/profile  → displayName, email, lastSync, device
        //    consultas_privadas/{uid}/mensajes/{id}  → chat soporte
        // ════════════════════════════════════════════════════════════════

        // ── Config hardcodeada (segura — es pública por diseño de Google) ──
        const FB_CONFIG_HARDCODED = {
            apiKey:            "AIzaSyB8pMOUdWfAqUJCAx7_fS3rIJmJhfGg2Ow",
            authDomain:        "c-76968184-d7bf0.firebaseapp.com",
            projectId:         "c-76968184-d7bf0",
            storageBucket:     "c-76968184-d7bf0.firebasestorage.app",
            messagingSenderId: "981453171468",
            appId:             "1:981453171468:web:4cc36e5cc8ac70a8cef729"
        };

        // Siempre devuelve la config hardcodeada — usuarios no ven formulario
        function getFirebaseConfig() {
            return FB_CONFIG_HARDCODED;
        }

        // ── Guardar config ingresada en el formulario de Ajustes ─────
        function saveFirebaseConfig() {
            const get = id => (document.getElementById(id)?.value || '').trim();
            const apiKey     = get('fbCfgApiKey');
            const authDomain = get('fbCfgAuthDomain');
            const projectId  = get('fbCfgProjectId');
            const appId      = get('fbCfgAppId');
            const senderId   = get('fbCfgSenderId');
            if (!apiKey || !authDomain || !projectId || !appId) {
                return showToast('⚠️ Completa todos los campos obligatorios');
            }
            const cfg = { apiKey, authDomain, projectId, appId,
                storageBucket: projectId + '.appspot.com',
                messagingSenderId: senderId };
            localStorage.setItem('c5x_fb_config', JSON.stringify(cfg));
            showToast('✅ Firebase configurado — reiniciando...', 2500);
            setTimeout(() => location.reload(), 2500);
        }

        // ── Borrar config Firebase ────────────────────────────────────
        function clearFirebaseConfig() {
            if (!confirm('¿Borrar la configuración de Firebase?\nSe cerrará sesión.')) return;
            localStorage.removeItem('c5x_fb_config');
            localStorage.removeItem('c5x_super_admin_uid');
            showToast('🗑️ Configuración borrada — reiniciando...', 2000);
            setTimeout(() => location.reload(), 2000);
        }

        // ── SUPER ADMIN UID (se guarda la primera vez que el admin entra) ──
        // Para ser admin: inicia sesión → ve a Ajustes → se muestra tu UID
        // UID del admin — primero local (admin device), luego caché de Firestore
        function getSuperAdminUID() {
            return localStorage.getItem('c5x_super_admin_uid') ||
                   localStorage.getItem('c5x_super_admin_uid_cache') || '';
        }

        // ── CONTROL DEL MURO DE AUTENTICACIÓN ────────────────────────
        function lockApp(reason) {
            const wall = document.getElementById('authWall');
            const desc = document.getElementById('authWallDesc');
            const status = document.getElementById('authWallStatus');
            const btn = document.getElementById('authWallBtn');
            if (!wall) return;
            if (reason === 'checking') {
                if (desc) desc.innerHTML = 'Verificando tu sesión...';
                if (status) { status.textContent = '⏳ CONECTANDO...'; status.style.display = ''; }
                if (btn) btn.style.display = 'none';
                // Si Firebase tarda más de 4s, mostrar botón de login
                setTimeout(() => {
                    const w = document.getElementById('authWall');
                    if (w && !w.classList.contains('hidden') && !w.classList.contains('hiding')) {
                        lockApp('login');
                    }
                }, 4000);
            } else if (reason === 'denied') {
                if (status) status.style.display = 'none';
                if (btn) { btn.textContent = 'INTENTAR CON OTRA CUENTA'; btn.style.display = ''; btn.onclick = () => { loginWithGoogle(); }; }
            } else {
                // login screen
                if (desc) desc.innerHTML = 'Esta aplicación es de uso privado.<br>Inicia sesión con tu cuenta Google autorizada.';
                if (status) status.style.display = 'none';
                if (btn) { btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg> CONTINUAR CON GOOGLE'; btn.style.display = ''; btn.onclick = loginWithGoogle; }
            }
            wall.classList.remove('hidden', 'hiding');
        }

        function unlockApp() {
            const wall = document.getElementById('authWall');
            if (!wall) return;
            wall.classList.add('hiding');
            setTimeout(() => wall.classList.add('hidden'), 420);
        }

        // ── ESTADO GLOBAL FIREBASE ────────────────────────────────────
        let fbApp            = null;
        let fbDb             = null;
        let fbAuth           = null;
        let fbUser           = null;
        let chatUnsubscribe  = null;
        let chatInitialized  = false;
        let lastChatDate     = '';
        let isSuperAdmin     = false;
        let cloudAutoSyncTimer = null;
        let cloudLastSave    = 0;

        // ── INICIALIZAR FIREBASE ──────────────────────────────────────
        function initFirebase() {
            if (fbApp) return true;
            try {
                if (typeof firebase === 'undefined') return false;
                const cfg = getFirebaseConfig();
                if (!cfg || !cfg.apiKey) {
                    console.log('C5X: Firebase no configurado (sin config)');
                    return false;
                }
                fbApp  = firebase.apps.length ? firebase.apps[0] : firebase.initializeApp(cfg);
                fbDb   = firebase.firestore();
                fbAuth = firebase.auth();

                // Persistencia offline (funciona aunque se refresque)
                fbDb.enablePersistence({ synchronizeTabs: true }).catch(e => {
                    if (e.code === 'failed-precondition') {
                        console.log('C5X: Persistencia: múltiples pestañas abiertas');
                    }
                });

                // Auth listener → corazón del sistema
                fbAuth.onAuthStateChanged(async user => {
                    if (user) {
                        // Mostrar "verificando" mientras chequeamos
                        lockApp('checking');
                        const allowed = await checkWhitelist(user);
                        if (!allowed) {
                            await fbAuth.signOut();
                            fbUser = null;
                            isSuperAdmin = false;
                            actualizarUIConexion(false);
                            updateGoogleUI();
                            updateCloudUI();
                            // Mostrar acceso denegado en el muro
                            const desc = document.getElementById('authWallDesc');
                            if (desc) desc.innerHTML = `<strong style="color:var(--short)">${user.email}</strong><br>no tiene acceso a C5X.<br><br>Contacta al administrador.`;
                            lockApp('denied');
                            return;
                        }
                        // Acceso permitido → desbloquear app
                        unlockApp();
                    } else {
                        // Sin sesión → mostrar muro de login
                        lockApp('login');
                    }

                    fbUser = user;
                    // adminUID ya está en caché local (lo puso checkWhitelist)
                    const adminUID = localStorage.getItem('c5x_super_admin_uid') ||
                                     localStorage.getItem('c5x_super_admin_uid_cache') || '';
                    isSuperAdmin = !!(user && adminUID && user.uid === adminUID);

                    actualizarUIConexion(!!user);
                    updateGoogleUI();
                    updateCloudUI();
                    applyRoleVisibility();

                    if (user) {
                        console.log('✅ C5X Cloud: sesión activa —', user.email);
                        await loadFromCloud(false);
                        escucharBadgeChat();
                        if (cloudAutoSyncTimer) clearInterval(cloudAutoSyncTimer);
                        cloudAutoSyncTimer = setInterval(() => saveToCloud(false), 90000);
                    } else {
                        if (cloudAutoSyncTimer) { clearInterval(cloudAutoSyncTimer); cloudAutoSyncTimer = null; }
                    }

                    if (currentSection === 'chat') escucharMensajes();
                });

                return true;
            } catch (e) {
                console.warn('C5X Firebase init error:', e.message);
                return false;
            }
        }

        // ════════════════════════════════════════════════════════════════
        //  🔒  LISTA BLANCA — Control de acceso por usuario
        // ════════════════════════════════════════════════════════════════

        async function checkWhitelist(user) {
            if (!user) return false;

            // ─ Caché offline: si ya fue aprobado en este dispositivo ─────────
            const cacheKey = 'c5x_ok_' + user.uid;
            if (localStorage.getItem(cacheKey) === '1') return true;

            if (!fbDb) return false;

            try {
                // ─ 1. Obtener UID del admin ──────────────────────────────────
                let adminUID = localStorage.getItem('c5x_super_admin_uid') ||
                               localStorage.getItem('c5x_super_admin_uid_cache');
                if (!adminUID) {
                    const cfg = await fbDb.collection('config').doc('admin').get();
                    if (cfg.exists) {
                        adminUID = cfg.data().uid || '';
                        if (adminUID) localStorage.setItem('c5x_super_admin_uid_cache', adminUID);
                    }
                }

                // ─ 2. Sin admin configurado → modo setup ─────────────────────
                if (!adminUID) return true;

                // ─ 3. El admin siempre entra ──────────────────────────────────
                if (user.uid === adminUID) {
                    localStorage.setItem(cacheKey, '1');
                    return true;
                }

                // ─ 4. Leer whitelist del mismo /config/admin ─────────────────
                const cfgDoc2 = await fbDb.collection('config').doc('admin').get();
                if (!cfgDoc2.exists) return false;

                const list = cfgDoc2.data().whitelist || [];
                if (list.length === 0) return false;

                const email = user.email.trim().toLowerCase();
                const ok = list.some(u =>
                    (u.email || '').trim().toLowerCase() === email ||
                    u.uid === user.uid
                );
                if (ok) localStorage.setItem(cacheKey, '1');
                return ok;

            } catch(e) {
                console.warn('checkWhitelist error:', e.message);
                // Sin red: respetar caché si existe
                return localStorage.getItem(cacheKey) === '1';
            }
        }

        // Mostrar pantalla de acceso denegado
        function showAccessDenied(email) {
            // Mostrar modal de acceso denegado
            const existing = document.getElementById('accessDeniedModal');
            if (existing) existing.remove();

            const modal = document.createElement('div');
            modal.id = 'accessDeniedModal';
            modal.style.cssText = `
                position:fixed; inset:0; z-index:9999;
                background:rgba(0,0,0,0.85); backdrop-filter:blur(8px);
                display:flex; align-items:center; justify-content:center; padding:20px;
            `;
            modal.innerHTML = `
                <div style="
                    background:var(--surface); border:1px solid rgba(239,68,68,0.4);
                    border-radius:20px; padding:28px 20px; max-width:320px; width:100%;
                    text-align:center;
                ">
                    <div style="font-size:48px; margin-bottom:12px;">🔒</div>
                    <div style="font-family:var(--font-head); font-size:16px; font-weight:900;
                        color:var(--short); letter-spacing:1px; margin-bottom:8px;">
                        ACCESO RESTRINGIDO
                    </div>
                    <div style="font-family:var(--font-head); font-size:11px;
                        color:var(--text-secondary); line-height:1.7; margin-bottom:16px;">
                        La cuenta <strong style="color:var(--text-primary)">${email}</strong>
                        no tiene acceso a C5X.<br><br>
                        Contacta al administrador para solicitar acceso.
                    </div>
                    <button onclick="document.getElementById('accessDeniedModal').remove()"
                        style="width:100%; padding:12px; border-radius:12px;
                        background:var(--brand); color:#fff; border:none;
                        font-family:var(--font-head); font-size:12px; font-weight:700;
                        cursor:pointer; letter-spacing:0.5px;">
                        ENTENDIDO
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // ── GESTIÓN DE LISTA BLANCA (solo Super Admin) ───────────────

        // ── Lista blanca guardada en subcol privada del admin ──────────
        // Ruta: users/{adminUID}/admin/whitelist  (solo el admin puede leer/escribir)
        // Whitelist en /config/admin — mismo doc que tiene lectura pública garantizada
        function getWLRef() {
            return fbDb.collection('config').doc('admin');
        }
        async function getWLData() {
            const doc = await getWLRef().get();
            return doc.exists ? (doc.data().whitelist || []) : [];
        }

        // Helper para limpiar inputs después de agregar
        function wlAddAndClear() {
            const emailEl = document.getElementById('wlInputEmail');
            const nameEl  = document.getElementById('wlInputName');
            const email   = (emailEl ? emailEl.value : '').trim().toLowerCase();
            const name    = nameEl ? nameEl.value.trim() : '';
            addToWhitelist(email, name).then(() => {
                if (emailEl) emailEl.value = '';
                if (nameEl)  nameEl.value  = '';
            });
        }

        // Agregar usuario a la lista blanca
        async function addToWhitelist(email, name = '') {
            if (!fbDb || !isSuperAdmin || !fbUser) return showToast('⚠️ Solo el Admin puede hacer esto');
            if (!email || !email.includes('@')) return showToast('⚠️ Email inválido');
            const clean = email.trim().toLowerCase();
            try {
                const list = await getWLData();
                if (list.find(u => (u.email||'').trim().toLowerCase() === clean)) {
                    return showToast('ℹ️ ' + clean + ' ya tiene acceso');
                }
                list.push({ email: clean, name: name || '', addedAt: Date.now() });
                // merge:true para no borrar uid/email del admin del mismo doc
                await getWLRef().set({ whitelist: list }, { merge: true });
                showToast('✅ Acceso dado a: ' + clean, 3000, false, true);
                renderWhitelist();
            } catch(e) {
                showToast('❌ Error: ' + e.message);
                console.error('addToWhitelist error:', e);
            }
        }

        // Quitar usuario por índice
        async function removeFromWhitelistByIndex(idx) {
            if (!fbDb || !isSuperAdmin || !fbUser) return showToast('⚠️ Sin permisos');
            try {
                const users = await getWLData();
                const u = users[idx];
                if (!u) return;
                if (!confirm('¿Quitar acceso a ' + u.email + '?')) return;
                users.splice(idx, 1);
                await getWLRef().set({ whitelist: users }, { merge: true });
                // Limpiar caché aprobación del dispositivo (best effort)
                Object.keys(localStorage).forEach(k => {
                    if (k.startsWith('c5x_ok_')) localStorage.removeItem(k);
                });
                showToast('🗑️ ' + u.email + ' eliminado');
                renderWhitelist();
            } catch(e) {
                showToast('❌ Error: ' + e.message);
                console.error('removeFromWhitelist:', e);
            }
        }

        // Cargar y mostrar la lista blanca — usa /whitelist/approved
        async function renderWhitelist() {
            const container = document.getElementById('whitelistContainer');
            if (!container || !fbDb || !isSuperAdmin || !fbUser) return;
            container.innerHTML = '<div style="font-family:var(--font-head);font-size:10px;color:var(--text-tertiary);text-align:center;padding:8px;">Cargando...</div>';
            try {
                const data = await getWLData(); // usa getWLRef() → /whitelist/approved
                if (data.length === 0) {
                    container.innerHTML = '<div style="font-family:var(--font-head);font-size:10px;color:var(--text-tertiary);text-align:center;padding:10px;">Sin usuarios con acceso</div>';
                    return;
                }
                let html = '';
                data.forEach((u, idx) => {
                    html += `<div style="display:flex;align-items:center;justify-content:space-between;padding:8px;background:rgba(0,0,0,0.1);border-radius:8px;margin-bottom:5px;">
                        <div>
                            <div style="font-family:var(--font-head);font-size:10px;font-weight:700;color:var(--text-primary);">${u.name || 'Usuario'}</div>
                            <div style="font-family:var(--font-num);font-size:9px;color:var(--text-tertiary);">${u.email}</div>
                        </div>
                        <button onclick="removeFromWhitelistByIndex(${idx})"
                            style="background:rgba(239,68,68,0.12);border:1px solid rgba(239,68,68,0.3);color:var(--short);border-radius:8px;padding:4px 8px;font-family:var(--font-head);font-size:9px;cursor:pointer;">
                            🗑️
                        </button>
                    </div>`;
                });
                container.innerHTML = html;
            } catch(e) {
                container.innerHTML = '<div style="font-size:10px;color:var(--short);padding:8px;">Error: ' + e.message + '</div>';
            }
        }

        // ════════════════════════════════════════════════════════════════
        //  ☁️  CLOUD SYNC — Guardar y restaurar datos en Firestore
        // ════════════════════════════════════════════════════════════════

        // Construir el objeto completo de datos del usuario
        function buildCloudPayload() {
            // Sanar slots antes de subir: si hay buys pero price=0, intentar recuperar de localStorage
            const safeSlots = slots.map((s, idx) => {
                if (!s) return s;
                const hasBuys = (s.buys && s.buys.length > 0) ||
                    Object.keys(activeOrders).some(k => k.startsWith('s' + idx + '_'));
                if (hasBuys && (!s.price || s.price === 0)) {
                    // Intentar recuperar de initialPrice
                    if (s.initialPrice && s.initialPrice > 0) {
                        return { ...s, price: s.initialPrice };
                    }
                }
                return s;
            });
            return {
                slots:         safeSlots,
                history:       history || [],
                activeOrders:  activeOrders || {},
                activeIdx:     activeIdx,
                strategyParams: strategyParams,
                globalCapital: globalCapital,
                exchangeFee:   exchangeFee,
                customMultipliers: customMultipliers || [],
                tickerAssets:  tickerAssets || [],
                tradingMode:   tradingMode,
                radarLimit:    radarLimit,
                radarSpeed:    radarSpeed,
                tickerSpeed:   tickerSpeed,
                autoAdjustThreshold: autoAdjustThreshold,
                savedAt:       Date.now(),
                device:        /Mobile|Android|iPhone/i.test(navigator.userAgent) ? 'mobile' : 'desktop',
                version:       'V25.31'
            };
        }

        // ── GUARDAR EN FIRESTORE ──────────────────────────────────────
        async function saveToCloud(manual = false) {
            if (!fbUser || !fbDb) {
                if (manual) showToast('⚠️ Inicia sesión primero para sincronizar');
                return;
            }
            // Debounce: no guardar más de 1 vez cada 4 segundos (salvo manual)
            const now = Date.now();
            if (!manual && (now - cloudLastSave) < 4000) return;
            cloudLastSave = now;

            try {
                if (manual) setCloudSyncPill('syncing', 'SUBIENDO...');
                const payload = buildCloudPayload();
                await fbDb.collection('users').doc(fbUser.uid).set({
                    data: payload,
                    profile: {
                        displayName: fbUser.displayName || '',
                        email:       fbUser.email || '',
                        photoURL:    fbUser.photoURL || '',
                        lastSync:    firebase.firestore.FieldValue.serverTimestamp(),
                        device:      payload.device
                    }
                }, { merge: true });

                // Actualizar localStorage con timestamp del sync
                localStorage.setItem('c5x_last_cloud_save', String(now));
                updateCloudStats();
                setCloudSyncPill('synced', 'SINCRONIZADO');
                const t = new Date(now);
                const timeStr = t.toLocaleTimeString('es', { hour: '2-digit', minute: '2-digit' });
                const el = document.getElementById('cloudLastSyncText');
                if (el) el.textContent = 'Última sincronización: ' + t.toLocaleString('es');
                if (manual) showToast('✅ Datos subidos a la nube — ' + timeStr, 2500, false, true);
                console.log('☁️ Cloud save OK:', timeStr);
            } catch (e) {
                setCloudSyncPill('error', 'ERROR');
                if (manual) showToast('❌ Error al sincronizar: ' + e.message);
                console.error('Cloud save error:', e);
            }
        }

        // ── CARGAR DESDE FIRESTORE ────────────────────────────────────
        async function loadFromCloud(manual = false) {
            if (!fbUser || !fbDb) {
                if (manual) showToast('⚠️ Inicia sesión primero');
                return;
            }
            try {
                if (manual) setCloudSyncPill('syncing', 'CARGANDO...');
                const doc = await fbDb.collection('users').doc(fbUser.uid).get();
                if (!doc.exists || !doc.data()?.data) {
                    if (manual) {
                        // No hay datos en nube → subir los locales
                        showToast('☁️ Sin datos en la nube — subiendo datos locales...', 3000);
                        await saveToCloud(true);
                    }
                    setCloudSyncPill('synced', 'LISTO');
                    return;
                }
                const cloud = doc.data().data;
                const cloudTs = cloud.savedAt || 0;
                const localTs = parseInt(localStorage.getItem('c5x_last_cloud_save') || '0');

                if (manual) {
                    // Forzado por el usuario: siempre restaurar
                    applyCloudData(cloud);
                    showToast('✅ Datos restaurados desde la nube', 2500, false, true);
                } else {
                    // Automático: solo restaurar si la nube es MÁS RECIENTE que local
                    if (cloudTs > localTs) {
                        applyCloudData(cloud);
                        console.log('☁️ Datos más recientes en la nube — restaurados');
                    } else {
                        // Local es más nuevo → subir a la nube
                        await saveToCloud(false);
                    }
                }
                setCloudSyncPill('synced', 'SINCRONIZADO');
                updateCloudStats();
            } catch (e) {
                setCloudSyncPill('error', 'ERROR');
                if (manual) showToast('❌ Error al cargar: ' + e.message);
                console.error('Cloud load error:', e);
            }
        }

        // ── APLICAR DATOS DE LA NUBE AL ESTADO LOCAL ─────────────────
        function applyCloudData(cloud) {
            try {
                if (cloud.slots && Array.isArray(cloud.slots)) {
                    slots = cloud.slots;
                    localStorage.setItem('c5x_slots', JSON.stringify(slots));
                    localStorage.setItem('c5x_slots_real', JSON.stringify(slots));
                }
                if (cloud.history && Array.isArray(cloud.history)) {
                    history = cloud.history;
                    localStorage.setItem('c5x_history', JSON.stringify(history));
                }
                if (cloud.activeOrders) {
                    activeOrders = cloud.activeOrders;
                    localStorage.setItem('c5x_active_orders', JSON.stringify(activeOrders));
                }
                if (typeof cloud.activeIdx === 'number') {
                    activeIdx = cloud.activeIdx;
                    localStorage.setItem('c5x_last_slot', activeIdx);
                }
                if (cloud.strategyParams) {
                    strategyParams = cloud.strategyParams;
                    localStorage.setItem('c5x_strategy_params', JSON.stringify(strategyParams));
                }
                if (cloud.globalCapital) {
                    globalCapital = cloud.globalCapital;
                    localStorage.setItem('c5x_global_capital', globalCapital);
                }
                if (cloud.customMultipliers && cloud.customMultipliers.length) {
                    customMultipliers = cloud.customMultipliers;
                    localStorage.setItem('c5x_multipliers', JSON.stringify(customMultipliers));
                }
                if (cloud.tickerAssets && cloud.tickerAssets.length) {
                    tickerAssets = cloud.tickerAssets.filter(t => !t.match(/[35][LS]/));
                    localStorage.setItem('c5x_ticker_assets', JSON.stringify(tickerAssets));
                }
                if (cloud.tradingMode) {
                    tradingMode = cloud.tradingMode;
                    localStorage.setItem('c5x_trading_mode', tradingMode);
                }
                // Guardar timestamp del último sync aplicado
                localStorage.setItem('c5x_last_cloud_save', String(cloud.savedAt || Date.now()));
                // Refrescar UI — NO llamar calculate() para no sobreescribir precios
                updateDashUI();
                // Actualizar inputs del slot activo manualmente SIN pasar por calculate()
                const s = slots[activeIdx];
                const cIn = document.getElementById('coinInput');
                if (cIn && s) { cIn.value = s.name || ''; }
                const bIn = document.getElementById('baseInput');
                if (bIn && s && s.price > 0) { bIn.value = s.price; }
                renderAllDashboards();
                renderLevels();
                renderHistory();
                updateDashboardStats();
            } catch(e) {
                console.error('applyCloudData error:', e);
            }
        }

        // ── SINCRONIZAR API KEYS DE GATE.IO A LA NUBE (cifradas) ─────
        async function syncApiKeysSecureToCloud() {
            if (!fbUser || !fbDb) return showToast('⚠️ Inicia sesión primero');
            if (!apiConfig.key || !apiConfig.secret) return showToast('⚠️ No hay API Keys guardadas localmente');
            if (!confirm('¿Sincronizar las API Keys de Gate.io a la nube?\nEstarán cifradas y solo accesibles con tu cuenta.')) return;
            try {
                // Cifrar con la uid del usuario como salt
                const salt   = fbUser.uid.substring(0, 16);
                const encKey = CryptoJS.AES.encrypt(apiConfig.key,    salt).toString();
                const encSec = CryptoJS.AES.encrypt(apiConfig.secret, salt).toString();
                await fbDb.collection('users').doc(fbUser.uid).set({
                    api_encrypted: { k: encKey, s: encSec, ts: Date.now() }
                }, { merge: true });
                showToast('🔐 API Keys sincronizadas y cifradas en la nube', 3000, false, true);
            } catch(e) {
                showToast('❌ Error: ' + e.message);
            }
        }

        // ── CARGAR API KEYS CIFRADAS DE LA NUBE ──────────────────────
        async function loadApiKeysFromCloud() {
            if (!fbUser || !fbDb) return;
            try {
                const doc = await fbDb.collection('users').doc(fbUser.uid).get();
                const enc = doc.data()?.api_encrypted;
                if (!enc) return;
                const salt   = fbUser.uid.substring(0, 16);
                const decKey = CryptoJS.AES.decrypt(enc.k, salt).toString(CryptoJS.enc.Utf8);
                const decSec = CryptoJS.AES.decrypt(enc.s, salt).toString(CryptoJS.enc.Utf8);
                if (decKey && decSec && (!apiConfig.key || !apiConfig.secret)) {
                    apiConfig = { key: decKey, secret: decSec };
                    localStorage.setItem('c5x_api_keys', JSON.stringify(apiConfig));
                    fetchWalletBalance();
                    console.log('🔐 API Keys restauradas desde la nube');
                }
            } catch(e) {
                console.warn('loadApiKeysFromCloud error:', e);
            }
        }

        // ── INICIALIZAR SECCIÓN CHAT ──────────────────────────────────
        function initChatSection() {
            const ok = initFirebase();
            if (!ok) {
                // Mostrar aviso de configuración pendiente
                mostrarAvisoFirebase();
                return;
            }
            if (!fbUser) {
                // No hay sesión → login con Google
                loginGoogleChat();
                return;
            }
            escucharMensajes();
        }

        // ── LOGIN CON GOOGLE ──────────────────────────────────────────
        function loginGoogleChat() {
            if (!fbAuth) return;
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.setCustomParameters({ prompt: 'select_account' });
            fbAuth.signInWithPopup(provider).catch(err => {
                if (err.code !== 'auth/popup-closed-by-user') {
                    showToast('⚠️ Error conectando Google: ' + err.message);
                }
            });
        }

        // ── ESCUCHAR MENSAJES EN TIEMPO REAL ─────────────────────────
        function escucharMensajes(uidTarget) {
            if (chatUnsubscribe) { chatUnsubscribe(); chatUnsubscribe = null; }
            if (!fbUser || !fbDb) return;

            // SuperAdmin puede ver chat de cualquier usuario (se pasa uidTarget)
            const uid = isSuperAdmin && uidTarget ? uidTarget : fbUser.uid;

            actualizarUIConexion(true, true);
            lastChatDate = '';

            const ref = fbDb
                .collection('consultas_privadas')
                .doc(uid)
                .collection('mensajes')
                .orderBy('created_at', 'asc')
                .limitToLast(200);

            chatUnsubscribe = ref.onSnapshot(snap => {
                const container = document.getElementById('chatMessages');
                const empty     = document.getElementById('chatEmptyState');
                if (!container) return;

                if (snap.empty) {
                    if (empty) empty.style.display = 'flex';
                    return;
                }
                if (empty) empty.style.display = 'none';

                // Re-renderizar solo mensajes nuevos (append)
                const existingIds = new Set(
                    [...container.querySelectorAll('[data-msg-id]')].map(el => el.dataset.msgId)
                );

                snap.docChanges().forEach(change => {
                    if (change.type === 'added' && !existingIds.has(change.doc.id)) {
                        const msg  = change.doc.data();
                        const html = buildBubble(change.doc.id, msg, uid);
                        container.insertAdjacentHTML('beforeend', html);
                        existingIds.add(change.doc.id);
                    }
                });

                // Scroll al fondo
                container.scrollTop = container.scrollHeight;

                // Marcar no leídos como leídos
                marcarLeidos(uid);

            }, err => {
                console.error('C5X Chat error:', err.code);
                if (err.code === 'permission-denied') {
                    actualizarUIConexion(false);
                }
            });
        }

        // ── CONSTRUIR BURBUJA ─────────────────────────────────────────
        function buildBubble(id, msg, uid) {
            const esMio    = msg.autor_uid === fbUser.uid;
            const esAdmin  = msg.es_soporte === true;
            const side     = esMio ? 'mine' : 'theirs';
            const adminCls = (!esMio && esAdmin) ? ' superadmin' : '';
            let html       = '';

            // Separador de fecha
            const ts    = msg.created_at ? msg.created_at.toDate() : new Date();
            const fecha = ts.toLocaleDateString('es', { day:'2-digit', month:'short', year:'2-digit' });
            if (fecha !== lastChatDate) {
                lastChatDate = fecha;
                html += `<div class="chat-date-sep">${fecha}</div>`;
            }

            const hora  = ts.toLocaleTimeString('es', { hour:'2-digit', minute:'2-digit' });
            const check = esMio ? `<span class="chat-check">${msg.leido ? '✓✓' : '✓'}</span>` : '';
            const nombre = (!esMio && esAdmin) ? `<div class="chat-sender-name">SOPORTE C5X</div>` : '';

            html += `
            <div class="chat-bubble-wrap ${side}${adminCls}" data-msg-id="${id}">
                ${nombre}
                <div class="chat-bubble">${escapeHtml(msg.texto)}</div>
                <div class="chat-bubble-meta">${hora} ${check}</div>
            </div>`;
            return html;
        }

        // ── ENVIAR MENSAJE ────────────────────────────────────────────
        async function enviarMensajeChat() {
            const inp = document.getElementById('chatInput');
            if (!inp) return;
            const texto = inp.value.trim();
            if (!texto) return;

            if (!fbUser) { loginGoogleChat(); return; }

            const btn = document.getElementById('chatSendBtn');
            if (btn) btn.disabled = true;
            inp.value = '';

            try {
                const uid = isSuperAdmin
                    ? (document.getElementById('chatAdminTarget')?.value || fbUser.uid)
                    : fbUser.uid;

                await fbDb
                    .collection('consultas_privadas')
                    .doc(uid)
                    .collection('mensajes')
                    .add({
                        texto,
                        autor_uid:    fbUser.uid,
                        autor_nombre: fbUser.displayName || 'Usuario',
                        autor_email:  fbUser.email,
                        es_soporte:   isSuperAdmin,
                        leido:        false,
                        created_at:   firebase.firestore.FieldValue.serverTimestamp()
                    });
            } catch (e) {
                showToast('⚠️ Error enviando mensaje');
                inp.value = texto; // restaurar si falla
            } finally {
                if (btn) btn.disabled = false;
                inp.focus();
            }
        }

        // ── MARCAR MENSAJES COMO LEÍDOS ───────────────────────────────
        function marcarLeidos(uid) {
            if (!fbDb || !fbUser) return;
            fbDb.collection('consultas_privadas').doc(uid)
                .collection('mensajes')
                .where('leido', '==', false)
                .where('autor_uid', '!=', fbUser.uid)
                .get().then(snap => {
                    const batch = fbDb.batch();
                    snap.forEach(d => batch.update(d.ref, { leido: true }));
                    batch.commit();
                    actualizarBadgeChat(0);
                }).catch(() => {});
        }

        // ── BADGE DE MENSAJES NO LEÍDOS ───────────────────────────────
        function escucharBadgeChat() {
            if (!fbUser || !fbDb) return;
            fbDb.collection('consultas_privadas').doc(fbUser.uid)
                .collection('mensajes')
                .where('leido', '==', false)
                .where('es_soporte', '==', true)
                .onSnapshot(snap => {
                    actualizarBadgeChat(snap.size);
                });
        }

        function actualizarBadgeChat(n) {
            const badge = document.getElementById('chatBadge');
            if (!badge) return;
            if (n > 0) { badge.style.display = 'inline-block'; badge.textContent = n; }
            else { badge.style.display = 'none'; }
        }

        // ── UI DE ESTADO DE CONEXIÓN ──────────────────────────────────
        function actualizarUIConexion(conectado, online) {
            const dot   = document.getElementById('chatFirebaseStatus');
            const label = document.getElementById('chatStatusLabel');
            if (!dot || !label) return;
            if (conectado && online) {
                dot.style.background = 'var(--long)';
                label.textContent    = '● En línea';
                label.className      = 'chat-header-status online';
            } else if (conectado) {
                dot.style.background = 'var(--brand)';
                label.textContent    = '● Conectado';
                label.className      = 'chat-header-status';
            } else {
                dot.style.background = 'var(--text-tertiary)';
                label.textContent    = '● Desconectado';
                label.className      = 'chat-header-status';
            }
        }

        // ── AVISO CUANDO FIREBASE NO ESTÁ CONFIGURADO ─────────────────
        function mostrarAvisoFirebase() {
            const section = document.getElementById('section-chat');
            if (!section || section.querySelector('.chat-fb-notice')) return;
            const notice = document.createElement('div');
            notice.className = 'chat-fb-notice';
            notice.innerHTML = `
                ⚙️ <strong>Firebase no configurado todavía.</strong><br>
                Agrega tu configuración de Firebase en el código<br>
                (variable <code>FB_CONFIG</code>) para activar el chat en tiempo real.
            `;
            section.insertBefore(notice, section.querySelector('.chat-messages'));
        }

        // ── HELPERS ───────────────────────────────────────────────────
        function escapeHtml(t) {
            return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
                    .replace(/\n/g,'<br>');
        }

        // ── ACTUALIZAR ÍCONO DE TEMA ───────────────────────────────────
        function updateThemeIcon() {
            const hint  = document.getElementById('themeHint');
            const label = document.getElementById('themeLabel');
            if (hint)  hint.textContent  = isLight ? '☀️' : '🌙';
            if (label) label.textContent = isLight ? 'CLARO' : 'OSCURO';
        }
        function toggleUserMenu() {
            const dd = document.getElementById('userDropdown');
            if (dd) dd.classList.toggle('open');
        }
        function closeUserMenu() {
            const dd = document.getElementById('userDropdown');
            if (dd) dd.classList.remove('open');
        }
        document.addEventListener('click', function(e) {
            const wrapper = document.getElementById('userMenuWrapper');
            if (wrapper && !wrapper.contains(e.target)) closeUserMenu();
        });

        // ─── GOOGLE ACCOUNT ────────────────────────────────────────────
        // ════════════════════════════════════════════════════════════════
        //  GOOGLE AUTH — vía Firebase Authentication (no GSI separado)
        // ════════════════════════════════════════════════════════════════

        let googleUser = null; // mantenido para compatibilidad con el menú header

        function initGoogleSignIn() {
            // Con Firebase Auth no se necesita el SDK de GSI separado.
            // initFirebase() maneja todo mediante onAuthStateChanged.
            // Si ya hay sesión activa, la UI se actualiza desde el listener.
        }

        // ── Login con Google usando Firebase Auth ────────────────────
        function loginWithGoogle() {
            if (!initFirebase()) {
                showToast('⚙️ Primero configura Firebase en Ajustes → Cuenta', 3500);
                // Mostrar form de config
                switchView('settings');
                setTimeout(() => {
                    const el = document.getElementById('cloudNeedsConfig');
                    if (el) { el.style.display = ''; el.scrollIntoView({ behavior: 'smooth' }); }
                }, 400);
                return;
            }
            if (!fbAuth) return showToast('⚠️ Firebase no inicializado');
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.addScope('email');
            provider.addScope('profile');
            provider.setCustomParameters({ prompt: 'select_account' });
            fbAuth.signInWithPopup(provider)
                .then(result => {
                    const user = result.user;
                    googleUser = { name: user.displayName, email: user.email, picture: user.photoURL };
                    closeUserMenu();
                    showToast('✅ ' + user.displayName + ' — Cargando datos de la nube...', 3000, false, true);
                })
                .catch(err => {
                    if (err.code !== 'auth/popup-closed-by-user') {
                        showToast('⚠️ Error al conectar: ' + err.message);
                    }
                });
        }

        // ── Logout ───────────────────────────────────────────────────
        function logoutGoogle() {
            if (!fbAuth) return;
            if (!confirm('¿Cerrar sesión de Google?\n\nTus datos locales no se borran.')) return;
            // Guardar antes de salir
            saveToCloud(false).then(() => {
                fbAuth.signOut().then(() => {
                    googleUser = null;
                    fbUser     = null;
                    updateGoogleUI();
                    updateCloudUI();
                    showToast('👋 Sesión cerrada — datos locales conservados');
                });
            });
        }

        // ── Clic en el botón de cuenta del menú header ───────────────
        function handleGoogleAccount() {
            if (fbUser) {
                closeUserMenu();
                switchView('settings');
                setTimeout(() => {
                    const el = document.getElementById('cloudLoggedIn');
                    if (el) el.scrollIntoView({ behavior: 'smooth' });
                }, 350);
            } else {
                loginWithGoogle();
            }
        }

        // ── Actualizar UI del menú header ─────────────────────────────
        function updateGoogleUI() {
            const row    = document.getElementById('googleAccountRow');
            const label  = document.getElementById('googleLabel');
            const sub    = document.getElementById('googleSub');
            const status = document.getElementById('googleStatus');
            const userBtn= document.getElementById('userAvatarBtn');
            const emoji  = document.getElementById('userAvatarEmoji');
            const user   = fbUser;
            if (user) {
                const name = user.displayName || 'Usuario';
                if (label)   label.textContent = name.split(' ')[0].toUpperCase();
                if (sub)     sub.textContent   = user.email || '';
                if (row)     row.classList.add('connected');
                if (status)  status.innerHTML  = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" fill="#34A853"/><polyline points="8 12 11 15 16 9" stroke="#fff" stroke-width="2.5" fill="none"/></svg>';
                if (userBtn) userBtn.classList.add('google-connected');
                if (emoji)   emoji.textContent = '✓';
            } else {
                if (label)   label.textContent = 'CUENTA';
                if (sub)     sub.textContent   = 'Conectar con Google';
                if (row)     row.classList.remove('connected');
                if (status)  status.innerHTML  = '<svg width="12" height="12" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg>';
                if (userBtn) userBtn.classList.remove('google-connected');
                if (emoji)   emoji.textContent = '👤';
            }
        }

        // ── Mostrar/ocultar secciones según rol ──────────────────────────
        function applyRoleVisibility() {
            const adminEls   = document.querySelectorAll('.admin-only');
            const adminGrids = document.querySelectorAll('.admin-only-grid');
            if (isSuperAdmin) {
                adminEls.forEach(el   => el.classList.add('visible'));
                adminGrids.forEach(el => el.classList.add('visible'));
            } else {
                adminEls.forEach(el   => el.classList.remove('visible'));
                adminGrids.forEach(el => el.classList.remove('visible'));
            }
        }

        // ── Actualizar sección CUENTA en Ajustes ─────────────────────
        function updateCloudUI() {
            const elNeeds  = document.getElementById('cloudNeedsConfig');
            const elNoAuth = document.getElementById('cloudNotLoggedIn');
            const elAuth   = document.getElementById('cloudLoggedIn');
            // Config siempre disponible (hardcodeada)
            const fbOk = true;

            if (fbUser) {
                // Autenticado
                if (elNeeds)  elNeeds.style.display  = 'none';
                if (elNoAuth) elNoAuth.style.display  = 'none';
                if (elAuth)   elAuth.style.display    = '';

                // Datos del usuario
                const nameEl   = document.getElementById('cloudUserName');
                const emailEl  = document.getElementById('cloudUserEmail');
                const avatarEl = document.getElementById('cloudAvatar');
                const adminEl  = document.getElementById('cloudAdminBadge');
                const adminPanel = document.getElementById('cloudAdminPanel');
                const adminUID   = document.getElementById('adminUIDDisplay');

                if (nameEl)  nameEl.textContent  = fbUser.displayName || 'Usuario';
                if (emailEl) emailEl.textContent = fbUser.email || '';
                if (avatarEl) {
                    if (fbUser.photoURL) {
                        avatarEl.innerHTML = `<img src="${fbUser.photoURL}" alt="avatar" onerror="this.parentElement.textContent='👤'">`;
                    } else {
                        avatarEl.textContent = '👤';
                    }
                }
                // Mostrar UID siempre
                if (adminUID) adminUID.textContent = fbUser.uid;

                // Badge y panel admin
                const isAdmin = isSuperAdmin;
                if (adminEl)    adminEl.style.display    = isAdmin ? '' : 'none';
                if (adminPanel) {
                    adminPanel.style.display = isAdmin ? '' : 'none';
                    if (isAdmin) renderWhitelist();
                }
                // Aplicar visibilidad de secciones según rol
                applyRoleVisibility();

                // Texto de estado del botón admin
                const adminStatusEl = document.getElementById('adminStatusText');
                const btnAdmin      = document.getElementById('btnSetAdmin');
                if (isAdmin) {
                    if (adminStatusEl) adminStatusEl.textContent = '✅ Ya eres Super Admin';
                    if (adminStatusEl) adminStatusEl.style.color = 'var(--long)';
                    if (btnAdmin) btnAdmin.style.display = 'none';
                } else {
                    if (adminStatusEl) adminStatusEl.textContent = 'Toca "SER ADMIN" para acceso completo';
                    if (btnAdmin) btnAdmin.style.display = '';
                }

                updateCloudStats();
                setCloudSyncPill('synced', 'ACTIVO');

            } else {
                // Firebase configurado pero sin sesión → mostrar botón Google
                if (elNeeds)  elNeeds.style.display  = 'none';
                if (elNoAuth) elNoAuth.style.display  = '';
                if (elAuth)   elAuth.style.display    = 'none';
            }
        }

        // ── Actualizar estadísticas de sync ───────────────────────────
        function updateCloudStats() {
            const activeSlots = slots.filter(s => s && s.name).length;
            const set = (id, v) => { const el = document.getElementById(id); if(el) el.textContent = v; };
            set('csSlots',   activeSlots + '/5');
            set('csHistory', (Array.isArray(history) ? history.length : 0) + ' ops');
            set('csDevice',  /Mobile|Android|iPhone/i.test(navigator.userAgent) ? '📱 Móvil' : '💻 PC');
            const ts = localStorage.getItem('c5x_last_cloud_save');
            if (ts) {
                const d = new Date(parseInt(ts));
                set('csLastSync', d.toLocaleTimeString('es', { hour: '2-digit', minute: '2-digit' }));
                const syncEl = document.getElementById('cloudLastSyncText');
                if (syncEl) syncEl.textContent = 'Última sincronización: ' + d.toLocaleString('es');
            } else {
                set('csLastSync', '---');
            }
        }

        // ── Cambiar estado del pill de sync ──────────────────────────
        function setCloudSyncPill(state, label) {
            const pill = document.getElementById('cloudSyncPill');
            const lbl  = document.getElementById('cloudSyncLabel');
            if (pill) pill.className = 'cloud-sync-pill ' + state;
            if (lbl)  lbl.textContent = label;
        }

        // ── Copiar UID ──────────────────────────────────────────────────
        function copyAdminUID() {
            if (!fbUser) return;
            const uid = fbUser.uid;
            const fallback = () => {
                const el = document.createElement('textarea');
                el.value = uid; el.style.position='fixed'; el.style.opacity='0';
                document.body.appendChild(el); el.select(); el.setSelectionRange(0,99999);
                try { document.execCommand('copy'); showToast('📋 UID copiado', 2500, false, true); }
                catch(e) { showToast('UID: ' + uid, 8000); }
                document.body.removeChild(el);
            };
            if (navigator.clipboard) {
                navigator.clipboard.writeText(uid)
                    .then(() => showToast('📋 UID copiado al portapapeles', 2500, false, true))
                    .catch(fallback);
            } else { fallback(); }
        }

        // ── Hacerse Super Admin con un toque ─────────────────────────
        async function setMeAsAdmin() {
            if (!fbUser) return showToast('⚠️ Inicia sesión primero');
            if (!confirm('¿Establecerte como Super Admin?\n\nSolo hazlo si eres el dueño de la app.\nTendrás acceso al chat de soporte de todos los usuarios.')) return;
            if (!fbDb) return showToast('⚠️ Sin conexión a Firebase');
            try {
                // 1. Guardar en Firestore PRIMERO (puede fallar por permisos)
                await fbDb.collection('config').doc('admin').set({
                    uid: fbUser.uid,
                    email: fbUser.email,
                    setAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                // 2. Solo si Firestore OK → guardar local y activar rol
                localStorage.setItem('c5x_super_admin_uid', fbUser.uid);
                localStorage.setItem('c5x_super_admin_uid_cache', fbUser.uid);
                localStorage.setItem('c5x_ok_' + fbUser.uid, '1');
                isSuperAdmin = true;
                updateCloudUI();
                applyRoleVisibility();
                showToast('⭐ ¡Ahora eres Super Admin!', 3000, false, true);
                console.log('✅ Admin UID guardado en Firestore:', fbUser.uid);
            } catch(e) {
                showToast('❌ Error al guardar admin: ' + e.message);
                console.error('setMeAsAdmin error:', e);
            }
        }

        // ── Quitar rol Admin ─────────────────────────────────────────
        function confirmRemoveAdmin() {
            const r1 = confirm('⚠️ ¿Seguro que quieres dejar de ser Super Admin?\nEsto bloqueará tu acceso a funciones avanzadas.');
            if (!r1) return;
            const r2 = confirm('🚨 ÚLTIMA CONFIRMACIÓN\n¿Confirmas que quieres eliminar tu rol de administrador?');
            if (!r2) return;
            removeAdminRole();
        }
        function removeAdminRole() {
            if (!confirm('¿Quitar tu rol de Super Admin en este dispositivo?')) return;
            localStorage.removeItem('c5x_super_admin_uid');
            localStorage.removeItem('c5x_super_admin_uid_cache');
            isSuperAdmin = false;
            updateCloudUI();
            applyRoleVisibility();
            showToast('✅ Rol admin eliminado');
        }

        function triggerHaptic() { if (navigator.vibrate) navigator.vibrate(10); }
        function forceCaps(el) { const start = el.selectionStart; const end = el.selectionEnd; el.value = el.value.toUpperCase(); el.setSelectionRange(start, end); }
        function handleEnter(e) { if(e.key === 'Enter') verifyAndAddCoin(); }
        function startTickerSystem() { 
            if(tickerIntervalId) clearInterval(tickerIntervalId);
            if(!tickerAssets || tickerAssets.length === 0) {
                tickerAssets = ["BTC", "ETH", "SUI", "AVAX", "BNB"];
                localStorage.setItem('c5x_ticker_assets', JSON.stringify(tickerAssets));
            }
            // Filtrar tokens ETF del ticker
            tickerAssets = tickerAssets.filter(t => !t.match(/[35][LS]/));
            if(assetIdx < 0 || assetIdx >= tickerAssets.length) {
                assetIdx = 0;
                localStorage.setItem('c5x_ticker_index', assetIdx);
            }
            updateTicker();
            // El avance del ticker lo maneja el masterClock cada 10s
        }
        async function updateTicker() { let sym = tickerAssets[assetIdx]; let apiSym = sym.includes('USDT') ? sym : sym + "USDT"; let displaySym = sym.replace("USDT",""); document.getElementById('t-sym').textContent = displaySym; if(currentWs) { if(currentWs.url && currentWs.url.includes(apiSym.toLowerCase())) return; currentWs.close(); currentWs = null; } try { const wsUrl = `wss://stream.binance.com:9443/ws/${apiSym.toLowerCase()}@trade`; currentWs = new WebSocket(wsUrl); currentWs.onmessage = (event) => { const data = JSON.parse(event.data); const price = parseFloat(data.p); updateTickerUI(displaySym, price, true); updateSlotStatus(displaySym, price); document.getElementById('t-dot').classList.add('pulse'); }; currentWs.onerror = () => { fetchTickerRest(apiSym, displaySym); document.getElementById('t-dot').classList.remove('pulse'); }; } catch(e) { fetchTickerRest(apiSym, displaySym); } }
        async function fetchTickerRest(apiSym, displaySym) { try { let price = 0; let change = null; const gateSym = displaySym + "_USDT"; const data = await callGateApi("GET", "/spot/tickers", {currency_pair: gateSym}); let row = Array.isArray(data) ? data[0] : null; if(row) { price = parseFloat(row.last); change = parseFloat(row.change_percentage); } if(price > 0) { updateTickerUI(displaySym, price, true, change); updateSlotStatus(displaySym, price); } } catch(e) {} }
        function updateTickerUI(sym, price, isUp, change = null) { if (isHeaderPinnedByScroll && sym !== slots[activeIdx].name) return; currentTickerSymbol = sym; let displayPrice = (price < 1) ? price.toFixed(8) : price.toLocaleString(); document.getElementById('t-price').textContent = displayPrice; document.getElementById('t-sym').textContent = sym; document.getElementById('t-dot').style.background = isUp ? 'var(--long)' : 'var(--short)'; const pctEl = document.getElementById('t-pct'); if(change !== null) { pctEl.textContent = (change >= 0 ? '+' : '') + change.toFixed(2) + '%'; pctEl.className = change >= 0 ? 'ticker-pct up' : 'ticker-pct down'; pctEl.style.display = 'inline-block'; } else { const found = allGateETFs.find(t => t.currency_pair === sym + "_USDT"); if(found) { const c = parseFloat(found.change_percentage); pctEl.textContent = (c >= 0 ? '+' : '') + c.toFixed(2) + '%'; pctEl.className = c >= 0 ? 'ticker-pct up' : 'ticker-pct down'; pctEl.style.display = 'inline-block'; } } }
        function toggleFullscreenChart(e) { if(e) e.stopPropagation(); const wrapper = document.getElementById('tv_chart'); wrapper.classList.toggle('fullscreen'); setTimeout(() => loadChart(chartSymbol), 100); }
        function toggleFullscreenChart2(e) { if(e) e.stopPropagation(); const wrapper = document.getElementById('tv_chart2'); wrapper.classList.toggle('fullscreen'); setTimeout(() => loadChart2(getChart2Symbol()), 100); }
        
        
        async function loadGateETFs() { const grid = document.getElementById('etfGrid'); const desktopList = document.getElementById('desktop-etf-list'); if(allGateETFs.length > 0) { filterETFs(""); return; } try { await fetchAndCalcTopDroppers(); filterETFs(""); } catch(e) { grid.innerHTML = '<div style="text-align:center; padding:20px; color:var(--danger)">Error al cargar datos.<br>Revisa tu conexión.</div>'; } }
        function toggleEtfFavorite(symbol, e) { e.stopPropagation(); if(etfFavorites.includes(symbol)) etfFavorites = etfFavorites.filter(s => s !== symbol); else etfFavorites.push(symbol); localStorage.setItem('c5x_etf_favorites', JSON.stringify(etfFavorites)); filterETFs(document.querySelector('.etf-search-input').value); }
        function filterETFs(query) { const grid = document.getElementById('etfGrid'); const desktopList = document.getElementById('desktop-etf-list'); const term = query.toUpperCase().trim(); 
            let sorted = [...allGateETFs];
            let filtered;
            if(term) {
                // Si hay búsqueda, mostrar resultados del filtro
                filtered = sorted.filter(t => t.currency_pair.includes(term)).slice(0, 10);
            } else {
                // Sin búsqueda: top 10 entre más caídos + más oportunidades
                // Ordenar por score descendente y cambio ascendente (más negativos primero)
                const byScore = [...sorted].sort((a, b) => (b.score||0) - (a.score||0));
                const byDrop  = [...sorted].sort((a, b) => parseFloat(a.change_percentage) - parseFloat(b.change_percentage));
                // Mezclar: 5 mayores caídas + 5 mayores oportunidades (score), sin duplicados
                const topDrops = byDrop.slice(0, 5);
                const topOpps  = byScore.filter(t => !topDrops.includes(t)).slice(0, 5);
                const combined = [...topDrops, ...topOpps];
                // Re-ordenar combinado: primero por score DESC para que las oportunidades sean primeras cuando hay empate
                filtered = combined.sort((a, b) => {
                    const aFav = etfFavorites.includes(a.currency_pair.replace('_', ''));
                    const bFav = etfFavorites.includes(b.currency_pair.replace('_', ''));
                    if(aFav && !bFav) return -1; if(!aFav && bFav) return 1;
                    return parseFloat(a.change_percentage) - parseFloat(b.change_percentage);
                });
            }
            let htmlContent = '';
            if(filtered.length === 0) { htmlContent = '<div style="text-align:center; padding:20px; color:var(--text-tertiary)">Sin resultados</div>'; }
            else { filtered.forEach((t, index) => { const price = parseFloat(t.last); const change = parseFloat(t.change_percentage); const displayPrice = (price < 1) ? price.toFixed(6) : price.toFixed(4); const pairName = t.currency_pair.replace('_USDT', '').replace('USDT', ''); const nameColor = getCoinColor(pairName); const volume = parseFloat(t.quote_volume) || 0; const volumeFormatted = volume >= 1000000 ? (volume / 1000000).toFixed(2) + 'M' : volume >= 1000 ? (volume / 1000).toFixed(2) + 'K' : volume.toFixed(0); const score = t.score || 0; const zone = t.zone || 'WARM'; const zoneColor = zone === 'GOLD' ? 'var(--zone-gold)' : zone === 'HOT' ? 'var(--zone-hot)' : 'var(--zone-warm)'; const flashClass = zone === 'GOLD' ? 'flash-gold-card' : ''; htmlContent += `<div class="unified-card ${flashClass}" onclick="smartSelectETF('${pairName}', ${price})"><div class="u-index">${index+1}</div><div class="u-center"><div class="u-title" style="font-size:22px; color:${nameColor}; font-weight:900;">${pairName}</div><div style="font-family:'JetBrains Mono'; font-size:15px; color:var(--text-primary); font-weight:700;">$${displayPrice}</div><div style="font-size:11px; color:var(--text-tertiary); font-weight:600; margin-top:4px;">VOL: $${volumeFormatted}</div></div><div class="u-right"><div class="etf-change-badge ${change >= 0 ? 'etf-up' : 'etf-down'}">${change >= 0 ? '+' : ''}${change.toFixed(2)}%</div><div class="etf-score-display" style="margin-top:6px;"><span style="font-size:10px; color:var(--text-tertiary); font-family:var(--font-head); letter-spacing:1px;">SCORE</span><span style="color:${zoneColor}; font-size:24px;">${score}</span></div></div></div>`; }); }
            if(grid) grid.innerHTML = htmlContent; if(desktopList) desktopList.innerHTML = htmlContent; }
        function smartSelectETF(symbol, price, isGoldenFromRadar = false) { 
            triggerHaptic(); 
            let cleanName = symbol.replace('_USDT','').replace('USDT',''); 

            // Si ya existe en algún slot, activarlo y navegar al panel
            const dupSlot = slots.findIndex(s => s.name === cleanName); 
            if (dupSlot !== -1) { 
                switchView('operate', false);
                goToSlotLevels(dupSlot);   // activa slot + Panel 3 + niveles
                return showToast("⚡ " + cleanName + " → SLOT " + (dupSlot + 1)); 
            } 

            // Siempre agregar en el PRIMER slot vacío (orden 1→5)
            let targetIdx = slots.findIndex(s => !s.name || s.name === ''); 
            if (targetIdx === -1) { 
                return showToast("⚠️ No hay slots disponibles (5/5 ocupados)"); 
            } 
            slots[targetIdx] = {
                name: cleanName,
                price: price,
                initialPrice: price,
                buys: [],
                locked: true,
                note: '',
                alerted: false,
                priceAdjusted: false,
                strat: 'normal', // Siempre normal
                capital: strategyParams.normal.capital || 5,
                roi: strategyParams.normal.roi || 100,
                multipleBuys: {}
            };
            
            save(); 
            updateBodyMode(cleanName);
            renderAllDashboards();
            switchView('operate', false);
            goToSlotLevels(targetIdx);   // activa slot + Panel 3 + niveles
            showToast(`✅ ${cleanName} → SLOT ${targetIdx + 1}`);
        }
        // Variables para el modal de confirmación
        let confirmCallback = null;
        let pendingLevelData = null;
        
        function showConfirmModal(title, message, callback) {
            const modal = document.getElementById('customConfirmModal');
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            confirmCallback = callback;
            modal.classList.add('show');
        }
        
        function closeConfirmModal(accepted) {
            const modal = document.getElementById('customConfirmModal');
            modal.classList.remove('show');
            if (confirmCallback) {
                confirmCallback(accepted);
                confirmCallback = null;
            }
        }
        
        function handleLevelClick(levelIndex) { 
            console.log(`🎯 Click en nivel ${levelIndex + 1}, Slot activo: ${activeIdx + 1}`);
            
            if (tradingMode !== 'manual') { 
                return showToast("⚠️ Cambia a MANUAL para seleccionar niveles"); 
            } 
            
            triggerHaptic(); 
            const s = slots[activeIdx]; 
            if (!s.name || !s.price) return; 
            
            // Determinar si el nivel permite compras múltiples
            const canBuyMultiple = (levelIndex >= 6 && levelIndex <= 11); // Niveles 7-12
            console.log(`📊 Nivel ${levelIndex + 1}: canBuyMultiple=${canBuyMultiple}`);
            
            if (!s.multipleBuys) s.multipleBuys = {}; 
            if (!s.multipleBuys[levelIndex]) s.multipleBuys[levelIndex] = []; 
            const currentBuys = s.multipleBuys[levelIndex].length; 
            console.log(`🔢 Compras actuales en nivel ${levelIndex + 1}: ${currentBuys}/4`);
            
            // Verificar órdenes activas SOLO para niveles simples (1-6)
            if (!canBuyMultiple) {
                const key = getOrderKey(activeIdx, levelIndex); 
                if (activeOrders[key]) { 
                    const order = activeOrders[key]; 
                    if (order.status === 'filled') return showToast(`✅ Nivel ${levelIndex + 1} ya EJECUTADO`); 
                    if (order.status === 'open') return showToast(`⏳ Nivel ${levelIndex + 1} tiene orden PENDIENTE`); 
                } 
                
                // Verificar si ya fue comprado (niveles 1-6)
                if (s.buys && s.buys.includes(levelIndex)) { 
                    return showToast(`✅ Nivel ${levelIndex + 1} ya comprado`); 
                }
            }
            
            // Para niveles múltiples (7-12), verificar máximo de compras
            if (canBuyMultiple && currentBuys >= 4) { 
                return showToast(`⚠️ Máximo 4 compras en nivel ${levelIndex + 1}`); 
            } 
            
            const data = getLevelData(s, levelIndex); 
            const buyNumber = canBuyMultiple ? currentBuys + 1 : 1; 
            
            const title = canBuyMultiple 
                ? `¿Comprar nivel ${levelIndex + 1}? (${buyNumber}/4)` 
                : `¿Comprar nivel ${levelIndex + 1}?`; 
            const message = `$${data.usd.toFixed(2)} USDT`;
            
            showConfirmModal(title, message, (accepted) => {
                if (accepted) {
                    console.log(`✅ Compra aceptada - Nivel ${levelIndex + 1}, Slot ${activeIdx + 1}, MultiBuy: ${canBuyMultiple}`);
                    
                    if (canBuyMultiple) { 
                        // Agregar a compras múltiples
                        s.multipleBuys[levelIndex].push({ 
                            price: data.price, 
                            qty: data.qty, 
                            usd: data.usd, 
                            timestamp: Date.now() 
                        }); 
                        console.log(`💰 Agregada compra #${buyNumber} al nivel ${levelIndex + 1}`);
                        console.log(`📦 MultiBuys[${levelIndex}]:`, s.multipleBuys[levelIndex]);
                    } else { 
                        // Compra simple niveles 1-6
                        if(!s.buys.includes(levelIndex)) { 
                            s.buys.push(levelIndex); 
                        } 
                        console.log(`💰 Agregada compra simple al nivel ${levelIndex + 1}`);
                    } 
                    
                    // GUARDADO INMEDIATO Y AGRESIVO - MÚLTIPLES CAPAS
                    console.log(`💾 Iniciando guardado de slot ${activeIdx + 1}...`);
                    save();
                    saveActiveOrders();
                    saveSlotsLevels();
                    localStorage.setItem('c5x_slots', JSON.stringify(slots));
                    localStorage.setItem('c5x_slots_real', JSON.stringify(slots));
                    console.log(`✅ Guardado completado para slot ${activeIdx + 1}`);
                    
                    // Forzar actualización visual COMPLETA
                    renderLevels(); 
                    // Actualizar TODOS los dashboards (slot activo + restantes + dashboard general)
                    for (let i = 0; i < 5; i++) updateDashboardStatsForSlot(i);
                    refreshAllDashboardData();
                    
                    // Enviar orden si modo real
                    sendManualOrder(levelIndex, data); 
                    
                    // Toast de confirmación
                    if (canBuyMultiple) {
                        showToast(`✅ Nivel ${levelIndex + 1} compra #${buyNumber} guardada`);
                    } else {
                        showToast(`✅ Nivel ${levelIndex + 1} comprado`);
                    }
                    
                    // Segundo refresco tras 800ms (por si monitorOrder actualiza estado)
                    setTimeout(() => {
                        save();
                        for (let i = 0; i < 5; i++) updateDashboardStatsForSlot(i);
                        refreshAllDashboardData();
                    }, 800);
                }
            });
        }
        async function sendManualOrder(levelIndex, data) { const slot = slots[activeIdx]; const symbol = slot.name.toUpperCase(); const price = data.price.toFixed(8); const amount = data.qty.toFixed(4); const key = getOrderKey(activeIdx, levelIndex); try { updateLevelStatus(levelIndex, 'pending', 'ENVIANDO...'); if (!apiConfig.key || !apiConfig.secret) { 
            // MODO SIMULACIÓN - crear orden simulada inmediatamente
            activeOrders[key] = { 
                orderId: 'SIM_' + Date.now(), 
                status: 'filled', 
                price: parseFloat(price), 
                amount: parseFloat(amount), 
                symbol: symbol, 
                timestamp: Date.now(), 
                simulated: true, 
                mode: 'manual' 
            }; 
            updateLevelStatus(levelIndex, 'filled', 'EJECUTADA ✓ (SIM)'); 
            saveActiveOrders(); 
            renderLevels(); 
            for (let i = 0; i < 5; i++) updateDashboardStatsForSlot(i);
            refreshAllDashboardData();
            showToast(`✅ Nivel ${levelIndex + 1} ejecutado (SIMULACIÓN)`); 
            return true; 
        } const orderParams = { currency_pair: symbol + '_USDT', side: 'buy', amount: amount, price: price, type: 'limit', time_in_force: 'gtc' }; const response = await callGateApi("POST", "/spot/orders", orderParams, true); if (response && response.id) { activeOrders[key] = { orderId: response.id, status: 'open', price: parseFloat(price), amount: parseFloat(amount), symbol: symbol, timestamp: Date.now(), simulated: false, mode: 'manual' }; updateLevelStatus(levelIndex, 'pending', 'PENDIENTE'); saveActiveOrders(); monitorOrder(levelIndex, response.id); return true; } else { throw new Error("Respuesta inválida de Gate.io"); } } catch (error) { updateLevelStatus(levelIndex, 'error', 'ERROR'); showToast(`❌ Error en N${levelIndex + 1}: ${error.message}`); return false; } }
        async function monitorOrder(levelIndex, orderId) { const key = getOrderKey(activeIdx, levelIndex); const checkInterval = setInterval(async () => { try { const slot = slots[activeIdx]; const symbol = slot.name.toUpperCase() + '_USDT'; const orderStatus = await callGateApi("GET", `/spot/orders/${orderId}`, { currency_pair: symbol }, true); if (!orderStatus) { clearInterval(checkInterval); return; } if (orderStatus.status === 'closed' || orderStatus.status === 'filled') { clearInterval(checkInterval); activeOrders[key].status = 'filled'; activeOrders[key].filledTime = Date.now(); updateLevelStatus(levelIndex, 'filled', 'EJECUTADA ✓'); saveActiveOrders(); renderLevels(); for (let i = 0; i < 5; i++) updateDashboardStatsForSlot(i); refreshAllDashboardData(); if (tradingMode === 'auto') { setTimeout(() => { sendNextAutoLevel(); }, 2000); } } else if (orderStatus.status === 'cancelled') { clearInterval(checkInterval); delete activeOrders[key]; updateLevelStatus(levelIndex, 'error', 'CANCELADA'); showToast(`⚠️ Orden N${levelIndex + 1} cancelada`); for (let i = 0; i < 5; i++) updateDashboardStatsForSlot(i); refreshAllDashboardData(); } } catch (error) { clearInterval(checkInterval); } }, 5000); }
        function updateLevelStatus(levelIndex, status, badgeText) { const levelCard = document.querySelector(`[data-level-index="${levelIndex}"]`); if (!levelCard) return; levelCard.classList.remove('order-selected', 'order-pending', 'order-filled', 'order-error'); switch(status) { case 'pending': levelCard.classList.add('order-pending'); break; case 'filled': levelCard.classList.add('order-filled'); break; case 'error': levelCard.classList.add('order-error'); break; default: levelCard.classList.add('order-selected'); } let badge = levelCard.querySelector('.order-status-badge'); if (!badge) { badge = document.createElement('div'); badge.className = 'order-status-badge'; levelCard.appendChild(badge); } badge.className = `order-status-badge ${status}`; badge.textContent = badgeText; }
        async function sendAutoLevelOrder(levelIndex) { const slot = slots[activeIdx]; if (!slot.name || !slot.price) return false; const data = getLevelData(slot, levelIndex); const symbol = slot.name.toUpperCase(); const price = data.price.toFixed(8); const amount = data.qty.toFixed(4); const key = getOrderKey(activeIdx, levelIndex); try { if (!slot.buys.includes(levelIndex)) { slot.buys.push(levelIndex); save(); } renderLevels(); updateLevelStatus(levelIndex, 'pending', 'ENVIANDO...'); if (!apiConfig.key || !apiConfig.secret) { 
            // MODO SIMULACIÓN AUTO
            activeOrders[key] = { 
                orderId: 'SIM_AUTO_' + Date.now(), 
                status: 'filled', 
                price: parseFloat(price), 
                amount: parseFloat(amount), 
                symbol: symbol, 
                timestamp: Date.now(), 
                simulated: true, 
                mode: 'auto' 
            }; 
            updateLevelStatus(levelIndex, 'filled', 'EJECUTADA ✓ (SIM)'); 
            saveActiveOrders(); 
            updateDashboardStats(); 
            renderLevels(); 
            return true; 
        } const orderParams = { currency_pair: symbol + '_USDT', side: 'buy', amount: amount, price: price, type: 'limit', time_in_force: 'gtc' }; const response = await callGateApi("POST", "/spot/orders", orderParams, true); if (response && response.id) { activeOrders[key] = { orderId: response.id, status: 'open', price: parseFloat(price), amount: parseFloat(amount), symbol: symbol, timestamp: Date.now(), simulated: false, mode: 'auto' }; updateLevelStatus(levelIndex, 'pending', 'PENDIENTE'); saveActiveOrders(); monitorOrder(levelIndex, response.id); return true; } else { throw new Error("Respuesta inválida de Gate.io"); } } catch (error) { updateLevelStatus(levelIndex, 'error', 'ERROR'); showToast(`❌ Error AUTO N${levelIndex + 1}`); return false; } }
        let priceMonitorInterval = null; let currentAutoLevel = 0; let trailingStopData = {};
        function startAutoTrading() { const slot = slots[activeIdx]; if (!slot || !slot.name || !slot.price) { tradingMode = 'manual'; updateTradingModeUI(); return; } let startLevel = 0; for (let i = 0; i < 12; i++) { const key = getOrderKey(activeIdx, i); if (activeOrders[key] && activeOrders[key].status === 'filled') { startLevel = i + 1; } else { break; } } if (startLevel >= 12) { showToast("✅ Todos los niveles ya ejecutados"); tradingMode = 'manual'; updateTradingModeUI(); return; } currentAutoLevel = startLevel; showToast(`🤖 AUTO - Enviando nivel ${currentAutoLevel + 1}`); if(!priceMonitorInterval) { priceMonitorInterval = setInterval(() => { runBotCycle(); }, 3000); } }
        async function runBotCycle() { for(let i=0; i<slots.length; i++) { const s = slots[i]; if (!s || !s.name || !s.price) continue; const liveData = allGateETFs.find(t => t.currency_pair === s.name + "_USDT"); const currentPrice = liveData ? parseFloat(liveData.last) : s.price; if(liveData) updateSlotStatus(s.name, currentPrice); smartPriceAdjustment(s, i, currentPrice); if (i === activeIdx && s.priceAdjusted) { renderLevels(); } if (tradingMode !== 'auto') continue; const realAvg = calculateAvgPriceForSlotData(s, i); if (realAvg > 0) { let roiTarget = strategyParams.normal.roi; const targetPrice = realAvg * (1 + (roiTarget / 100)); if (!trailingStopData[i]) { trailingStopData[i] = { maxPrice: 0, targetReached: false, targetPrice: targetPrice }; } trailingStopData[i].targetPrice = targetPrice; if (currentPrice >= targetPrice) { trailingStopData[i].targetReached = true; if (currentPrice > trailingStopData[i].maxPrice) { trailingStopData[i].maxPrice = currentPrice; } const stopPrice = trailingStopData[i].maxPrice * 0.95; if (currentPrice <= stopPrice) { await executeAutoSell(s, i, currentPrice, roiTarget); delete trailingStopData[i]; continue; } continue; } } let nextLevel = -1; for (let lvl = 0; lvl < 12; lvl++) { const key = getOrderKey(i, lvl); if (!activeOrders[key] || activeOrders[key].status !== 'filled') { nextLevel = lvl; break; } } if (nextLevel === -1 || nextLevel >= 12) continue; if (nextLevel > 0) { const prevKey = getOrderKey(i, nextLevel - 1); const previousOrder = activeOrders[prevKey]; if (!previousOrder || previousOrder.status !== 'filled') continue; } const nextLevelData = getLevelDataData(s, nextLevel); if (currentPrice <= nextLevelData.price) { const currentKey = getOrderKey(i, nextLevel); if (activeOrders[currentKey] && activeOrders[currentKey].status === 'open') continue; if(i === activeIdx) { await sendAutoLevelOrder(nextLevel); } else { await sendBackgroundOrder(i, nextLevel, nextLevelData); } } } }
        function calculateAvgPriceForSlotData(s, slotIdx) {
            if(!s.price) return 0; 
            let totalSpent = 0, totalQty = 0, lastPrice = s.price; 
            const limit = customMultipliers.length || 12; 
            const params = strategyParams.normal; 
            
            for(let i=0; i<limit; i++){ 
                let pLevel; 
                let mUSD; 
                
                if(i===0) {
                    pLevel = s.price;
                } else { 
                    const step = getStepForLevel('normal', i); 
                    pLevel = lastPrice*(1-(step/100)); 
                } 
                
                const m = customMultipliers[i]||1; 
                mUSD = m*params.capital; 
                
                const key = getOrderKey(slotIdx, i); 
                if(activeOrders[key] && activeOrders[key].status === 'filled') { 
                    // Orden real ejecutada en Gate.io
                    totalSpent += activeOrders[key].price * activeOrders[key].amount; 
                    totalQty += activeOrders[key].amount; 
                } else if (s.buys && s.buys.includes(i) && !activeOrders[key]) {
                    // Compra manual legacy (sin orden Gate.io)
                    totalSpent += mUSD;
                    totalQty += mUSD / pLevel;
                }
                // Compras múltiples (niveles 7-12)
                if (i >= 6 && i <= 11 && s.multipleBuys && s.multipleBuys[i]) {
                    for (let buy of s.multipleBuys[i]) {
                        totalSpent += buy.usd;
                        totalQty += buy.qty;
                    }
                }
                lastPrice = pLevel; 
            } 
            return totalQty > 0 ? totalSpent/totalQty : 0; 
        }
        function getLevelDataData(s, i) {
            // Usa getStepForLevel para consistencia con getLevelData y renderLevels
            let currentPrice = s.price; 
            
            for (let k = 0; k <= i; k++) { 
                if (k === 0) {
                    currentPrice = s.price;
                } else { 
                    const step = getStepForLevel('normal', k); 
                    currentPrice = currentPrice * (1 - (step / 100)); 
                } 
            } 
            
            const params = strategyParams.normal;
            let multiplier = customMultipliers[i] || 1; 
            let levelCapital = params.capital * multiplier; 
            
            return { price: currentPrice, qty: levelCapital / currentPrice, usd: levelCapital }; 
        }
        async function sendBackgroundOrder(slotIdx, levelIndex, data) { const slot = slots[slotIdx]; const symbol = slot.name.toUpperCase(); const key = getOrderKey(slotIdx, levelIndex); if (!isPrivateMode) { activeOrders[key] = { status: 'filled', price: data.price, amount: data.qty, symbol: symbol, timestamp: Date.now() }; saveActiveOrders(); } }
        async function executeAutoSell(slot, slotIdx, exitPrice, roiTarget) { const keyPrefix = `s${slotIdx}_`; Object.keys(activeOrders).forEach(k => { if(k.startsWith(keyPrefix)) delete activeOrders[k]; }); const log = { date: new Date().toLocaleDateString(), time: 'AUTO', coin: slot.name, profit: 'Calculando...', roi: roiTarget+'%' }; history.push(log); const currentStrat = slot.strat || 'normal'; const currentCapital = strategyParams.normal.capital; const currentRoi = strategyParams.normal.roi; slots[slotIdx] = { name:'', price:0, capital: currentCapital, buys:[], strat: currentStrat, locked: true, roi: currentRoi, note: '', alerted: false, multipleBuys: {} }; save(); showToast(`💰 S${slotIdx+1}: TAKE PROFIT EJECUTADO`); if(slotIdx === activeIdx) selectSlot(activeIdx); }
        function stopAutoTrading() { console.log("Modo manual activado"); }
        function sendNextAutoLevel() { if (tradingMode !== 'auto') return; const slot = slots[activeIdx]; if (!slot.name || !slot.price) return; for (let i = 0; i < 12; i++) { const key = getOrderKey(activeIdx, i); if (!activeOrders[key] || activeOrders[key].status !== 'filled') { const data = getLevelData(slot, i); sendAutoLevelOrder(i); break; } } }
        function checkAndSendNextAutoLevel(slot, slotIdx, currentPrice) { if (tradingMode !== 'auto') return; for (let i = 0; i < 12; i++) { const key = getOrderKey(slotIdx, i); if (!activeOrders[key] || activeOrders[key].status !== 'filled') { const levelData = getLevelDataData(slot, i); if (currentPrice <= levelData.price) { if (slotIdx === activeIdx) { sendAutoLevelOrder(i); } } break; } } }
        function smartPriceAdjustment(slot, slotIdx, currentPrice) { if (!slot.buys || slot.buys.length > 0) return false; let hasActiveOrders = false; for (let i = 0; i < 12; i++) { const key = getOrderKey(slotIdx, i); if (activeOrders[key]) { hasActiveOrders = true; break; } } if (hasActiveOrders) return false; const initialPrice = slot.initialPrice || slot.price; const currentBasePrice = slot.price; if (currentPrice < currentBasePrice) { const oldPrice = slot.price; slot.price = currentPrice; if (!slot.initialPrice) { slot.initialPrice = oldPrice; } slot.priceAdjusted = true; save(); const dropPercent = ((oldPrice - currentPrice) / oldPrice * 100).toFixed(1); showToast(`📉 ${slot.name}: Precio base ajustado de $${oldPrice.toFixed(6)} → $${currentPrice.toFixed(6)} (-${dropPercent}%)`, 4000, false, true); if (slotIdx === activeIdx) { document.getElementById('baseInput').value = currentPrice; const indicator = document.getElementById('priceAdjustIndicator'); if (indicator) { indicator.style.display = 'block'; indicator.title = `Ajustado automáticamente desde $${initialPrice.toFixed(6)}`; } calculate(); renderLevels(); } return true; } return false; }
        function toggleLevelsVisibility() { 
            const container = document.getElementById('levelsGrid'); 
            const investmentBox = document.getElementById('investmentBox'); 
            const icon = investmentBox.querySelector('.expand-icon'); 
            
            if (container.classList.contains('collapsed')) { 
                // EXPANDIR - mostrar niveles con scroll
                container.classList.remove('collapsed'); 
                container.style.maxHeight = ''; // Remover estilo inline para usar CSS
                container.style.opacity = ''; 
                container.style.paddingTop = ''; 
                container.style.paddingBottom = ''; 
                container.style.overflow = ''; // Permitir scroll del CSS
                
                if(icon) icon.classList.remove('expanded'); 
            } else { 
                // COLAPSAR - ocultar niveles
                container.classList.add('collapsed'); 
                
                if(icon) icon.classList.add('expanded'); 
            } 
        }
        function toggleLevelsVisibilityExplicit() { toggleLevelsVisibility(); triggerHaptic(); }
        async function executeGateOrder() { closeModals(); if(!apiConfig.key || !apiConfig.secret) { return; } showToast("⏳ Enviando Orden a Gate.io..."); const body = { "currency_pair": document.getElementById('trade-pair').textContent, "side": "buy", "amount": document.getElementById('trade-amount').textContent, "price": document.getElementById('trade-price').textContent, "type": "limit", "account": "spot", "time_in_force": "gtc" }; try { const result = await callGateApi("POST", "/spot/orders", body, true); if (result && result.id) { showToast(`✅ ORDEN EXITOSA ID: ${result.id}`, 4000, false, true); setTimeout(fetchWalletBalance, 1500); } else { throw new Error("Respuesta inválida de Gate.io"); } } catch (e) { console.warn("❌ Error creando orden:", e.message); showToast("⚠️ Error en Orden", 2000); } }
        function openLiquidateConfirm() { triggerHaptic(); const s = slots[activeIdx]; if(!s.name || s.price <= 0) return showToast("⚠️ Slot Vacío"); document.getElementById('confirmModal').style.display = 'flex'; }
        
        function executeRelease() { 
            triggerHaptic(); 
            closeModals(); 
            try { 
                const s = slots[activeIdx]; 
                const totalInv = parseFloat(document.getElementById('resInv-' + activeIdx).textContent.replace('$','')) || 0; 
                const avgPrice = parseFloat(document.getElementById('resAvg-' + activeIdx).textContent) || 0; 
                const roiTarget = strategyParams.normal.roi; // Siempre normal
                const targetPrice = avgPrice * (1 + (roiTarget / 100)); 
                const grossExitValue = totalInv * (1 + (roiTarget / 100)); 
                const entryFee = totalInv * (exchangeFee / 100); 
                const exitFee = grossExitValue * (exchangeFee / 100); 
                const totalFees = entryFee + exitFee; 
                const grossProfit = grossExitValue - totalInv; 
                const netProfit = grossProfit - totalFees; 
                const logEntry = { date: new Date().toLocaleDateString(), time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}), coin: s.name || 'S/N', strategy: s.strat.toUpperCase(), basePrice: s.price, avgPrice: avgPrice, exitPrice: targetPrice, qty: (avgPrice > 0 ? totalInv/avgPrice : 0).toFixed(8), totalInv: totalInv.toFixed(2), profit: grossProfit.toFixed(2), netProfit: netProfit.toFixed(2), fees: totalFees.toFixed(2), roi: roiTarget + '%', levelsUsed: s.buys ? s.buys.length : 0, isSimulated: false, simulated: false }; 
                if(!history) history = []; 
                history.push(logEntry); 
                localStorage.setItem('c5x_history', JSON.stringify(history)); 
                renderHistory(); 
                const currentStrat = s.strat || 'normal'; 
                const currentCapital = strategyParams.normal.capital; 
                const currentRoi = strategyParams.normal.roi; 
                slots[activeIdx] = { name:'', price:0, capital: currentCapital, buys:[], strat: currentStrat, locked: true, roi: currentRoi, note: '', alerted: false }; 
                activeOrders = {}; 
                saveActiveOrders(); 
                
                sortSlots();
                
                selectSlot(0);
                
                showToast(`✅ Cerrada. Neta: $${netProfit.toFixed(2)}`); 
                switchView('log', false); 
                calculateGlobalStats(); 
            } catch(e) { showToast("❌ Error al liquidar"); } 
        }
        
        function updateBodyMode(n) { const r = document.querySelector(':root'); if(!n) { r.style.setProperty('--brand', '#3b82f6'); return; } if(n.includes('3S') || n.includes('5S') || n.endsWith('S')) { r.style.setProperty('--brand', 'var(--short)'); } else if (n.includes('3L') || n.includes('5L') || n.endsWith('L')) { r.style.setProperty('--brand', 'var(--long)'); } else { r.style.setProperty('--brand', '#3b82f6'); } }
        function renderHistory() { const grid = document.getElementById('logGrid'); if(!history || history.length === 0) { grid.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-secondary)">Sin registros</div>'; return; } grid.innerHTML = history.map(h => { const hasNet = h.netProfit !== undefined; const finalProfit = hasNet ? parseFloat(h.netProfit) : parseFloat(h.profit); const isWin = finalProfit >= 0; const nameColor = getCoinColor(h.coin); return `<div class="unified-card"><div class="u-index" style="color:var(--brand); border-color:var(--brand)">${h.coin.substring(0,3)}</div><div class="u-center"><div class="u-title" style="color:${nameColor}">${h.coin}</div><div class="u-sub">${h.date} - ${h.time}</div></div><div class="u-right"><div class="u-val-primary" style="color:${isWin?'var(--long)':'var(--short)'}">${isWin?'+':''}$${finalProfit.toFixed(2)}</div><div class="u-val-secondary">${hasNet ? 'NETO' : 'BRUTO'} ${h.roi}</div></div></div>`; }).reverse().join(''); }
        function triggerDriveBackup() { const dataStr = JSON.stringify({ slots, history, tickerAssets, customMultipliers, etfFavorites, globalCapital, appConfig }); const blob = new Blob([dataStr], {type: "application/json"}); const a = document.createElement('a'); const date = new Date().toISOString().slice(0,10); a.href = URL.createObjectURL(blob); a.download = "C5X_Backup.json"; document.body.appendChild(a); a.click(); localStorage.setItem('c5x_last_backup', Date.now()); showToast("☁️ Archivo generado para Drive"); }
        function checkAutoBackup() { const last = localStorage.getItem('c5x_last_backup'); const now = Date.now(); if(!last || (now - last > 2592000000)) { if(confirm("⚠️ Han pasado 30 días desde tu último respaldo. ¿Guardar en Drive ahora?")) { triggerDriveBackup(); } } }
        function openSecurity(cb) { secCallback = cb; document.getElementById('secInput').value = ''; document.getElementById('securityModal').style.display = 'flex'; }
        function closeModals() { document.querySelectorAll('.generic-modal').forEach(m => m.style.display = 'none'); }
        function clearAllActiveOrders() { if (confirm("¿Limpiar TODAS las órdenes activas?")) { activeOrders = {}; saveActiveOrders(); updateLevelsUI(); renderLevels(); showToast("✅ Órdenes limpiadas"); } }
        function save() { 
            // Guardar TODOS los slots de forma agresiva en localStorage
            try {
                localStorage.setItem('c5x_slots', JSON.stringify(slots));
                localStorage.setItem('c5x_slots_real', JSON.stringify(slots)); 
                localStorage.setItem('c5x_last_slot', activeIdx);
                
                // Guardar cada componente individual
                saveInvestmentValue();
                saveSlotsLevels();
                
                // Guardar backup adicional de buys y multipleBuys
                const buysBackup = {};
                const multipleBuysBackup = {};
                slots.forEach((s, idx) => {
                    if (s.buys && s.buys.length > 0) {
                        buysBackup[idx] = s.buys;
                    }
                    if (s.multipleBuys && Object.keys(s.multipleBuys).length > 0) {
                        multipleBuysBackup[idx] = s.multipleBuys;
                    }
                });
                localStorage.setItem('c5x_buys_backup', JSON.stringify(buysBackup));
                localStorage.setItem('c5x_multibuys_backup', JSON.stringify(multipleBuysBackup));
                
                console.log('✅ Guardado completo:', slots.map((s, i) => `Slot ${i+1}: ${s.name || 'vacío'}`));

                // ── Auto-sync a la nube (debounced, silencioso) ──────
                if (fbUser && fbDb) {
                    // Pequeño delay para agrupar cambios rápidos consecutivos
                    if (window._cloudSaveDebounce) clearTimeout(window._cloudSaveDebounce);
                    window._cloudSaveDebounce = setTimeout(() => saveToCloud(false), 5000);
                }
            } catch (e) {
                console.error('❌ Error al guardar:', e);
            }
        }
        
        function saveInvestmentValue() {
            const s = slots[activeIdx];
            if (s && s.capital) {
                const investmentData = { slotIndex: activeIdx, capital: s.capital, timestamp: Date.now() };
                localStorage.setItem('c5x_investment_value', JSON.stringify(investmentData));
            }
        }
        
        function saveSlotsLevels() {
            const slotsData = slots.map((s, idx) => { 
                // Calcular y guardar el promedio actual
                let avgPrice = 0;
                let totalInv = 0;
                let totalQty = 0;
                
                for (let i = 0; i < 12; i++) {
                    const key = getOrderKey(idx, i);
                    if (activeOrders[key] && activeOrders[key].status === 'filled') {
                        totalInv += activeOrders[key].price * activeOrders[key].amount;
                        totalQty += activeOrders[key].amount;
                    } else if (s.buys && s.buys.includes(i)) {
                        const d = getLevelData(s, i);
                        totalInv += d.usd;
                        totalQty += d.qty;
                    }
                    if (s.multipleBuys && s.multipleBuys[i]) {
                        for (let buy of s.multipleBuys[i]) {
                            totalInv += buy.usd;
                            totalQty += buy.qty;
                        }
                    }
                }
                
                avgPrice = totalQty > 0 ? totalInv / totalQty : 0;
                
                return { 
                    index: idx, 
                    name: s.name, 
                    price: s.price, 
                    capital: s.capital, 
                    buys: s.buys || [], 
                    strat: s.strat, 
                    roi: s.roi, 
                    locked: s.locked, 
                    note: s.note || '', 
                    alerted: s.alerted || false,
                    avgPrice: avgPrice,
                    multipleBuys: s.multipleBuys || {}
                }; 
            });
            localStorage.setItem('c5x_slots_levels_data', JSON.stringify(slotsData));
        }
        
        function loadInvestmentValue() {
            const saved = localStorage.getItem('c5x_investment_value');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    const s = slots[data.slotIndex];
                    if (s && data.capital) { s.capital = data.capital; }
                } catch(e) { console.warn("Error cargando valor de inversión:", e); }
            }
        }
        
        function loadSlotsLevels() {
            const saved = localStorage.getItem('c5x_slots_levels_data');
            if (saved) {
                try {
                    const slotsData = JSON.parse(saved);
                    slotsData.forEach(data => {
                        if (data.index >= 0 && data.index < slots.length) {
                            const s = slots[data.index];
                            if (data.buys) s.buys = data.buys;
                            if (data.price) s.price = data.price;
                            if (data.capital) s.capital = data.capital;
                            if (data.strat) s.strat = data.strat;
                            if (data.roi) s.roi = data.roi;
                            if (data.avgPrice) s.avgPrice = data.avgPrice;
                            if (data.multipleBuys) s.multipleBuys = data.multipleBuys;
                        }
                    });
                } catch(e) { console.warn("Error cargando niveles de slots:", e); }
            }
            
            // Cargar backups adicionales de buys y multipleBuys
            try {
                const buysBackup = localStorage.getItem('c5x_buys_backup');
                if (buysBackup) {
                    const buysData = JSON.parse(buysBackup);
                    Object.keys(buysData).forEach(idx => {
                        const index = parseInt(idx);
                        if (index >= 0 && index < slots.length) {
                            slots[index].buys = buysData[idx];
                        }
                    });
                }
                
                const multipleBuysBackup = localStorage.getItem('c5x_multibuys_backup');
                if (multipleBuysBackup) {
                    const multiData = JSON.parse(multipleBuysBackup);
                    Object.keys(multiData).forEach(idx => {
                        const index = parseInt(idx);
                        if (index >= 0 && index < slots.length) {
                            slots[index].multipleBuys = multiData[idx];
                        }
                    });
                }
                
                console.log('✅ Slots cargados:', slots.map((s, i) => `Slot ${i+1}: ${s.name || 'vacío'} - Buys: ${s.buys?.length || 0}, MultiBuys: ${Object.keys(s.multipleBuys || {}).length}`));
            } catch(e) {
                console.warn("Error cargando backups:", e);
            }
        }
        function clearLogs() { openSecurity(() => { history = []; localStorage.setItem('c5x_history', JSON.stringify(history)); renderHistory(); calculateGlobalStats(); showToast("🗑️ Historial Borrado"); }); }
        function resetApp() { openSecurity(() => { localStorage.clear(); location.reload(); }); }
        function loadSettingsValues() { try { const s = slots[activeIdx]; const elCapNormal = document.getElementById('setCapitalNormal'); if(elCapNormal) elCapNormal.value = strategyParams.normal.capital; const elRoiNormal = document.getElementById('setRoiNormal'); if(elRoiNormal) elRoiNormal.value = strategyParams.normal.roi; const elIncNormal = document.getElementById('setIncNormal'); if(elIncNormal) elIncNormal.value = strategyParams.normal.inc; const elDescNormal = document.getElementById('setDescNormal'); if(elDescNormal) elDescNormal.value = strategyParams.normal.desc; const elDDNormal = document.getElementById('setDDNormal'); if(elDDNormal) elDDNormal.value = strategyParams.normal.dd; const elGlobCap = document.getElementById('setGlobalCapital'); if(elGlobCap) elGlobCap.value = globalCapital; const elFee = document.getElementById('setFee'); if(elFee) elFee.value = exchangeFee; const elRadarLim = document.getElementById('setRadarLimit'); if(elRadarLim) elRadarLim.value = radarLimit; const elRadarSpd = document.getElementById('setRadarSpeed'); if(elRadarSpd) elRadarSpd.value = radarSpeed; const elTickSpd = document.getElementById('setTickerSpeed'); if(elTickSpd) elTickSpd.value = tickerSpeed; const elAutoAdj = document.getElementById('setAutoAdjustThreshold'); if(elAutoAdj) elAutoAdj.value = autoAdjustThreshold; const elPass = document.getElementById('setNewPass'); if(elPass) elPass.value = ''; if(apiConfig.key) document.getElementById('apiKey').value = apiConfig.key; if(apiConfig.secret) document.getElementById('apiSecret').value = apiConfig.secret; const grid = document.getElementById('multiGrid'); if(grid) { grid.innerHTML = customMultipliers.map((val, i) => `<div class="multi-item"><span class="multi-lbl">N${i+1}</span><input type="number" class="multi-inp" value="${val}" step="0.1"></div>`).join(''); } calcMonthlyPerformance(); } catch(e) { console.warn("Error cargando ajustes", e); } }
        function calcMonthlyPerformance() { const now = new Date(); const currentMonth = now.getMonth(); const currentYear = now.getFullYear(); let monthlyProfit = 0; history.forEach(h => { const parts = h.date.split('/'); if(parts.length === 3) { const hDate = new Date(parts[2], parts[1]-1, parts[0]); if(hDate.getMonth() === currentMonth && hDate.getFullYear() === currentYear) { monthlyProfit += (h.netProfit !== undefined ? parseFloat(h.netProfit) : (parseFloat(h.profit) || 0)); } } }); let growth = (globalCapital > 0) ? (monthlyProfit / globalCapital) * 100 : 0; const el = document.getElementById('monthlyProfitDisplay'); el.innerHTML = `$${monthlyProfit.toFixed(2)} <span style="font-size:14px; color:${monthlyProfit>=0?'var(--long)':'var(--short)'}">(${growth.toFixed(2)}%)</span>`; }
        function verifyAndAddCoin() { const input = document.getElementById('newTickerCoin'); let val = input.value.trim().toUpperCase().replace('USDT',''); if(!val) return; tickerAssets.push(val); localStorage.setItem('c5x_ticker_assets', JSON.stringify(tickerAssets)); input.value=''; renderTickerSettings(); showToast("✅ Agregada"); }
        function renderTickerSettings() { let html = ''; for(let i=0; i<12; i++) { let coin = tickerAssets[i] || ""; let cls = coin ? "filled" : ""; html += `<div class="multi-item ${cls}"><span class="multi-lbl">SLOT ${i+1}</span><input type="text" class="multi-inp" value="${coin.replace('USDT','')}" placeholder="---" onchange="updateTickerCoin(${i}, this.value)" oninput="forceCaps(this)" style="text-transform: uppercase;"></div>`; } document.getElementById('tickerChipsContainer').innerHTML = html; }
        function updateTickerCoin(index, value) { let val = value.toUpperCase().trim().replace('USDT',''); if (val) { tickerAssets[index] = val; } else { tickerAssets[index] = ""; } localStorage.setItem('c5x_ticker_assets', JSON.stringify(tickerAssets)); showToast("✅ Ticker Actualizado"); }
        function removeTickerCoin(i) { tickerAssets.splice(i,1); localStorage.setItem('c5x_ticker_assets', JSON.stringify(tickerAssets)); renderTickerSettings(); }
        function exportPDF() { if(history.length === 0) return showToast("⚠️ Sin Datos"); const { jsPDF } = window.jspdf; const doc = new jsPDF('l', 'mm', 'a4'); let totalProfit = 0; let totalInvested = 0; let wins = 0; history.forEach(h => { const inv = parseFloat(h.totalInv) || 0; const prof = (h.netProfit !== undefined ? parseFloat(h.netProfit) : parseFloat(h.profit)) || 0; totalInvested += inv; totalProfit += prof; if(prof > 0) wins++; }); const winRate = history.length > 0 ? ((wins / history.length) * 100).toFixed(1) : 0; doc.setFillColor(11, 14, 17); doc.rect(0, 0, 297, 25, 'F'); doc.setFont("helvetica", "bold"); doc.setFontSize(22); doc.setTextColor(59, 130, 246); doc.text("C5X", 14, 16); doc.setFontSize(14); doc.setTextColor(255, 255, 255); doc.text("REPORTE PROFESIONAL", 40, 16); doc.setFillColor(245, 247, 250); doc.rect(14, 30, 270, 20, 'F'); doc.setFontSize(10); doc.setTextColor(80); doc.text("CAPITAL MOVIDO", 20, 38); doc.text("NET PROFIT", 90, 38); doc.text("WIN RATE", 160, 38); doc.text("TOTAL OPS", 230, 38); doc.setFontSize(14); doc.setTextColor(0); doc.text("$" + totalInvested.toFixed(2), 20, 46); doc.setTextColor(totalProfit >= 0 ? 14 : 200, totalProfit >= 0 ? 203 : 50, totalProfit >= 0 ? 129 : 50); doc.text((totalProfit>=0?'+':'') + "$" + totalProfit.toFixed(2), 90, 46); doc.setTextColor(0); doc.text(winRate + "%", 160, 46); doc.text(history.length.toString(), 230, 46); const bodyData = history.map(h => { const inv = parseFloat(h.totalInv) || 0; const prof = (h.netProfit !== undefined ? parseFloat(h.netProfit) : parseFloat(h.profit)) || 0; const avg = parseFloat(h.avgPrice) || 0; const exit = parseFloat(h.exitPrice) || 0; return [ h.date + '\n' + h.time, h.coin, '$' + (avg < 1 ? avg.toFixed(6) : avg.toFixed(2)), '$' + (exit < 1 ? exit.toFixed(6) : exit.toFixed(2)), '$' + inv.toFixed(2), (prof>=0?'+':'') + '$' + prof.toFixed(2), h.roi ]; }); doc.autoTable({ head: [['FECHA / HORA', 'ACTIVO', 'PRECIO ENT.', 'PRECIO SALIDA', 'INVERSIÓN', 'PNL NETO', 'ROI']], body: bodyData, startY: 58, theme: 'grid', styles: { fontSize: 9, cellPadding: 3, valign: 'middle', halign: 'center' }, headStyles: { fillColor: [21, 26, 33], textColor: 255, fontStyle: 'bold', halign: 'center' }, didParseCell: function(data) { if (data.section === 'body' && data.column.index === 5) { const raw = data.cell.raw; if(raw.startsWith('+')) data.cell.styles.textColor = [14, 203, 129]; else data.cell.styles.textColor = [246, 70, 93]; } } }); doc.save("C5X_Pro_Report.pdf"); }
        function exportData() { const dataStr = JSON.stringify({ slots, history, tickerAssets, customMultipliers, etfFavorites, globalCapital, appConfig }); const blob = new Blob([dataStr], {type: "application/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "C5X_Backup.json"; document.body.appendChild(a); a.click(); }
        function importData(input) { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const data = JSON.parse(e.target.result); if(data.slots) slots = data.slots; if(data.history) history = data.history; if(data.customMultipliers) { customMultipliers = data.customMultipliers; localStorage.setItem('c5x_multipliers', JSON.stringify(customMultipliers)); } if(data.etfFavorites) { etfFavorites = data.etfFavorites; localStorage.setItem('c5x_etf_favorites', JSON.stringify(etfFavorites)); } if(data.globalCapital) { globalCapital = data.globalCapital; localStorage.setItem('c5x_global_capital', globalCapital); } if(data.appConfig) { appConfig = data.appConfig; localStorage.setItem('c5x_config', JSON.stringify(appConfig)); } save(); localStorage.setItem('c5x_history', JSON.stringify(history)); location.reload(); } catch(err) { showToast("❌ Error al leer archivo"); } }; reader.readAsText(file); }
        let serverTimeOffset = 0;
        
        // --- ⚠️ URL DEL SERVIDOR (AUTOMÁTICA) ⚠️ ---
        const FIREBASE_PROXY_URL = "https://gateproxy-c6mfcbeatq-uc.a.run.app";
        
        async function callGateApi(method, endpoint, params = {}, requireAuth = false) {
            let url = `${FIREBASE_PROXY_URL}?endpoint=${endpoint}`;
            const headers = { 'Accept': 'application/json', 'Content-Type': 'application/json' };

            if (method === 'GET' && Object.keys(params).length > 0) {
                const queryString = new URLSearchParams(params).toString();
                url += '&' + queryString;
            }

            if (requireAuth) {
                if (!apiConfig.key || !apiConfig.secret) { showToast("❌ Configura API Keys"); return null; }
                const timestamp = Math.floor((Date.now() + serverTimeOffset) / 1000);
                const bodyPayload = method === 'POST' ? JSON.stringify(params) : '';
                const hashedPayload = CryptoJS.SHA512(bodyPayload || '').toString();
                let queryForSign = '';
                if (method === 'GET' && Object.keys(params).length > 0) { 
                    queryForSign = new URLSearchParams(params).toString(); 
                }
                const signString = `${method}\n${endpoint}\n${queryForSign}\n${hashedPayload}\n${timestamp}`;
                const signature = CryptoJS.HmacSHA512(signString, apiConfig.secret).toString();
                
                headers['KEY'] = apiConfig.key; 
                headers['Timestamp'] = timestamp.toString(); 
                headers['SIGN'] = signature;
            }

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: headers,
                    body: method === 'POST' ? JSON.stringify(params) : undefined
                });
                
                if (!response.ok) {
                    const errText = await response.text();
                    throw new Error(errText || response.statusText);
                }
                return await response.json();
            } catch (err) {
                console.warn(`Error Proxy: ${err.message}`);
                return null;
            }
        }
        async function syncTimeAndBalance() { try { const start = Date.now(); const res = await callGateApi("GET", "/spot/time"); if(res && res.server_time) { const serverTime = res.server_time * 1000; serverTimeOffset = serverTime - (start + ((Date.now() - start) / 2)); console.log("✅ Hora sincronizada con Gate.io"); } } catch(e) { console.warn("⚠️ Time sync fail (usando local)", e); } fetchWalletBalance(); }
        async function testApiConnection() { const resultDiv = document.getElementById('apiTestResult'); resultDiv.innerHTML = '⏳ Probando conexión...<br>'; resultDiv.innerHTML += '<br>📡 TEST 1: Endpoint Público (/spot/time)<br>'; try { const timeRes = await callGateApi("GET", "/spot/time"); if (timeRes && timeRes.server_time) { resultDiv.innerHTML += `✅ OK - Hora servidor: ${new Date(timeRes.server_time * 1000).toLocaleTimeString()}<br>`; } else { resultDiv.innerHTML += `❌ FAIL - No data<br>`; } } catch(e) { resultDiv.innerHTML += `❌ ERROR: ${e.message}<br>`; } resultDiv.innerHTML += '<br>📊 TEST 2: Tickers Públicos<br>'; try { const tickersRes = await callGateApi("GET", "/spot/tickers"); if (tickersRes && Array.isArray(tickersRes)) { resultDiv.innerHTML += `✅ OK - ${tickersRes.length} pares encontrados<br>`; } else { resultDiv.innerHTML += `❌ FAIL - Respuesta inválida<br>`; } } catch(e) { resultDiv.innerHTML += `❌ ERROR: ${e.message}<br>`; } if (apiConfig.key && apiConfig.secret) { resultDiv.innerHTML += '<br>🔐 TEST 3: Balance (Autenticado)<br>'; try { const balanceRes = await callGateApi("GET", "/spot/accounts", {currency: "USDT"}, true); if (balanceRes && Array.isArray(balanceRes) && balanceRes.length > 0) { resultDiv.innerHTML += `✅ OK - Balance: $${parseFloat(balanceRes[0].available).toFixed(2)}<br>`; } else { resultDiv.innerHTML += `❌ FAIL - Sin balance o respuesta inválida<br>`; } } catch(e) { resultDiv.innerHTML += `❌ ERROR: ${e.message}<br>`; } } else { resultDiv.innerHTML += '<br>⚠️ TEST 3: OMITIDO - No hay API Keys<br>'; } resultDiv.innerHTML += '<br>✅ Diagnóstico completo'; resultDiv.scrollTop = resultDiv.scrollHeight; }
        function clearCrashMemory() { localStorage.removeItem('c5x_crash_alerts'); showToast("✅ Memoria de alertas borrada"); }
        let gateCheckInterval = null; let gateConnected = false;
        async function checkGateConnectionStatus() { try { const res = await callGateApi("GET", "/spot/time"); updateGateIndicator(res && res.server_time); } catch(e) { updateGateIndicator(false); } }
        function updateGateIndicator(isConnected) { gateConnected = isConnected; const modeBtn = document.getElementById('modeToggleBtn'); if (modeBtn && modeBtn.classList.contains('real')) { if (isConnected) { modeBtn.classList.remove('disconnected'); } else { modeBtn.classList.add('disconnected'); } } }
        function startGateMonitoring() { checkGateConnectionStatus(); if (gateCheckInterval) clearInterval(gateCheckInterval); gateCheckInterval = setInterval(checkGateConnectionStatus, 15000); }
        
        // ════════════════════════════════════════════════════════
        //  GATE.IO COMMAND DASHBOARD — PANEL 3
        // ════════════════════════════════════════════════════════
        const GD_ASSETS = [
            { sym: 'BTC',  name: 'Bitcoin',  pair: 'BTC_USDT'  },
            { sym: 'ETH',  name: 'Ethereum', pair: 'ETH_USDT'  },
            { sym: 'SUI',  name: 'Sui',      pair: 'SUI_USDT'  },
            { sym: 'AVAX', name: 'Avalanche',pair: 'AVAX_USDT' },
            { sym: 'BNB',  name: 'BNB',      pair: 'BNB_USDT'  },
        ];
        let gdTickerIdx   = 0;
        let gdTickerTimer = null;
        let gdProgressTimer = null;
        let gdMarketData  = {};          // { BTC: { price, change }, ... }
        let gdRefreshInterval = null;
        const GD_TICKER_SECS = 10;      // segundos por asset

        // ── Punto de entrada: se llama al activar panel 2 ──
        async function initGateDashboard() {
            renderGdDualBar();
            calcGdStats();
            await refreshGateDashboard();
            if (!gdRefreshInterval) {
                gdRefreshInterval = setInterval(refreshGateDashboard, 30000);
            }
            // Inicializar progress bar visual (se resetea en cada masterTick)
            startGdProgressBar();
        }

        async function refreshGateDashboard() {
            // 1. Verificar conexión (endpoint público)
            try {
                const timeRes = await callGateApi('GET', '/spot/time');
                const isConn  = !!(timeRes && timeRes.server_time);
                setGdConnection(isConn);

                if (isConn) {
                    // 2. Obtener precios del mercado (público)
                    const tickersRaw = await callGateApi('GET', '/spot/tickers');
                    if (Array.isArray(tickersRaw)) {
                        GD_ASSETS.forEach(a => {
                            const row = tickersRaw.find(t => t.currency_pair === a.pair);
                            if (row) {
                                gdMarketData[a.sym] = {
                                    price:  parseFloat(row.last),
                                    change: parseFloat(row.change_percentage)
                                };
                            }
                        });
                        updateGdEquivalencias();
                        updateGdMarketCard();
                    }

                    // 3. Balance (si hay API keys)
                    if (apiConfig.key && apiConfig.secret) {
                        const allAccounts = await callGateApi('GET', '/spot/accounts', {}, true);
                        if (Array.isArray(allAccounts)) {
                            // USDT disponible
                            const usdtRow = allAccounts.find(a => a.currency === 'USDT');
                            const libre   = usdtRow ? parseFloat(usdtRow.available) : 0;

                            // Calcular valor total en USDT de todas las monedas
                            let totalUSD = libre;
                            allAccounts.forEach(acc => {
                                if (acc.currency === 'USDT') { totalUSD += parseFloat(acc.locked) || 0; return; }
                                const qty = parseFloat(acc.available) + parseFloat(acc.locked || 0);
                                if (qty > 0 && gdMarketData[acc.currency]) {
                                    totalUSD += qty * gdMarketData[acc.currency].price;
                                }
                            });

                            updateGdMetrics(totalUSD, libre);
                        }
                    } else {
                        // Sin API keys: usar datos de slots y globalCapital
                        const libre   = availableUSDT || globalCapital;
                        const enUso   = calcGdEnUso();
                        const total   = libre + enUso;
                        updateGdMetrics(total, libre);
                    }
                } else {
                    // Sin conexión: mostrar datos locales
                    const libre = globalCapital;
                    updateGdMetrics(libre, libre);
                }
            } catch(e) {
                setGdConnection(false);
            }

            // Timestamp de última actualización
            const now = new Date();
            const ts  = now.toLocaleTimeString('es', { hour12: false });
            const el  = document.getElementById('gdUpdateTime');
            if (el) el.textContent = ts;

            calcGdStats();
            renderGdDualBar();
        }

        function setGdConnection(isConn) {
            const dot   = document.getElementById('gdConnDot');
            const label = document.getElementById('gdConnLabel');
            if (!dot || !label) return;
            if (isConn) {
                dot.classList.add('connected');
                label.textContent = 'CONECTADO';
                label.classList.add('connected');
            } else {
                dot.classList.remove('connected');
                label.textContent = apiConfig.key ? 'SIN SEÑAL' : 'SIN API KEY';
                label.classList.remove('connected');
            }
        }

        function calcGdEnUso() {
            let enUso = 0;
            slots.forEach(s => {
                if (!s.name) return;
                const params = getStrategyParams ? getStrategyParams(s.strat) : { capital: s.capital || 5 };
                s.buys && s.buys.forEach(lvl => {
                    const data = getLevelData ? getLevelData(s, lvl) : { usd: params.capital };
                    enUso += data.usd || 0;
                });
                if (s.multipleBuys) {
                    Object.values(s.multipleBuys).forEach(arr => {
                        if (Array.isArray(arr)) arr.forEach(b => { enUso += b.usd || 0; });
                    });
                }
            });
            return enUso;
        }

        function updateGdMetrics(total, libre) {
            const enUso    = Math.max(0, total - libre);
            const librePct = total > 0 ? ((libre / total) * 100).toFixed(0) : 0;
            const btcPrice = gdMarketData.BTC ? gdMarketData.BTC.price : 0;

            const fmtUSD = v => '$' + v.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            const activeSlots = slots.filter(s => s.name).length;

            setGdEl('gdTotal',  fmtUSD(total));
            setGdEl('gdLibre',  fmtUSD(libre));
            setGdEl('gdEnUso',  fmtUSD(enUso));
            setGdEl('gdLibrePct',  librePct + '% disponible');
            setGdEl('gdSlotCount', activeSlots + (activeSlots === 1 ? ' slot activo' : ' slots activos'));
            setGdEl('gdTotalBTC',  btcPrice > 0 ? '≈ ' + (total / btcPrice).toFixed(6) + ' BTC' : '—');

            // Guardar libre para equivalencias
            updateGdEquivalencias(total);
        }

        function updateGdEquivalencias(usdAmount) {
            // Los datos ya están en gdMarketData; renderGdDualBar los consume.
            // Aquí solo actualizamos el sub-texto del TOTAL en BTC.
            const btcPrice = gdMarketData.BTC ? gdMarketData.BTC.price : 0;
            if (usdAmount !== undefined && btcPrice > 0) {
                setGdEl('gdTotalBTC', '≈ ' + (usdAmount / btcPrice).toFixed(6) + ' BTC');
            }
            // Refrescar barra dual con datos actualizados
            renderGdDualBar();
        }

        function calcGdStats() {
            const today   = new Date().toLocaleDateString();
            let pnlHoy    = 0, pnlTotal = 0, wins = 0;
            history.forEach(h => {
                const p = (h.netProfit !== undefined ? parseFloat(h.netProfit) : parseFloat(h.profit)) || 0;
                pnlTotal += p;
                if (p > 0) wins++;
                const dateParts = (h.date || '').split('/');
                const hDate = dateParts.length === 3
                    ? new Date(dateParts[2], dateParts[1]-1, dateParts[0]).toLocaleDateString()
                    : '';
                if (hDate === today) pnlHoy += p;
            });
            const fmtPnl = v => (v >= 0 ? '+$' : '-$') + Math.abs(v).toFixed(2);
            const col    = v => v >= 0 ? 'var(--long)' : 'var(--short)';
            const elHoy  = document.getElementById('gdPnlHoy');
            const elTot  = document.getElementById('gdPnlTotal');
            if (elHoy) { elHoy.textContent = fmtPnl(pnlHoy);   elHoy.style.color = col(pnlHoy); }
            if (elTot) { elTot.textContent = fmtPnl(pnlTotal);  elTot.style.color = col(pnlTotal); }
        }

        // ── BARRA DUAL: PORTFOLIO (izq) y EQUIVALENCIAS EN USDT (der) ──
        let gdDualPortfolioIdx = 0;
        let gdDualEqIdx        = 0;
        let gdDualTimer        = null;
        const GD_DUAL_SECS     = 4;   // segundos por slide

        // Datos de equivalencias (price del asset en USDT, el usuario ve cuántos de ese
        // asset puede comprar con su capital en USDT)
        const GD_EQ_ASSETS = [
            { sym: 'BTC',  label: 'Bitcoin',   decimals: 6 },
            { sym: 'ETH',  label: 'Ethereum',  decimals: 4 },
            { sym: 'SUI',  label: 'Sui',       decimals: 2 },
            { sym: 'AVAX', label: 'Avalanche', decimals: 2 },
            { sym: 'BNB',  label: 'BNB',       decimals: 3 },
            { sym: 'SOL',  label: 'Solana',    decimals: 2 },
        ];

        function buildGdPortfolioSlides() {
            const slides = [];
            for (let i = 0; i < 5; i++) {
                const s = slots[i] || {};
                if (!s.name) { slides.push({ empty: true, idx: i }); continue; }
                let invested = 0;
                (s.buys || []).forEach(lvl => {
                    try { invested += (getLevelData(s, lvl) || {}).usd || 0; } catch(e) {}
                });
                if (s.multipleBuys) {
                    Object.values(s.multipleBuys).forEach(arr => {
                        if (Array.isArray(arr)) arr.forEach(b => { invested += b.usd || 0; });
                    });
                }
                const coinColor   = getCoinColor ? getCoinColor(s.name) : 'var(--brand)';
                const basePrice   = s.price > 0 ? (s.price < 1 ? s.price.toFixed(6) : s.price.toFixed(4)) : '—';
                const fmtInv      = '$' + (invested > 0 ? invested.toFixed(2) : '0.00');
                const boughtCount = (s.buys || []).length;
                slides.push({ empty: false, idx: i, name: s.name, coinColor, basePrice, fmtInv, boughtCount });
            }
            return slides;
        }

        function renderGdDualBar() {
            const portSlides = buildGdPortfolioSlides();
            if (gdDualPortfolioIdx >= portSlides.length) gdDualPortfolioIdx = 0;

            renderGdTrack('gdPortfolioTrack', 'gdPortfolioDots', portSlides.map(s => {
                if (s.empty) {
                    return `<div class="gd-dual-slide">
                        <div class="gd-slide-left">
                            <span class="gd-slide-coin" style="color:var(--text-tertiary);font-size:13px;">SLOT ${s.idx+1}</span>
                            <span class="gd-slide-detail">vacío</span>
                        </div>
                        <div class="gd-slide-right">
                            <span class="gd-slide-inv" style="color:var(--text-tertiary)">—</span>
                        </div>
                    </div>`;
                }
                return `<div class="gd-dual-slide" style="cursor:pointer;" onclick="activateDashSlot(${s.idx}); switchPanel(1);">
                    <div class="gd-slide-left">
                        <span class="gd-slide-coin" style="color:${s.coinColor}">${s.name}</span>
                        <span class="gd-slide-detail">BASE $${s.basePrice} · ${s.boughtCount} niv.</span>
                    </div>
                    <div class="gd-slide-right">
                        <span class="gd-slide-inv">${s.fmtInv}</span>
                        <span class="gd-slide-levels">USDT invertido</span>
                    </div>
                </div>`;
            }), gdDualPortfolioIdx);
        }

        function renderGdTrack(trackId, dotsId, slidesHtml, activeIdx) {
            const track  = document.getElementById(trackId);
            const dotsEl = document.getElementById(dotsId);
            if (!track || !dotsEl) return;
            track.innerHTML = slidesHtml.join('');
            track.style.transform = `translateX(-${activeIdx * 100}%)`;
            dotsEl.innerHTML = slidesHtml.map((_, i) =>
                `<div class="gd-ddot${i === activeIdx ? ' active' : ''}"></div>`
            ).join('');
        }

        function tickGdDual() {
            const portSlides = buildGdPortfolioSlides();
            gdDualPortfolioIdx = (gdDualPortfolioIdx + 1) % portSlides.length;
            renderGdDualBar();
        }

        function startGdDualRotation() { renderGdDualBar(); } // driven by masterClock
        function stopGdDualRotation()  { if (gdDualTimer) { clearInterval(gdDualTimer); gdDualTimer = null; } }
        function startGdTicker()       { updateGdMarketCard(); } // driven by masterClock
        function stopGdTicker()        { if (gdProgressTimer) { clearInterval(gdProgressTimer); gdProgressTimer = null; } }

        // Barra de progreso visual: cuenta 10s y se resetea en cada masterTick
        function startGdProgressBar() {
            if (gdProgressTimer) clearInterval(gdProgressTimer);
            gdProgressMs = 0;
            gdProgressTimer = setInterval(() => {
                gdProgressMs = Math.min(gdProgressMs + 100, MASTER_SECS * 1000);
                const pct = (gdProgressMs / (MASTER_SECS * 1000)) * 100;
                const bar = document.getElementById('gdMcProgress');
                if (bar) bar.style.width = pct + '%';
            }, 100);
        }

        function updateGdMarketCard() {
            const asset = GD_ASSETS[gdTickerIdx];
            const data  = gdMarketData[asset.sym] || { price: 0, change: 0 };
            const isUp  = data.change >= 0;
            const fmtP  = p => p < 1 ? '$' + p.toFixed(6) : '$' + p.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            setGdEl('gdMcSym',   asset.sym);
            setGdEl('gdMcPrice', data.price > 0 ? fmtP(data.price) : '—');
            const chEl = document.getElementById('gdMcChange');
            if (chEl) {
                chEl.textContent = (isUp ? '+' : '') + data.change.toFixed(2) + '%';
                chEl.className   = 'gd-mc-change ' + (isUp ? 'up' : 'down');
            }
        }

        // Utilidad simple
        function setGdEl(id, val) {
            const el = document.getElementById(id);
            if (el) el.textContent = val;
        }

        // gdJumpToNext: al tocar la card de mercado, salta al siguiente asset manualmente
        function gdJumpToNext() {
            gdTickerIdx = (gdTickerIdx + 1) % GD_ASSETS.length;
            updateGdMarketCard();
            // Reiniciar barra de progreso
            gdProgressMs = 0;
            const bar = document.getElementById('gdMcProgress');
            if (bar) bar.style.width = '0%';
        }
        let gdProgressMs = 0;

        // ════════════════════════════════════════════════════════
        //  MASTER ROTATION CLOCK — todo rota cada 10 segundos
        // ════════════════════════════════════════════════════════
        const MASTER_SECS = 10;
        let masterClockId = null;

        function startMasterClock() {
            if (masterClockId) clearInterval(masterClockId);
            masterClockId = setInterval(masterTick, MASTER_SECS * 1000);
        }

        function masterTick() {
            // 1. Ticker del header (si no está fijado)
            if (!isTickerPinned && !isHeaderPinnedByScroll) {
                assetIdx = (assetIdx + 1) % tickerAssets.length;
                localStorage.setItem('c5x_ticker_index', assetIdx);
                updateTicker();
            }

            // 2. Radar
            tickRadar();

            // 3. Mercado Live del dashboard
            gdTickerIdx = (gdTickerIdx + 1) % GD_ASSETS.length;
            updateGdMarketCard();

            // 4. Portafolio C5X
            tickGdDual();

            // 5. Resetear barra de progreso del mercado
            gdProgressMs = 0;
            const bar = document.getElementById('gdMcProgress');
            if (bar) bar.style.width = '0%';
        }
        // ════════════════════════════════════════════════════════
        document.addEventListener('DOMContentLoaded', function() {
            updateETFFloatButtonVisibility();
            updateHeaderForPanel(0); // Inicializar header para panel 1
            // Asegurar que el panel inicial esté correctamente posicionado
            const container = document.getElementById('panelsContainer');
            if (container) {
                container.setAttribute('data-active', '0');
            }
            switchPanel(0); // Inicializar panel 0 como activo
        });
    </script>
</body>
</html>