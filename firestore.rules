rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ── DATOS DE USUARIO ──────────────────────────────────────────────
    // Cada usuario solo puede leer/escribir sus propios datos.
    // El Super Admin puede leer datos de cualquier usuario.
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      // Super Admin: puede leer todo (útil para soporte)
      // Descomenta y pon tu UID si quieres acceso admin:
      // allow read: if request.auth != null && request.auth.uid == 'TU_UID_ADMIN_AQUI';
    }

    // ── CHAT DE SOPORTE ───────────────────────────────────────────────
    // Cada usuario lee/escribe sus propios mensajes.
    // El Super Admin puede leer/escribir en cualquier conversación.
    match /consultas_privadas/{userId}/mensajes/{msgId} {
      // Propietario del chat
      allow read, write: if request.auth != null && request.auth.uid == userId;
      // El sistema (escritura desde el propio usuario en su thread)
      allow create: if request.auth != null && request.auth.uid == userId
                    && request.resource.data.autor_uid == request.auth.uid;
    }

    // Documento raíz del chat (no mensajes)
    match /consultas_privadas/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
